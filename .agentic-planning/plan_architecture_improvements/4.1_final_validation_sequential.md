# 4.1 Финальная валидация (sequential)

**Execution type:** sequential (выполнять после всех изменений)
**Priority:** Обязательно перед релизом v2.0.0

---

## Цель

Убедиться, что все изменения интегрированы корректно и проект готов к релизу v2.0.0.

---

## Чек-лист валидации

### 1. Сборка и типизация

```bash
# Полная очистка
npm run clean:all
npm install

# Сборка всех пакетов
npm run build

# Проверка типизации
npm run typecheck
```

**Критерии успеха:**
- ✅ Все пакеты собираются без ошибок
- ✅ Нет ошибок типизации
- ✅ Время сборки не увеличилось значительно (±10%)

### 2. Качество кода

```bash
# Линтинг
npm run lint

# Проверка дублирования
npm run cpd

# Проверка зависимостей
npm run depcruise

# Проверка unused exports
npm run knip
```

**Критерии успеха:**
- ✅ Нет новых lint ошибок
- ✅ Дублирование ≤5%
- ✅ Нет циклических зависимостей
- ✅ Нет критических unused exports

### 3. Тестирование

```bash
# Все тесты
npm run test

# Покрытие
npm run test:coverage

# Smoke тесты yandex-tracker
cd packages/servers/yandex-tracker
npm run test:smoke
```

**Критерии успеха:**
- ✅ Все тесты проходят
- ✅ Покрытие: lines ≥90%, branches ≥85%
- ✅ Smoke тесты проходят

### 4. Полная валидация

```bash
# В корне monorepo
npm run validate

# В quiet режиме (для проверки CI)
npm run validate:quiet
```

**Критерии успеха:**
- ✅ Validate проходит без ошибок
- ✅ Validate:quiet проходит (для CI/CD)

---

## Проверка изменений P0

### 2.1: Deprecated config удалён

```bash
# Проверить, что config.ts удалён из infrastructure
ls packages/framework/infrastructure/src/config.ts
# Должно быть: No such file or directory

# Проверить exports
rg "loadConfig|ServerConfig" packages/framework/infrastructure/src/index.ts
# Не должно быть результатов

# Проверить импорты в yandex-tracker
rg "from '@mcp-framework/infrastructure'" packages/servers/yandex-tracker --type ts | grep -i config
# Не должно быть результатов
```

**Критерии успеха:**
- ✅ config.ts удалён из infrastructure
- ✅ Нет экспортов config из infrastructure
- ✅ yandex-tracker не импортирует config из infrastructure

### 2.2: CacheManager async

```bash
# Проверить интерфейс
cat packages/framework/infrastructure/src/cache/cache-manager.interface.ts | grep "Promise"
# Должны быть Promise<T | null>, Promise<void>

# Проверить все вызовы с await
rg "cacheManager\.(get|set|delete)" --type ts | rg -v "await"
# Не должно быть результатов (все с await)
```

**Критерии успеха:**
- ✅ CacheManager интерфейс async
- ✅ Все вызовы используют await
- ✅ InMemoryCacheManager создан и работает

---

## Проверка изменений P1

### 3.1: Retry конфигурация

```bash
# Проверить ServerConfig
rg "retryAttempts|retryMinDelay|retryMaxDelay" packages/servers/yandex-tracker/src/config.ts

# Проверить использование в container
rg "config\.retry" packages/servers/yandex-tracker/src/composition-root/container.ts

# Запустить с кастомными значениями
YANDEX_TRACKER_RETRY_ATTEMPTS=5 npm start
# Проверить логи: "HTTP retry configuration loaded" { attempts: 5, ... }
```

**Критерии успеха:**
- ✅ ServerConfig содержит retry поля
- ✅ DI container использует config.retry*
- ✅ Логирование работает
- ✅ Переменные окружения читаются корректно

### 3.2: DI защита от коллизий

```bash
# Проверить namespace в символах
rg "Symbol\.for.*tool:|operation:" packages/servers/yandex-tracker/src/composition-root/types.ts

# Проверить валидацию
rg "validateDIRegistrations|validateUniqueClassNames" packages/servers/yandex-tracker/src/composition-root

# Запустить с дубликатом (негативный тест)
# (временно добавить дубликат в tool-definitions.ts)
# npm start
# Должна быть ошибка: "Duplicate Tool class names detected"
```

**Критерии успеха:**
- ✅ Символы с namespace префиксами
- ✅ Валидация вызывается при старте
- ✅ Логирование символов работает
- ✅ Негативный тест ловит дубликаты

---

## Проверка документации

### MIGRATION.md

```bash
# Проверить наличие секций для v2.0.0
rg "v1.x → v2.0.0|BREAKING" MIGRATION.md
```

**Ожидается:**
- Секция про удаление config из infrastructure
- Секция про async CacheManager
- Примеры миграции

### README файлы

```bash
# infrastructure README не упоминает config
rg "ServerConfig|loadConfig" packages/framework/infrastructure/README.md
# Не должно быть результатов

# yandex-tracker README содержит retry конфигурацию
rg "RETRY_ATTEMPTS|retry configuration" packages/servers/yandex-tracker/README.md
```

**Критерии успеха:**
- ✅ infrastructure README обновлён
- ✅ yandex-tracker README содержит retry примеры
- ✅ composition-root README содержит DI protection примеры

---

## Проверка производительности

### Cold start time

```bash
# Замерить время запуска
time npm start
# Сравнить с baseline (не должно быть увеличения >20%)
```

### Размер бандла

```bash
# Проверить размер dist
du -sh packages/*/dist
# Сравнить с baseline
```

**Критерии успеха:**
- ✅ Cold start время не увеличилось значительно
- ✅ Размер бандла не вырос >10%

---

## Подготовка к релизу

### 1. Обновить CHANGELOG.md

Создать секцию для v2.0.0:

```markdown
# Changelog

## [2.0.0] - YYYY-MM-DD

### BREAKING CHANGES

#### Infrastructure: Removed domain-specific configuration
- **Removed:** `ServerConfig`, `loadConfig` from `@mcp-framework/infrastructure`
- **Migration:** Use `@mcp-server/yandex-tracker/config` instead
- **Reason:** Infrastructure layer must be domain-agnostic

#### CacheManager: Async interface
- **Changed:** All CacheManager methods now return `Promise`
- **Migration:** Add `await` to all cache method calls
- **Added:** `InMemoryCacheManager` with async interface
- **Reason:** Support for external caches (Redis, Memcached)

### Features

#### Configurable retry parameters
- **Added:** `YANDEX_TRACKER_RETRY_ATTEMPTS` environment variable
- **Added:** `YANDEX_TRACKER_RETRY_MIN_DELAY` environment variable
- **Added:** `YANDEX_TRACKER_RETRY_MAX_DELAY` environment variable

#### DI collision protection
- **Added:** Namespace prefixes for DI symbols (`tool:`, `operation:`)
- **Added:** Runtime validation of unique class names
- **Added:** Startup logging of registered DI symbols

### Bug Fixes

- Fixed: CacheManager interface now matches documentation
```

### 2. Обновить версии пакетов

```bash
# В корне monorepo
npm version major --workspaces
```

### 3. Git тэг

```bash
git tag -a v2.0.0 -m "Release v2.0.0: Breaking changes for clean architecture"
```

---

## Критерий готовности (Definition of Done)

- ✅ Все тесты проходят
- ✅ `npm run validate` проходит
- ✅ Проверки P0 изменений прошли
- ✅ Проверки P1 изменений прошли
- ✅ Документация обновлена (MIGRATION.md, README.md)
- ✅ CHANGELOG.md создан
- ✅ Производительность не деградировала
- ✅ Версии пакетов обновлены
- ✅ Git тэг создан
- ✅ Готово к релизу v2.0.0

---

## Rollback план (если что-то пошло не так)

```bash
# Откат всех изменений
git reset --hard <commit-before-changes>

# Или откат конкретного этапа
git revert <commit-hash>

# Пересборка
npm run clean:all
npm install
npm run build
npm run validate
```
