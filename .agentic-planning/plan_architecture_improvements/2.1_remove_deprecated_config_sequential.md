# 2.1 Удаление deprecated config из infrastructure (P0, sequential)

**Execution type:** sequential (breaking change для v2.0.0)
**Priority:** P0 (критичный)

---

## Проблема

`packages/framework/infrastructure/src/config.ts` содержит доменно-специфический код Yandex Tracker, что нарушает принцип "infrastructure должна быть domain-agnostic".

**Текущее состояние:**
- Файл помечен `@deprecated` с v1.x
- Всё ещё экспортируется из `@mcp-framework/infrastructure`
- Создаёт две точки правды для ServerConfig
- Нарушает boundaries между пакетами

---

## Цель

Полностью удалить deprecated config из infrastructure и оставить единственный источник в yandex-tracker.

---

## Шаги выполнения

### Шаг 1: Проверка зависимостей

```bash
# Найти все импорты из infrastructure/config
rg "from '@mcp-framework/infrastructure'" packages/ --type ts | grep -E "(ServerConfig|loadConfig|LogLevel|ParsedCategoryFilter)"
```

**Ожидается:**
- Все импорты должны быть только в yandex-tracker пакете
- Если есть импорты из других пакетов → сначала их исправить

### Шаг 2: Удалить файлы infrastructure

```bash
# Удалить файл config.ts
rm packages/framework/infrastructure/src/config.ts

# Удалить типы (если они только для config)
# Проверить packages/framework/infrastructure/src/types.ts
# Удалить ServerConfig, LogLevel, ParsedCategoryFilter если они там
```

### Шаг 3: Обновить экспорты infrastructure

Отредактировать `packages/framework/infrastructure/src/index.ts`:

```typescript
// УДАЛИТЬ эти строки:
export type { ServerConfig, LogLevel, ParsedCategoryFilter } from './types.js';
export { loadConfig } from './config.js';

// Также удалить из types.ts если там есть
```

### Шаг 4: Обновить constants.ts

Проверить `packages/framework/infrastructure/src/constants.ts`:
- Если есть доменно-специфические константы (ENV_VAR_NAMES, DEFAULT_API_BASE и т.д.) → удалить
- Оставить только универсальные константы (если есть)

### Шаг 5: Пересобрать infrastructure

```bash
cd packages/framework/infrastructure
npm run clean
npm run build
npm run typecheck
```

**Ожидается:**
- Сборка успешна
- Нет ошибок типизации
- exports корректны

### Шаг 6: Проверить yandex-tracker

```bash
cd packages/servers/yandex-tracker

# Убедиться, что используется локальный config
rg "from '#config'" src/ --type ts

# Проверить сборку
npm run clean
npm run build
npm run typecheck
```

**Ожидается:**
- yandex-tracker использует только `#config` (локальный импорт)
- Сборка успешна

### Шаг 7: Обновить MIGRATION.md

Добавить в `MIGRATION.md` секцию для v2.0.0:

```markdown
## v1.x → v2.0.0

### BREAKING: Удалён config из @mcp-framework/infrastructure

**До:**
```typescript
import { ServerConfig, loadConfig } from '@mcp-framework/infrastructure';
```

**После:**
```typescript
// Из yandex-tracker пакета:
import { ServerConfig, loadConfig } from '#config';
// или
import { ServerConfig, loadConfig } from '@mcp-server/yandex-tracker/config';
```

**Причина:** Infrastructure слой должен быть domain-agnostic. Конфигурация Yandex Tracker переехала в соответствующий пакет.
```

### Шаг 8: Обновить infrastructure README.md

Удалить из `packages/framework/infrastructure/README.md`:
- Упоминания ServerConfig
- Примеры loadConfig()
- Секцию про Configuration (если есть)

Добавить note:
```markdown
## Migration from v1.x

Configuration (ServerConfig, loadConfig) moved to `@mcp-server/yandex-tracker`.
See [MIGRATION.md](../../MIGRATION.md) for details.
```

---

## Проверка результатов

### Автоматические тесты
```bash
# В корне monorepo
npm run validate

# Убедиться что:
# - Все пакеты собираются
# - Все тесты проходят
# - Нет циклических зависимостей
npm run depcruise
```

### Ручная проверка
```bash
# Проверить, что config нет в infrastructure exports
node -e "console.log(Object.keys(require('./packages/framework/infrastructure/dist/index.js')))"

# Не должно быть: ServerConfig, loadConfig
```

---

## Откат изменений (если нужен)

```bash
git checkout HEAD -- packages/framework/infrastructure/src/config.ts
git checkout HEAD -- packages/framework/infrastructure/src/types.ts
git checkout HEAD -- packages/framework/infrastructure/src/index.ts
npm run build
```

---

## Критерий готовности (Definition of Done)

- ✅ `packages/framework/infrastructure/src/config.ts` удалён
- ✅ Все экспорты config удалены из infrastructure/index.ts
- ✅ Доменно-специфические типы удалены из infrastructure/types.ts
- ✅ `npm run build` успешна для всех пакетов
- ✅ `npm run validate` проходит
- ✅ `npm run depcruise` не показывает нарушений
- ✅ MIGRATION.md обновлён
- ✅ infrastructure/README.md обновлён
- ✅ Коммит создан с описанием breaking change
