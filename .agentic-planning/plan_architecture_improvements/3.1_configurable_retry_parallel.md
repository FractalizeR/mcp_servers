# 3.1 Конфигурируемый retry (P1, parallel)

**Execution type:** parallel (можно выполнять одновременно с 3.2)
**Priority:** P1 (высокий)

---

## Проблема

Параметры retry захардкожены в DI container:

```typescript
// packages/servers/yandex-tracker/src/composition-root/container.ts:63-84
const retryStrategy = new ExponentialBackoffStrategy(
  3,      // maxRetries - hardcoded
  1000,   // minDelay - hardcoded
  10000   // maxDelay - hardcoded
);
```

**Проблема:**
- Невозможно изменить параметры без изменения кода
- При масштабировании или других API нужно менять код и пересобирать
- Нет возможности настроить retry под конкретные окружения

---

## Цель

Сделать параметры retry частью ServerConfig и прокидывать их в ExponentialBackoffStrategy.

---

## Шаги выполнения

### Шаг 1: Расширить ServerConfig

Отредактировать `packages/servers/yandex-tracker/src/config.ts`:

```typescript
export interface ServerConfig {
  // ... существующие поля

  // Retry configuration
  retryAttempts?: number;
  retryMinDelay?: number;
  retryMaxDelay?: number;
}
```

### Шаг 2: Добавить константы

Отредактировать `packages/servers/yandex-tracker/src/constants.ts`:

```typescript
// Retry defaults
export const DEFAULT_RETRY_ATTEMPTS = 3;
export const DEFAULT_RETRY_MIN_DELAY = 1000;
export const DEFAULT_RETRY_MAX_DELAY = 10000;

// Environment variables
export const ENV_VAR_NAMES = {
  // ... существующие
  RETRY_ATTEMPTS: 'YANDEX_TRACKER_RETRY_ATTEMPTS',
  RETRY_MIN_DELAY: 'YANDEX_TRACKER_RETRY_MIN_DELAY',
  RETRY_MAX_DELAY: 'YANDEX_TRACKER_RETRY_MAX_DELAY',
} as const;
```

### Шаг 3: Обновить loadConfig()

Отредактировать функцию `loadConfig()` в `config.ts`:

```typescript
/**
 * Валидация retry attempts
 */
function validateRetryAttempts(value: string | undefined, defaultValue: number): number {
  if (!value) return defaultValue;
  const parsed = parseInt(value, 10);
  if (isNaN(parsed) || parsed < 0 || parsed > 10) {
    return defaultValue;
  }
  return parsed;
}

/**
 * Валидация retry delay
 */
function validateRetryDelay(
  value: string | undefined,
  defaultValue: number,
  min: number,
  max: number
): number {
  if (!value) return defaultValue;
  const parsed = parseInt(value, 10);
  if (isNaN(parsed) || parsed < min || parsed > max) {
    return defaultValue;
  }
  return parsed;
}

export function loadConfig(): ServerConfig {
  // ... существующий код

  const retryAttempts = validateRetryAttempts(
    process.env[ENV_VAR_NAMES.RETRY_ATTEMPTS],
    DEFAULT_RETRY_ATTEMPTS
  );

  const retryMinDelay = validateRetryDelay(
    process.env[ENV_VAR_NAMES.RETRY_MIN_DELAY],
    DEFAULT_RETRY_MIN_DELAY,
    100,
    5000
  );

  const retryMaxDelay = validateRetryDelay(
    process.env[ENV_VAR_NAMES.RETRY_MAX_DELAY],
    DEFAULT_RETRY_MAX_DELAY,
    1000,
    60000
  );

  return {
    // ... существующие поля
    retryAttempts,
    retryMinDelay,
    retryMaxDelay,
  };
}
```

### Шаг 4: Обновить DI container

Отредактировать `packages/servers/yandex-tracker/src/composition-root/container.ts`:

```typescript
function bindHttpClient(container: Container, config: ServerConfig): void {
  const loggerInstance = container.get<Logger>(TYPES.Logger);

  // Используем значения из config
  const retryStrategy = new ExponentialBackoffStrategy(
    config.retryAttempts ?? 3,
    config.retryMinDelay ?? 1000,
    config.retryMaxDelay ?? 10000
  );

  const retryHandler = new RetryHandler(retryStrategy, loggerInstance);

  const httpClient = new AxiosHttpClient(
    {
      baseURL: config.apiBase,
      timeout: config.requestTimeout,
      headers: {
        'Authorization': `OAuth ${config.token}`,
        ...(config.orgId && { 'X-Org-ID': config.orgId }),
        ...(config.cloudOrgId && { 'X-Cloud-Org-ID': config.cloudOrgId }),
      },
    },
    retryHandler,
    loggerInstance
  );

  // Логируем конфигурацию retry при старте
  loggerInstance.info({
    retryConfig: {
      attempts: config.retryAttempts,
      minDelay: config.retryMinDelay,
      maxDelay: config.retryMaxDelay,
    },
  }, 'HTTP retry configuration loaded');

  container.bind<IHttpClient>(TYPES.HttpClient).toConstantValue(httpClient);
}
```

### Шаг 5: Обновить README.md

Добавить в `packages/servers/yandex-tracker/README.md`:

```markdown
### Retry Configuration

Configure automatic retry behavior for failed HTTP requests:

```bash
# Number of retry attempts (0-10, default: 3)
YANDEX_TRACKER_RETRY_ATTEMPTS=5

# Minimum delay between retries in ms (100-5000, default: 1000)
YANDEX_TRACKER_RETRY_MIN_DELAY=500

# Maximum delay between retries in ms (1000-60000, default: 10000)
YANDEX_TRACKER_RETRY_MAX_DELAY=30000
```

**Example:** Aggressive retry for high-load environments:
```bash
YANDEX_TRACKER_RETRY_ATTEMPTS=5
YANDEX_TRACKER_RETRY_MIN_DELAY=2000
YANDEX_TRACKER_RETRY_MAX_DELAY=20000
```
```

### Шаг 6: Добавить тесты

Создать `packages/servers/yandex-tracker/tests/unit/config/retry-config.test.ts`:

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { loadConfig } from '#config';

describe('Retry Configuration', () => {
  const originalEnv = process.env;

  beforeEach(() => {
    process.env = { ...originalEnv };
    process.env.YANDEX_TRACKER_TOKEN = 'test-token';
    process.env.YANDEX_ORG_ID = 'test-org';
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  it('should use default retry values when not specified', () => {
    const config = loadConfig();
    expect(config.retryAttempts).toBe(3);
    expect(config.retryMinDelay).toBe(1000);
    expect(config.retryMaxDelay).toBe(10000);
  });

  it('should load custom retry values', () => {
    process.env.YANDEX_TRACKER_RETRY_ATTEMPTS = '5';
    process.env.YANDEX_TRACKER_RETRY_MIN_DELAY = '2000';
    process.env.YANDEX_TRACKER_RETRY_MAX_DELAY = '20000';

    const config = loadConfig();
    expect(config.retryAttempts).toBe(5);
    expect(config.retryMinDelay).toBe(2000);
    expect(config.retryMaxDelay).toBe(20000);
  });

  it('should use defaults for invalid retry attempts', () => {
    process.env.YANDEX_TRACKER_RETRY_ATTEMPTS = '-1';
    const config = loadConfig();
    expect(config.retryAttempts).toBe(3);
  });

  it('should cap retry attempts at 10', () => {
    process.env.YANDEX_TRACKER_RETRY_ATTEMPTS = '100';
    const config = loadConfig();
    expect(config.retryAttempts).toBe(3);
  });
});
```

---

## Проверка результатов

### Автоматические тесты
```bash
npm run test -- retry-config.test.ts
npm run validate
```

### Ручная проверка
```bash
# Запустить сервер с кастомными retry параметрами
YANDEX_TRACKER_RETRY_ATTEMPTS=5 \
YANDEX_TRACKER_RETRY_MIN_DELAY=2000 \
npm start

# Проверить логи - должно быть:
# "HTTP retry configuration loaded" { attempts: 5, minDelay: 2000, ... }
```

---

## Критерий готовности (Definition of Done)

- ✅ ServerConfig расширен полями retry
- ✅ Константы DEFAULT_RETRY_* добавлены
- ✅ ENV_VAR_NAMES обновлён
- ✅ loadConfig() валидирует retry параметры
- ✅ DI container использует config.retry*
- ✅ Логирование retry конфигурации при старте
- ✅ README.md обновлён с примерами
- ✅ Тесты добавлены и проходят
- ✅ `npm run validate` проходит
- ✅ Коммит создан
