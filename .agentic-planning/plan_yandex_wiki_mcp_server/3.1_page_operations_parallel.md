# Этап 3.1: Page Operations (Parallel)

## Цель
Создать API Operations для работы со страницами Wiki.

## Зависимости
- Этап 2.1 (Entities) завершён
- Этап 2.2 (DTOs) завершён

## Чек-лист

### 1. Base Operation
- [ ] Создать `src/wiki_api/api_operations/base-operation.ts`

```typescript
import type { IHttpClient, CacheManager } from '@mcp-framework/infrastructure';
import type { Logger } from '@mcp-framework/infrastructure';

/**
 * Базовый класс для API операций Wiki
 */
export abstract class BaseOperation {
  constructor(
    protected readonly httpClient: IHttpClient,
    protected readonly cacheManager: CacheManager,
    protected readonly logger: Logger
  ) {}

  /**
   * Выполнение с кешированием
   */
  protected async withCache<T>(
    cacheKey: string,
    fn: () => Promise<T>,
    ttl?: number
  ): Promise<T> {
    const cached = await this.cacheManager.get<T>(cacheKey);
    if (cached !== undefined) {
      this.logger.debug(`Cache hit: ${cacheKey}`);
      return cached;
    }

    const result = await fn();
    await this.cacheManager.set(cacheKey, result, ttl);
    return result;
  }
}
```

### 2. Get Page Operation
- [ ] Создать `src/wiki_api/api_operations/page/get-page.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { PageWithUnknownFields } from '#wiki_api/entities/index.js';

export interface GetPageParams {
  slug: string;
  fields?: string;
  raise_on_redirect?: boolean;
  revision_id?: number;
}

export class GetPageOperation extends BaseOperation {
  async execute(params: GetPageParams): Promise<PageWithUnknownFields> {
    const queryParams: Record<string, string | number | boolean> = {
      slug: params.slug,
    };

    if (params.fields) queryParams.fields = params.fields;
    if (params.raise_on_redirect) queryParams.raise_on_redirect = true;
    if (params.revision_id) queryParams.revision_id = params.revision_id;

    this.logger.info(`Getting page by slug: ${params.slug}`);

    return this.httpClient.get<PageWithUnknownFields>('/v1/pages', queryParams);
  }
}
```

### 3. Get Page By ID Operation
- [ ] Создать `src/wiki_api/api_operations/page/get-page-by-id.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { PageWithUnknownFields } from '#wiki_api/entities/index.js';

export interface GetPageByIdParams {
  idx: number;
  fields?: string;
  raise_on_redirect?: boolean;
  revision_id?: number;
}

export class GetPageByIdOperation extends BaseOperation {
  async execute(params: GetPageByIdParams): Promise<PageWithUnknownFields> {
    const queryParams: Record<string, string | number | boolean> = {};

    if (params.fields) queryParams.fields = params.fields;
    if (params.raise_on_redirect) queryParams.raise_on_redirect = true;
    if (params.revision_id) queryParams.revision_id = params.revision_id;

    this.logger.info(`Getting page by id: ${params.idx}`);

    return this.httpClient.get<PageWithUnknownFields>(
      `/v1/pages/${params.idx}`,
      queryParams
    );
  }
}
```

### 4. Create Page Operation
- [ ] Создать `src/wiki_api/api_operations/page/create-page.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { CreatePageDto } from '#wiki_api/dto/index.js';

export interface CreatePageParams {
  data: CreatePageDto;
  fields?: string;
  is_silent?: boolean;
}

export class CreatePageOperation extends BaseOperation {
  async execute(params: CreatePageParams): Promise<Record<string, never>> {
    const queryParams: Record<string, string | boolean> = {};

    if (params.fields) queryParams.fields = params.fields;
    if (params.is_silent) queryParams.is_silent = true;

    this.logger.info(`Creating page: ${params.data.slug}`);

    return this.httpClient.post<Record<string, never>>(
      '/v1/pages',
      params.data
    );
  }
}
```

### 5. Update Page Operation
- [ ] Создать `src/wiki_api/api_operations/page/update-page.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { UpdatePageDto } from '#wiki_api/dto/index.js';
import type { PageWithUnknownFields } from '#wiki_api/entities/index.js';

export interface UpdatePageParams {
  idx: number;
  data: UpdatePageDto;
  allow_merge?: boolean;
  fields?: string;
  is_silent?: boolean;
}

export class UpdatePageOperation extends BaseOperation {
  async execute(params: UpdatePageParams): Promise<PageWithUnknownFields> {
    const queryParams: Record<string, string | boolean> = {};

    if (params.allow_merge) queryParams.allow_merge = true;
    if (params.fields) queryParams.fields = params.fields;
    if (params.is_silent) queryParams.is_silent = true;

    this.logger.info(`Updating page: ${params.idx}`);

    // Wiki API использует POST для update
    return this.httpClient.post<PageWithUnknownFields>(
      `/v1/pages/${params.idx}`,
      params.data
    );
  }
}
```

### 6. Delete Page Operation
- [ ] Создать `src/wiki_api/api_operations/page/delete-page.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';

export interface DeletePageResult {
  recovery_token: string;
}

export class DeletePageOperation extends BaseOperation {
  async execute(idx: number): Promise<DeletePageResult> {
    this.logger.info(`Deleting page: ${idx}`);

    return this.httpClient.delete<DeletePageResult>(`/v1/pages/${idx}`);
  }
}
```

### 7. Clone Page Operation
- [ ] Создать `src/wiki_api/api_operations/page/clone-page.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { ClonePageDto } from '#wiki_api/dto/index.js';
import type { AsyncOperation } from '#wiki_api/entities/index.js';

export class ClonePageOperation extends BaseOperation {
  async execute(idx: number, data: ClonePageDto): Promise<AsyncOperation> {
    this.logger.info(`Cloning page ${idx} to ${data.target}`);

    return this.httpClient.post<AsyncOperation>(
      `/v1/pages/${idx}/clone`,
      data
    );
  }
}
```

### 8. Append Content Operation
- [ ] Создать `src/wiki_api/api_operations/page/append-content.operation.ts`

```typescript
import { BaseOperation } from '../base-operation.js';
import type { AppendContentDto } from '#wiki_api/dto/index.js';
import type { PageWithUnknownFields } from '#wiki_api/entities/index.js';

export interface AppendContentParams {
  idx: number;
  data: AppendContentDto;
  fields?: string;
  is_silent?: boolean;
}

export class AppendContentOperation extends BaseOperation {
  async execute(params: AppendContentParams): Promise<PageWithUnknownFields> {
    const queryParams: Record<string, string | boolean> = {};

    if (params.fields) queryParams.fields = params.fields;
    if (params.is_silent) queryParams.is_silent = true;

    this.logger.info(`Appending content to page: ${params.idx}`);

    return this.httpClient.post<PageWithUnknownFields>(
      `/v1/pages/${params.idx}/append-content`,
      params.data
    );
  }
}
```

### 9. Index файлы
- [ ] Создать `src/wiki_api/api_operations/page/index.ts`

```typescript
export { GetPageOperation } from './get-page.operation.js';
export type { GetPageParams } from './get-page.operation.js';

export { GetPageByIdOperation } from './get-page-by-id.operation.js';
export type { GetPageByIdParams } from './get-page-by-id.operation.js';

export { CreatePageOperation } from './create-page.operation.js';
export type { CreatePageParams } from './create-page.operation.js';

export { UpdatePageOperation } from './update-page.operation.js';
export type { UpdatePageParams } from './update-page.operation.js';

export { DeletePageOperation } from './delete-page.operation.js';
export type { DeletePageResult } from './delete-page.operation.js';

export { ClonePageOperation } from './clone-page.operation.js';

export { AppendContentOperation } from './append-content.operation.js';
export type { AppendContentParams } from './append-content.operation.js';
```

- [ ] Создать `src/wiki_api/api_operations/index.ts`

```typescript
export { BaseOperation } from './base-operation.js';
export * from './page/index.js';
// export * from './grid/index.js';  // TODO: добавить позже
```

## Валидация
```bash
npm run typecheck
npm run lint
```

## Результат
- 7 операций для Pages API готовы
- Все операции наследуют BaseOperation
- Готовы для использования в Facade
