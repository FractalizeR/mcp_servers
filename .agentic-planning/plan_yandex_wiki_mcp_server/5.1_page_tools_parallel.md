# Этап 5.1: Page Tools (Parallel)

## Цель
Создать MCP Tools для работы со страницами Wiki.

## Зависимости
- Этап 4.1 (Facade & Services) завершён

## Чек-лист

### 1. Common Schemas
- [ ] Создать `src/common/schemas/page-id.schema.ts`

```typescript
import { z } from 'zod';

/**
 * Schema для ID страницы (integer)
 */
export const PageIdSchema = z
  .number()
  .int()
  .positive()
  .describe('ID страницы Wiki (целое число)');

/**
 * Schema для slug страницы (path)
 */
export const PageSlugSchema = z
  .string()
  .min(1)
  .describe('Slug страницы Wiki (например, users/docs/readme)');
```

- [ ] Создать `src/common/schemas/fields.schema.ts`

```typescript
import { z } from 'zod';

/**
 * Schema для дополнительных полей ответа
 */
export const WikiFieldsSchema = z
  .string()
  .optional()
  .describe('Дополнительные поля через запятую: attributes, breadcrumbs, content, redirect');
```

- [ ] Создать `src/common/schemas/index.ts`

### 2. Get Page Tool
- [ ] Создать `src/tools/api/pages/get/get-page.schema.ts`

```typescript
import { z } from 'zod';
import { PageSlugSchema, WikiFieldsSchema } from '#common/schemas/index.js';

export const GetPageParamsSchema = z.object({
  slug: PageSlugSchema,
  fields: WikiFieldsSchema,
  raise_on_redirect: z
    .boolean()
    .optional()
    .describe('Вернуть ошибку при редиректе (default: false)'),
  revision_id: z
    .number()
    .int()
    .optional()
    .describe('ID конкретной ревизии страницы'),
});

export type GetPageParams = z.infer<typeof GetPageParamsSchema>;
```

- [ ] Создать `src/tools/api/pages/get/get-page.metadata.ts`

```typescript
import { buildToolName, ToolCategory, ToolPriority } from '@mcp-framework/core';
import type { StaticToolMetadata } from '@mcp-framework/core';
import { MCP_TOOL_PREFIX } from '#constants';

export const GET_PAGE_TOOL_METADATA: StaticToolMetadata = {
  name: buildToolName('get_page', MCP_TOOL_PREFIX),
  description: '[Pages/Read] Получить страницу Wiki по slug',
  category: ToolCategory.PAGES,  // Нужно добавить в core
  subcategory: 'read',
  priority: ToolPriority.CRITICAL,
  tags: ['read', 'get', 'page', 'wiki'],
  isHelper: false,
} as const;
```

- [ ] Создать `src/tools/api/pages/get/get-page.tool.ts`

```typescript
import { BaseTool } from '@mcp-framework/core';
import type { YandexWikiFacade } from '#wiki_api/facade/index.js';
import type { ToolCallParams, ToolResult } from '@mcp-framework/infrastructure';
import { ResponseFieldFilter, ResultLogger } from '@mcp-framework/core';
import { GetPageParamsSchema } from './get-page.schema.js';
import { GET_PAGE_TOOL_METADATA } from './get-page.metadata.js';

export class GetPageTool extends BaseTool<YandexWikiFacade> {
  static override readonly METADATA = GET_PAGE_TOOL_METADATA;

  protected override getParamsSchema() {
    return GetPageParamsSchema;
  }

  async execute(params: ToolCallParams): Promise<ToolResult> {
    const validation = this.validateParams(params, GetPageParamsSchema);
    if (!validation.success) {
      return validation.error;
    }

    const { slug, fields, raise_on_redirect, revision_id } = validation.data;

    try {
      ResultLogger.logOperationStart(this.logger, 'Получение страницы', 1);

      const page = await this.facade.getPage({
        slug,
        fields,
        raise_on_redirect,
        revision_id,
      });

      return this.formatSuccess({
        page,
        fieldsReturned: fields?.split(',') ?? ['id', 'slug', 'title', 'page_type'],
      });
    } catch (error: unknown) {
      return this.formatError(`Ошибка при получении страницы: ${slug}`, error);
    }
  }
}
```

- [ ] Создать `src/tools/api/pages/get/index.ts`

### 3. Get Page By ID Tool
- [ ] Создать структуру `src/tools/api/pages/get-by-id/`
  - `get-page-by-id.schema.ts`
  - `get-page-by-id.metadata.ts`
  - `get-page-by-id.tool.ts`
  - `index.ts`

### 4. Create Page Tool
- [ ] Создать структуру `src/tools/api/pages/create/`
  - `create-page.schema.ts` — page_type, slug, title, content (опционально)
  - `create-page.metadata.ts`
  - `create-page.tool.ts`
  - `index.ts`

### 5. Update Page Tool
- [ ] Создать структуру `src/tools/api/pages/update/`
  - `update-page.schema.ts` — idx, title, content, allow_merge
  - `update-page.metadata.ts`
  - `update-page.tool.ts`
  - `index.ts`

### 6. Delete Page Tool
- [ ] Создать структуру `src/tools/api/pages/delete/`
  - `delete-page.schema.ts` — idx
  - `delete-page.metadata.ts`
  - `delete-page.tool.ts` — возвращает recovery_token
  - `index.ts`

### 7. Clone Page Tool
- [ ] Создать структуру `src/tools/api/pages/clone/`
  - `clone-page.schema.ts` — idx, target, title, subscribe_me
  - `clone-page.metadata.ts`
  - `clone-page.tool.ts` — возвращает AsyncOperation с status_url
  - `index.ts`

### 8. Append Content Tool
- [ ] Создать структуру `src/tools/api/pages/append/`
  - `append-content.schema.ts` — idx, content, body/section/anchor
  - `append-content.metadata.ts`
  - `append-content.tool.ts`
  - `index.ts`

### 9. Ping Tool
- [ ] Создать `src/tools/helpers/ping/`
  - Простой tool для проверки подключения
  - Использовать GET `/v1/pages?slug=homepage` или аналог

### 10. Tools Index
- [ ] Создать `src/tools/api/pages/index.ts`
- [ ] Создать `src/tools/api/index.ts`
- [ ] Создать `src/tools/index.ts`

## Пример структуры tool директории

```
src/tools/api/pages/get/
├── get-page.schema.ts      # Zod schema (source of truth)
├── get-page.metadata.ts    # Static metadata
├── get-page.tool.ts        # Tool class
└── index.ts                # Re-exports
```

## Валидация
```bash
npm run typecheck
npm run lint
npm run test  # unit tests для tools
```

## Результат
- 7 Page tools + 1 Ping tool готовы
- Все tools используют Zod schemas
- Готовы для регистрации в DI
