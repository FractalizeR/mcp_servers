# Этап 4.1: Facade & Services (Sequential)

## Цель
Создать Facade и доменные сервисы для Wiki API.

## Зависимости
- Этап 3.1 (Page Operations) завершён

## Чек-лист

### 1. Page Service
- [ ] Создать `src/wiki_api/facade/services/page.service.ts`

```typescript
import { injectable, inject } from 'inversify';
import {
  GetPageOperation,
  GetPageByIdOperation,
  CreatePageOperation,
  UpdatePageOperation,
  DeletePageOperation,
  ClonePageOperation,
  AppendContentOperation,
} from '#wiki_api/api_operations/index.js';
import type {
  GetPageParams,
  GetPageByIdParams,
  CreatePageParams,
  UpdatePageParams,
  AppendContentParams,
  DeletePageResult,
} from '#wiki_api/api_operations/index.js';
import type { PageWithUnknownFields, AsyncOperation } from '#wiki_api/entities/index.js';
import type { ClonePageDto } from '#wiki_api/dto/index.js';

@injectable()
export class PageService {
  constructor(
    @inject(GetPageOperation) private readonly getPageOp: GetPageOperation,
    @inject(GetPageByIdOperation) private readonly getPageByIdOp: GetPageByIdOperation,
    @inject(CreatePageOperation) private readonly createPageOp: CreatePageOperation,
    @inject(UpdatePageOperation) private readonly updatePageOp: UpdatePageOperation,
    @inject(DeletePageOperation) private readonly deletePageOp: DeletePageOperation,
    @inject(ClonePageOperation) private readonly clonePageOp: ClonePageOperation,
    @inject(AppendContentOperation) private readonly appendContentOp: AppendContentOperation
  ) {}

  async getPage(params: GetPageParams): Promise<PageWithUnknownFields> {
    return this.getPageOp.execute(params);
  }

  async getPageById(params: GetPageByIdParams): Promise<PageWithUnknownFields> {
    return this.getPageByIdOp.execute(params);
  }

  async createPage(params: CreatePageParams): Promise<Record<string, never>> {
    return this.createPageOp.execute(params);
  }

  async updatePage(params: UpdatePageParams): Promise<PageWithUnknownFields> {
    return this.updatePageOp.execute(params);
  }

  async deletePage(idx: number): Promise<DeletePageResult> {
    return this.deletePageOp.execute(idx);
  }

  async clonePage(idx: number, data: ClonePageDto): Promise<AsyncOperation> {
    return this.clonePageOp.execute(idx, data);
  }

  async appendContent(params: AppendContentParams): Promise<PageWithUnknownFields> {
    return this.appendContentOp.execute(params);
  }
}
```

### 2. Services Index
- [ ] Создать `src/wiki_api/facade/services/index.ts`

```typescript
export { PageService } from './page.service.js';
// export { GridService } from './grid.service.js';  // TODO: добавить позже
```

### 3. YandexWikiFacade
- [ ] Создать `src/wiki_api/facade/yandex-wiki.facade.ts`

```typescript
import { injectable, inject } from 'inversify';
import { PageService } from './services/index.js';
import type {
  GetPageParams,
  GetPageByIdParams,
  CreatePageParams,
  UpdatePageParams,
  AppendContentParams,
  DeletePageResult,
} from '#wiki_api/api_operations/index.js';
import type { PageWithUnknownFields, AsyncOperation } from '#wiki_api/entities/index.js';
import type { ClonePageDto } from '#wiki_api/dto/index.js';

/**
 * Фасад для работы с API Yandex Wiki
 *
 * Ответственность:
 * - ТОЛЬКО делегирование вызовов доменным сервисам
 * - НЕТ бизнес-логики
 */
@injectable()
export class YandexWikiFacade {
  constructor(
    @inject(PageService) private readonly pageService: PageService
    // @inject(GridService) private readonly gridService: GridService  // TODO
  ) {}

  // === Page Methods ===

  /**
   * Получает страницу по slug
   */
  async getPage(params: GetPageParams): Promise<PageWithUnknownFields> {
    return this.pageService.getPage(params);
  }

  /**
   * Получает страницу по ID
   */
  async getPageById(params: GetPageByIdParams): Promise<PageWithUnknownFields> {
    return this.pageService.getPageById(params);
  }

  /**
   * Создает новую страницу
   */
  async createPage(params: CreatePageParams): Promise<Record<string, never>> {
    return this.pageService.createPage(params);
  }

  /**
   * Обновляет страницу
   */
  async updatePage(params: UpdatePageParams): Promise<PageWithUnknownFields> {
    return this.pageService.updatePage(params);
  }

  /**
   * Удаляет страницу
   * @returns recovery_token для восстановления
   */
  async deletePage(idx: number): Promise<DeletePageResult> {
    return this.pageService.deletePage(idx);
  }

  /**
   * Клонирует страницу
   * @returns AsyncOperation с status_url для отслеживания
   */
  async clonePage(idx: number, data: ClonePageDto): Promise<AsyncOperation> {
    return this.pageService.clonePage(idx, data);
  }

  /**
   * Добавляет контент к странице
   */
  async appendContent(params: AppendContentParams): Promise<PageWithUnknownFields> {
    return this.pageService.appendContent(params);
  }

  // === Grid Methods (TODO) ===
}
```

### 4. Facade Index
- [ ] Создать `src/wiki_api/facade/index.ts`

```typescript
export { YandexWikiFacade } from './yandex-wiki.facade.js';
export * from './services/index.js';
```

### 5. Wiki API Index
- [ ] Создать `src/wiki_api/index.ts`

```typescript
export * from './entities/index.js';
export * from './dto/index.js';
export * from './api_operations/index.js';
export * from './facade/index.js';
```

## Валидация
```bash
npm run typecheck
npm run lint
```

## Результат
- PageService инкапсулирует логику работы со страницами
- YandexWikiFacade предоставляет единый интерфейс для Tools
- Готово для DI регистрации
