# Этап 7.1: Unit Tests (Parallel)

## Цель
Создать unit тесты для всех компонентов.

## Зависимости
- Этап 6.1 (Composition Root) завершён

## Чек-лист

### 1. Test Helpers
- [ ] Создать `tests/helpers/mock-http-client.ts`

```typescript
import type { IHttpClient } from '@mcp-framework/infrastructure';

export function createMockHttpClient(): jest.Mocked<IHttpClient> {
  return {
    get: vi.fn(),
    post: vi.fn(),
    patch: vi.fn(),
    delete: vi.fn(),
  };
}
```

- [ ] Создать `tests/helpers/mock-logger.ts`
- [ ] Создать `tests/helpers/mock-cache.ts`
- [ ] Создать `tests/helpers/fixtures/page.fixture.ts`

```typescript
import type { Page, PageWithUnknownFields } from '#wiki_api/entities/index.js';

export function createPageFixture(overrides?: Partial<Page>): PageWithUnknownFields {
  return {
    id: 123,
    slug: 'users/docs/test-page',
    title: 'Test Page',
    page_type: 'page',
    ...overrides,
  };
}
```

- [ ] Создать `tests/helpers/index.ts`

### 2. Entity Tests
- [ ] Создать `tests/unit/wiki_api/entities/page.entity.test.ts`
  - Проверка типов
  - Проверка WithUnknownFields

### 3. Operation Tests
- [ ] Создать `tests/unit/wiki_api/api_operations/page/get-page.operation.test.ts`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetPageOperation } from '#wiki_api/api_operations/page/get-page.operation.js';
import { createMockHttpClient, createMockLogger, createMockCache } from '#helpers/index.js';
import { createPageFixture } from '#helpers/fixtures/page.fixture.js';

describe('GetPageOperation', () => {
  let operation: GetPageOperation;
  let mockHttpClient: ReturnType<typeof createMockHttpClient>;

  beforeEach(() => {
    mockHttpClient = createMockHttpClient();
    const mockLogger = createMockLogger();
    const mockCache = createMockCache();
    operation = new GetPageOperation(mockHttpClient, mockCache, mockLogger);
  });

  it('should fetch page by slug', async () => {
    const expectedPage = createPageFixture();
    mockHttpClient.get.mockResolvedValue(expectedPage);

    const result = await operation.execute({ slug: 'users/docs/test' });

    expect(mockHttpClient.get).toHaveBeenCalledWith('/v1/pages', { slug: 'users/docs/test' });
    expect(result).toEqual(expectedPage);
  });

  it('should pass optional parameters', async () => {
    mockHttpClient.get.mockResolvedValue(createPageFixture());

    await operation.execute({
      slug: 'test',
      fields: 'attributes,content',
      raise_on_redirect: true,
      revision_id: 5,
    });

    expect(mockHttpClient.get).toHaveBeenCalledWith('/v1/pages', {
      slug: 'test',
      fields: 'attributes,content',
      raise_on_redirect: true,
      revision_id: 5,
    });
  });
});
```

- [ ] Создать тесты для остальных operations:
  - `get-page-by-id.operation.test.ts`
  - `create-page.operation.test.ts`
  - `update-page.operation.test.ts`
  - `delete-page.operation.test.ts`
  - `clone-page.operation.test.ts`
  - `append-content.operation.test.ts`

### 4. Service Tests
- [ ] Создать `tests/unit/wiki_api/facade/services/page.service.test.ts`
  - Проверка делегирования вызовов в operations

### 5. Facade Tests
- [ ] Создать `tests/unit/wiki_api/facade/yandex-wiki.facade.test.ts`
  - Проверка делегирования в services

### 6. Tool Tests
- [ ] Создать `tests/unit/tools/api/pages/get/get-page.tool.test.ts`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetPageTool } from '#tools/api/pages/get/index.js';
import { createMockLogger } from '#helpers/index.js';
import { createPageFixture } from '#helpers/fixtures/page.fixture.js';

describe('GetPageTool', () => {
  let tool: GetPageTool;
  let mockFacade: { getPage: ReturnType<typeof vi.fn> };

  beforeEach(() => {
    mockFacade = { getPage: vi.fn() };
    const mockLogger = createMockLogger();
    tool = new GetPageTool(mockFacade as any, mockLogger);
  });

  it('should return page on success', async () => {
    const expectedPage = createPageFixture();
    mockFacade.getPage.mockResolvedValue(expectedPage);

    const result = await tool.execute({ slug: 'test-page' });

    expect(result.isError).toBe(false);
    expect(result.content[0].text).toContain('test-page');
  });

  it('should validate required parameters', async () => {
    const result = await tool.execute({});

    expect(result.isError).toBe(true);
  });
});
```

- [ ] Создать тесты для остальных tools

### 7. Schema Tests
- [ ] Создать `tests/unit/tools/api/pages/get/get-page.schema.test.ts`
  - Проверка валидации Zod schemas

### 8. Config Tests
- [ ] Создать `tests/unit/config/config-loader.test.ts`
  - Проверка загрузки из env
  - Проверка валидации
  - Проверка default values

### 9. Integration Tests (опционально)
- [ ] Создать `tests/integration/wiki-api.test.ts`
  - Требует реальный токен
  - Пометить как skip по умолчанию

### 10. Tests README
- [ ] Создать `tests/README.md`
  - Структура тестов
  - Как запускать
  - Fixtures и helpers

## Валидация
```bash
npm run test
npm run test:coverage
# Проверить coverage >= 80%
```

## Результат
- Unit тесты для всех компонентов
- Coverage >= 80%
- Fixtures и helpers для удобства тестирования
