# Этап 6.1: Composition Root (Sequential)

## Цель
Настроить Dependency Injection с InversifyJS.

## Зависимости
- Этап 5.1 (Page Tools) завершён

## Чек-лист

### 1. DI Types
- [ ] Создать `src/composition-root/types.ts`

```typescript
/**
 * Symbol-based DI токены
 */
export const TYPES = {
  // Infrastructure
  ServerConfig: Symbol.for('ServerConfig'),
  Logger: Symbol.for('Logger'),
  HttpClient: Symbol.for('HttpClient'),
  CacheManager: Symbol.for('CacheManager'),
  RetryStrategy: Symbol.for('RetryStrategy'),

  // Facade
  YandexWikiFacade: Symbol.for('YandexWikiFacade'),

  // Services
  PageService: Symbol.for('PageService'),
  // GridService: Symbol.for('GridService'),  // TODO

  // Registry
  ToolRegistry: Symbol.for('ToolRegistry'),
  ToolSearchEngine: Symbol.for('ToolSearchEngine'),
} as const;

/**
 * Автоматически генерируемые символы для Tools
 */
export const TOOL_SYMBOLS: Record<string, symbol> = {};

/**
 * Автоматически генерируемые символы для Operations
 */
export const OPERATION_SYMBOLS: Record<string, symbol> = {};
```

### 2. Tool Definitions
- [ ] Создать `src/composition-root/definitions/tool-definitions.ts`

```typescript
import { PingTool } from '#tools/helpers/ping/index.js';
import { GetPageTool } from '#tools/api/pages/get/index.js';
import { GetPageByIdTool } from '#tools/api/pages/get-by-id/index.js';
import { CreatePageTool } from '#tools/api/pages/create/index.js';
import { UpdatePageTool } from '#tools/api/pages/update/index.js';
import { DeletePageTool } from '#tools/api/pages/delete/index.js';
import { ClonePageTool } from '#tools/api/pages/clone/index.js';
import { AppendContentTool } from '#tools/api/pages/append/index.js';

/**
 * Все Tool классы для автоматической регистрации
 *
 * Для добавления нового tool - просто добавь класс в массив
 */
export const TOOL_CLASSES = [
  // Helpers
  PingTool,

  // Pages
  GetPageTool,
  GetPageByIdTool,
  CreatePageTool,
  UpdatePageTool,
  DeletePageTool,
  ClonePageTool,
  AppendContentTool,
] as const;
```

### 3. Operation Definitions
- [ ] Создать `src/composition-root/definitions/operation-definitions.ts`

```typescript
import {
  GetPageOperation,
  GetPageByIdOperation,
  CreatePageOperation,
  UpdatePageOperation,
  DeletePageOperation,
  ClonePageOperation,
  AppendContentOperation,
} from '#wiki_api/api_operations/index.js';

/**
 * Все Operation классы для автоматической регистрации
 */
export const OPERATION_CLASSES = [
  GetPageOperation,
  GetPageByIdOperation,
  CreatePageOperation,
  UpdatePageOperation,
  DeletePageOperation,
  ClonePageOperation,
  AppendContentOperation,
] as const;
```

### 4. Facade Services Binding
- [ ] Создать `src/composition-root/definitions/facade-services.ts`

```typescript
import type { Container } from 'inversify';
import { PageService } from '#wiki_api/facade/services/index.js';

/**
 * Регистрация доменных сервисов
 */
export function bindFacadeServices(container: Container): void {
  container.bind(PageService).toSelf().inSingletonScope();
  // container.bind(GridService).toSelf().inSingletonScope();  // TODO
}
```

### 5. Definitions Index
- [ ] Создать `src/composition-root/definitions/index.ts`

```typescript
export { TOOL_CLASSES } from './tool-definitions.js';
export { OPERATION_CLASSES } from './operation-definitions.js';
export { bindFacadeServices } from './facade-services.js';
```

### 6. Container
- [ ] Создать `src/composition-root/container.ts`
- [ ] Скопировать логику из yandex-tracker/composition-root/container.ts
- [ ] Адаптировать:
  - Заменить YandexTrackerFacade на YandexWikiFacade
  - Использовать YANDEX_WIKI_API_BASE
  - Убрать batch-related конфигурацию
  - Обновить imports

### 7. Validation
- [ ] Создать `src/composition-root/validation.ts`

```typescript
import { TOOL_CLASSES } from './definitions/tool-definitions.js';
import { OPERATION_CLASSES } from './definitions/operation-definitions.js';

/**
 * Валидация уникальности имён классов в DI
 */
export function validateDIRegistrations(): void {
  const names = new Set<string>();

  for (const ToolClass of TOOL_CLASSES) {
    if (names.has(ToolClass.name)) {
      throw new Error(`Duplicate tool class name: ${ToolClass.name}`);
    }
    names.add(ToolClass.name);
  }

  for (const OpClass of OPERATION_CLASSES) {
    if (names.has(OpClass.name)) {
      throw new Error(`Duplicate operation class name: ${OpClass.name}`);
    }
    names.add(OpClass.name);
  }
}
```

### 8. Composition Root Index
- [ ] Создать `src/composition-root/index.ts`

```typescript
export { createContainer } from './container.js';
export { TYPES, TOOL_SYMBOLS, OPERATION_SYMBOLS } from './types.js';
export { validateDIRegistrations } from './validation.js';
```

### 9. Entry Point (финализация)
- [ ] Обновить `src/index.ts`

```typescript
import 'reflect-metadata';
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { loadConfig } from '#config';
import { createContainer } from '#composition-root/index.js';
import { TYPES } from '#composition-root/types.js';
import { ToolRegistry } from '@mcp-framework/core';
import type { Logger } from '@mcp-framework/infrastructure';

async function main(): Promise<void> {
  const config = loadConfig();
  const container = await createContainer(config);

  const logger = container.get<Logger>(TYPES.Logger);
  const toolRegistry = container.get<ToolRegistry>(TYPES.ToolRegistry);

  logger.info('Starting Yandex Wiki MCP Server...');

  const server = new Server(
    { name: 'mcp-server-yandex-wiki', version: '0.1.0' },
    { capabilities: { tools: {} } }
  );

  // Регистрация tools
  server.setRequestHandler(/* ... */);

  const transport = new StdioServerTransport();
  await server.connect(transport);

  logger.info('Yandex Wiki MCP Server started');
}

main().catch(console.error);
```

## Валидация
```bash
npm run build
npm run typecheck
npm run validate
```

## Результат
- DI контейнер полностью настроен
- Все компоненты автоматически регистрируются
- Entry point готов к запуску
