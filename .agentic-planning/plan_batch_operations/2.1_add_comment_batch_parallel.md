# –≠—Ç–∞–ø 2.1: add-comment ‚Üí batch support

**Execution Type:** `parallel` (–º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å 2.2, 2.3)

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–∞—Å—Å–∏–≤–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ add-comment tool.

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] 1. –û–±–Ω–æ–≤–∏—Ç—å schema –¥–ª—è –º–∞—Å—Å–∏–≤–∞ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- [ ] 2. –°–æ–∑–¥–∞—Ç—å batch operation –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- [ ] 3. –û–±–Ω–æ–≤–∏—Ç—å tool –¥–ª—è batch —Ä–µ–∂–∏–º–∞
- [ ] 4. –û–±–Ω–æ–≤–∏—Ç—å metadata –∏ description
- [ ] 5. –û–±–Ω–æ–≤–∏—Ç—å facade –∏ service methods
- [ ] 6. –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã
- [ ] 7. –í–∞–ª–∏–¥–∞—Ü–∏—è: `npm run validate`
- [ ] 8. –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏

### –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ schema

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tools/api/comments/add/add-comment.schema.ts`

**–í–ê–ñ–ù–û:** –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º **–°—Ç—Ä–∞—Ç–µ–≥–∏—é B: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

**–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ (single):**
```typescript
{
  issueId: IssueKeySchema,
  text: z.string(),
  attachmentIds: z.array(z.string()).optional(),
  fields: FieldsSchema
}
```

**–ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (batch):**
```typescript
export const AddCommentParamsSchema = z.object({
  /**
   * –ú–∞—Å—Å–∏–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
   */
  comments: z.array(
    z.object({
      issueId: IssueKeySchema.describe('Issue ID or key'),
      text: z.string().min(1).describe('Comment text'),
      attachmentIds: z.array(z.string()).optional().describe('Attachment IDs'),
    })
  ).min(1).describe('Array of comments to add'),

  /**
   * –ü–æ–ª—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º)
   */
  fields: FieldsSchema,
});
```

**–û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø:**
```typescript
export type AddCommentParams = z.infer<typeof AddCommentParamsSchema>;
```

---

### –®–∞–≥ 2: Batch operation

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tracker_api/api_operations/comment/add-comment.operation.ts`

**–î–æ–±–∞–≤–∏—Ç—å:**

1. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```typescript
constructor(
  httpClient: HttpClient,
  cacheManager: CacheManager,
  logger: Logger,
  config: ServerConfig
) {
  super(httpClient, cacheManager, logger);
  this.parallelExecutor = new ParallelExecutor(logger, {
    maxBatchSize: config.maxBatchSize,
    maxConcurrentRequests: config.maxConcurrentRequests,
  });
}
```

2. **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ executeMany():**
```typescript
async executeMany(
  comments: Array<{ issueId: string; text: string; attachmentIds?: string[] }>
): Promise<BatchResult<string, CommentWithUnknownFields>>
```

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∞—Å—Å–∏–≤ –Ω–µ –ø—É—Å—Ç–æ–π
- –°–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è ParallelExecutor
- –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `execute()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `parallelExecutor.executeParallel()`
- –í–µ—Ä–Ω—É—Ç—å BatchResult

**–ü—Ä–∏–º–µ—Ä:**
```typescript
async executeMany(comments: Array<{...}>) {
  if (comments.length === 0) return [];

  const operations = comments.map(({ issueId, text, attachmentIds }) => ({
    key: issueId,
    fn: async () => this.execute(issueId, { text, attachmentIds })
  }));

  return this.parallelExecutor.executeParallel(operations, 'add comments');
}
```

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tool

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tools/api/comments/add/add-comment.tool.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ execute():**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
```typescript
const { comments, fields } = validation.data;
```

2. **–í—ã–∑–æ–≤ batch operation:**
```typescript
const results = await this.facade.addCommentsMany(comments);
```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
```typescript
const processedResults = BatchResultProcessor.process(
  results,
  (comment: CommentWithUnknownFields) =>
    ResponseFieldFilter.filter<CommentWithUnknownFields>(comment, fields)
);
```

4. **Unified batch result:**
```typescript
return this.formatSuccess({
  total: comments.length,
  successful: processedResults.successful.map(item => ({
    issueId: item.key,
    commentId: item.data.id,
    comment: item.data
  })),
  failed: processedResults.failed,
  fieldsReturned: fields
});
```

---

### –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ metadata

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tools/api/comments/add/add-comment.metadata.ts`

**–û–±–Ω–æ–≤–∏—Ç—å description:**
```typescript
description: 'Add comments to one or multiple Yandex Tracker issues. Each comment can have individual text and attachments. Returns unified batch result format.'
```

**–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```typescript
// –í JSDoc –∏–ª–∏ metadata
/**
 * Example:
 * {
 *   comments: [
 *     { issueId: 'PROJ-1', text: 'Comment for task 1' },
 *     { issueId: 'PROJ-2', text: 'Comment for task 2', attachmentIds: ['att123'] }
 *   ],
 *   fields: ['id', 'text', 'createdAt']
 * }
 */
```

---

### –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ facade –∏ service

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tracker_api/facade/yandex-tracker.facade.ts`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:**
```typescript
async addCommentsMany(
  comments: Array<{ issueId: string; text: string; attachmentIds?: string[] }>
): Promise<BatchResult<string, CommentWithUnknownFields>> {
  return this.commentService.addCommentsMany(comments);
}
```

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/tracker_api/facade/services/comment.service.ts`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:**
```typescript
async addCommentsMany(
  comments: Array<{ issueId: string; text: string; attachmentIds?: string[] }>
): Promise<BatchResult<string, CommentWithUnknownFields>> {
  return this.addCommentOperation.executeMany(comments);
}
```

---

### –®–∞–≥ 6: Unit-—Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `packages/servers/yandex-tracker/tests/tracker_api/api_operations/comment/add-comment.operation.test.ts`

**–¢–µ—Å—Ç—ã:**

1. **–£—Å–ø–µ—à–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∑–∞–¥–∞—á–∞–º:**
```typescript
it('should add comments to multiple issues with individual parameters', async () => {
  const comments = [
    { issueId: 'TEST-1', text: 'Comment 1' },
    { issueId: 'TEST-2', text: 'Comment 2', attachmentIds: ['att1'] }
  ];
  // Mock httpClient.post –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
  const results = await operation.executeMany(comments);
  expect(results).toHaveLength(2);
  expect(results.filter(r => r.status === 'fulfilled')).toHaveLength(2);
});
```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫:**
```typescript
it('should handle partial failures when adding comments', async () => {
  // Mock: TEST-1 —É—Å–ø–µ—Ö, TEST-2 –æ—à–∏–±–∫–∞ 404
  const results = await operation.executeMany([...]);
  expect(results.filter(r => r.status === 'fulfilled')).toHaveLength(1);
  expect(results.filter(r => r.status === 'rejected')).toHaveLength(1);
});
```

3. **–†–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏:**
```typescript
it('should use individual parameters for each comment', async () => {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–ª—è TEST-1 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç "Comment 1"
  // –ê –¥–ª—è TEST-2 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç "Comment 2" —Å attachmentIds
});
```

4. **–ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤:**
```typescript
it('should return empty result for empty comments array', async () => {
  const result = await operation.executeMany([]);
  expect(result).toEqual([]);
});
```

---

### –®–∞–≥ 7: Tool —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `packages/servers/yandex-tracker/tests/tools/api/comments/add/add-comment.tool.test.ts`

**–¢–µ—Å—Ç—ã:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è schema —Å –º–∞—Å—Å–∏–≤–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:**
```typescript
it('should validate comments array with individual parameters', async () => {
  const params = {
    comments: [
      { issueId: 'TEST-1', text: 'Text 1' },
      { issueId: 'TEST-2', text: 'Text 2' }
    ],
    fields: ['id', 'text']
  };
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ—Ö–æ–¥–∏—Ç
});
```

2. **Unified batch result format:**
```typescript
it('should return unified batch format with individual results', async () => {
  // Mock facade.addCommentsMany
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç: { total, successful, failed }
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π successful —Å–æ–¥–µ—Ä–∂–∏—Ç issueId, commentId, comment
});
```

3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:**
```typescript
it('should filter fields for all created comments', async () => {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ResponseFieldFilter –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –∫–∞–∂–¥–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
});
```

---

### –®–∞–≥ 8: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–æ–º–º–∏—Ç

```bash
npm run validate
```

**–§–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞:**
```
feat(comments): –¥–æ–±–∞–≤–∏—Ç—å batch support –≤ add-comment

–î–µ—Ç–∞–ª–∏:
- Schema: –º–∞—Å—Å–∏–≤ comments —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–°—Ç—Ä–∞—Ç–µ–≥–∏—è B)
- Operation: –¥–æ–±–∞–≤–ª–µ–Ω executeMany() —Å ParallelExecutor
- Tool: unified batch result format
- –ö–∞–∂–¥—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç –∏ attachmentIds
- Facade: –¥–æ–±–∞–≤–ª–µ–Ω addCommentsMany()
- –ü–æ–∫—Ä—ã—Ç–æ unit-—Ç–µ—Å—Ç–∞–º–∏

Breaking Changes:
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ –º–∞—Å—Å–∏–≤ comments: [{ issueId, text, attachmentIds }]
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ unified batch result

ü§ñ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

1. ‚úÖ Schema –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
2. ‚úÖ Operation executeMany() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
3. ‚úÖ Tool –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç unified batch result
4. ‚úÖ –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç –∏ attachments
5. ‚úÖ Facade –∏ service methods –¥–æ–±–∞–≤–ª–µ–Ω—ã
6. ‚úÖ Unit-—Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
7. ‚úÖ `npm run validate` —É—Å–ø–µ—à–Ω–∞
8. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã

---

## üìö –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

**–û—Ç–ª–∏—á–∏—è –æ—Ç GET –æ–ø–µ—Ä–∞—Ü–∏–π:**
- GET: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (perPage, page) –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- POST: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (text, attachmentIds) –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏

**–û–±—Ä–∞–∑—Ü—ã:**
- –≠—Ç–∞–ø 1.1 (get-comments) ‚Äî –¥–ª—è –æ–±—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- `bulk-update-issues.tool.ts` ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è batch –æ–ø–µ—Ä–∞—Ü–∏–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
