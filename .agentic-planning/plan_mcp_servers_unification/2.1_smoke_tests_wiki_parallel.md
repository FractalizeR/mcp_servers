# Этап 2.1: Smoke тесты для Yandex Wiki (parallel)

**Время:** ~2-3 часа
**Зависимости:** Этап 1 (снижение порогов)
**Параллельно с:** 2.2 (TickTick smoke тесты)

---

## Задача

Добавить 4 недостающих smoke теста в yandex-wiki:
1. `di-container.smoke.test.ts`
2. `definition-generation.smoke.test.ts`
3. `e2e-tool-execution.smoke.test.ts`
4. `tool-search.smoke.test.ts`

---

## Чеклист

### Подготовка
- [x] Создать `tests/helpers/schema-definition-matcher.ts`
- [x] Убедиться что `tests/helpers/mock-factories.ts` достаточен

### Smoke тесты
- [x] Создать `di-container.smoke.test.ts`
- [x] Создать `definition-generation.smoke.test.ts`
- [x] Создать `e2e-tool-execution.smoke.test.ts`
- [x] Создать `tool-search.smoke.test.ts`

### Валидация
- [x] `npm run test:smoke` проходит
- [x] Все 5 smoke тестов зелёные

---

## Источники для копирования

**Из yandex-tracker:**
- `tests/smoke/di-container.smoke.test.ts`
- `tests/smoke/definition-generation.smoke.test.ts`
- `tests/smoke/e2e-tool-execution.smoke.test.ts`
- `tests/smoke/tool-search.smoke.test.ts`
- `tests/helpers/schema-definition-matcher.ts`

---

## Адаптации для Wiki

### 1. Замены импортов

```typescript
// Было (tracker):
import { YandexTrackerFacade } from '#tracker_api/facade/yandex-tracker.facade.js';
import type { ServerConfig } from '#config';

// Стало (wiki):
import { YandexWikiFacade } from '#wiki_api/facade/yandex-wiki.facade.js';
import type { ServerConfig } from '#config';
```

### 2. Замены конфигурации

```typescript
// Было (tracker):
const fakeConfig: ServerConfig = {
  token: 'fake-test-token',
  orgId: 'fake-test-org',
  apiBase: 'https://api.tracker.yandex.net',
  // ...
  essentialTools: ['fr_yandex_tracker_ping'],
};

// Стало (wiki):
const fakeConfig: ServerConfig = {
  token: 'OAuth fake-token-for-testing',
  orgId: 'fake-org-id',
  apiBase: 'https://api.wiki.yandex.net',
  // ...
  essentialTools: ['yw_ping'],
};
```

### 3. Замены tool names

```typescript
// Было (tracker):
'fr_yandex_tracker_ping'
'search_tools'

// Стало (wiki):
'yw_ping'
'yw_search_tools'
```

### 4. Замены Facade type

```typescript
// Было (tracker):
import type { YandexTrackerFacade } from '#tracker_api/facade/yandex-tracker.facade.js';
let mockFacade: YandexTrackerFacade;

// Стало (wiki):
import type { YandexWikiFacade } from '#wiki_api/facade/yandex-wiki.facade.js';
let mockFacade: YandexWikiFacade;
```

---

## schema-definition-matcher.ts

Скопировать из tracker и адаптировать:

```typescript
/**
 * Валидация автогенерированных MCP Definition из Zod Schema
 */
export function validateGeneratedDefinition(inputSchema: {
  type?: string;
  properties?: Record<string, unknown>;
  required?: string[];
}): void {
  // Проверяем базовую структуру
  expect(inputSchema).toBeDefined();

  // type должен быть 'object' для корневой схемы
  if (inputSchema.type) {
    expect(inputSchema.type).toBe('object');
  }

  // properties должны быть объектом
  if (inputSchema.properties) {
    expect(typeof inputSchema.properties).toBe('object');
    expect(inputSchema.properties).not.toBeNull();
  }

  // required должен быть массивом строк
  if (inputSchema.required) {
    expect(Array.isArray(inputSchema.required)).toBe(true);
    inputSchema.required.forEach((field) => {
      expect(typeof field).toBe('string');
    });
  }
}
```

---

## Валидация

```bash
cd packages/servers/yandex-wiki

# Запуск всех smoke тестов
npm run test:smoke

# Ожидаемый результат:
# ✓ tests/smoke/mcp-server-lifecycle.smoke.test.ts
# ✓ tests/smoke/di-container.smoke.test.ts
# ✓ tests/smoke/definition-generation.smoke.test.ts
# ✓ tests/smoke/e2e-tool-execution.smoke.test.ts
# ✓ tests/smoke/tool-search.smoke.test.ts
```

---

## Коммит

```
test(wiki): добавить недостающие smoke тесты

Добавлены 4 smoke теста:
- di-container.smoke.test.ts - проверка DI контейнера
- definition-generation.smoke.test.ts - валидация MCP definitions
- e2e-tool-execution.smoke.test.ts - E2E выполнение tool
- tool-search.smoke.test.ts - поиск инструментов

Добавлен helper:
- tests/helpers/schema-definition-matcher.ts
```
