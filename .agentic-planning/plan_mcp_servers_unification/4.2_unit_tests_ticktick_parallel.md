# Этап 4.2: Unit тесты для TickTick (parallel)

**Время:** ~6-8 часов
**Зависимости:** Этап 3.2 (скрипты ticktick)
**Параллельно с:** 4.1 (Wiki unit тесты)

---

## Текущее состояние

| Метрика | Текущее | Целевое | Разница |
|---------|---------|---------|---------|
| Lines | 37.15% → 68% | 80% | Прогресс +31% |
| Functions | 43.5% → 70.5% | 80% | Прогресс +27% |
| Branches | 9.4% → 31% | 75% | Прогресс +22% |
| Statements | 35.91% → 66% | 80% | Прогресс +30% |

**Примечание:** TickTick требует больше работы чем Wiki!

---

## Задача

Добавить unit тесты для достижения 80% покрытия.

---

## Приоритеты тестирования

### Высокий приоритет (много логики)

1. **Operations** (~40% от недостающего покрытия)
   - `ticktick_api/api_operations/tasks/*.operation.ts`
   - `ticktick_api/api_operations/projects/*.operation.ts`

2. **Tools execute методы** (~35% от недостающего покрытия)
   - `tools/tasks/*.tool.ts` (11 tools!)
   - `tools/api/projects/*.tool.ts` (6 tools)
   - `tools/api/date-queries/*.tool.ts` (5 tools)

### Средний приоритет

3. **Facade** (~15% от недостающего покрытия)
   - `ticktick_api/facade/ticktick.facade.ts`

4. **Auth** (~5% от недостающего покрытия)
   - `ticktick_api/auth/oauth-client.ts` (уже есть базовый тест)

### Низкий приоритет

5. **HTTP клиент** (~5% от недостающего покрытия)
   - `ticktick_api/http/authenticated-http-client.ts`

---

## Чеклист

### Operations (Высокий приоритет)
- [ ] `tests/unit/ticktick_api/api_operations/tasks/create-task.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/tasks/update-task.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/tasks/delete-task.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/tasks/complete-task.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/tasks/get-tasks.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/projects/get-project.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/projects/get-projects.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/projects/create-project.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/projects/update-project.operation.test.ts`
- [ ] `tests/unit/ticktick_api/api_operations/projects/delete-project.operation.test.ts`

### Tools - Tasks (Высокий приоритет)
- [ ] `tests/unit/tools/tasks/create-task.tool.test.ts`
- [ ] `tests/unit/tools/tasks/update-task.tool.test.ts`
- [ ] `tests/unit/tools/tasks/delete-task.tool.test.ts`
- [ ] `tests/unit/tools/tasks/complete-task.tool.test.ts`
- [ ] `tests/unit/tools/tasks/get-tasks.tool.test.ts`
- [ ] `tests/unit/tools/tasks/get-all-tasks.tool.test.ts`
- [ ] `tests/unit/tools/tasks/search-tasks.tool.test.ts`
- [ ] `tests/unit/tools/tasks/get-tasks-by-priority.tool.test.ts`
- [ ] `tests/unit/tools/tasks/batch-create-tasks.tool.test.ts`

### Tools - Projects (Высокий приоритет)
- [ ] `tests/unit/tools/api/projects/get-project.tool.test.ts`
- [ ] `tests/unit/tools/api/projects/get-projects.tool.test.ts`
- [ ] `tests/unit/tools/api/projects/create-project.tool.test.ts`
- [ ] `tests/unit/tools/api/projects/update-project.tool.test.ts`
- [ ] `tests/unit/tools/api/projects/delete-project.tool.test.ts`
- [ ] `tests/unit/tools/api/projects/get-project-tasks.tool.test.ts`

### Tools - Date Queries (Высокий приоритет)
- [ ] `tests/unit/tools/api/date-queries/get-tasks-due-today.tool.test.ts`
- [ ] `tests/unit/tools/api/date-queries/get-tasks-due-tomorrow.tool.test.ts`
- [ ] `tests/unit/tools/api/date-queries/get-tasks-due-this-week.tool.test.ts`
- [ ] `tests/unit/tools/api/date-queries/get-tasks-due-in-days.tool.test.ts`
- [ ] `tests/unit/tools/api/date-queries/get-overdue-tasks.tool.test.ts`

### Facade (Средний приоритет)
- [ ] `tests/unit/ticktick_api/facade/ticktick.facade.test.ts` (расширить существующий)

### HTTP клиент (Низкий приоритет)
- [ ] `tests/unit/ticktick_api/http/authenticated-http-client.test.ts`

---

## Особенности TickTick

### 1. OAuth авторизация

```typescript
// В тестах нужно мокать AuthenticatedHttpClient
const mockHttpClient = {
  get: vi.fn(),
  post: vi.fn(),
  patch: vi.fn(),
  delete: vi.fn(),
  // OAuth-специфичные методы если есть
} as unknown as AuthenticatedHttpClient;
```

### 2. Вложенная конфигурация

```typescript
// Для создания facade нужна полная конфигурация
const mockConfig: ServerConfig = {
  oauth: { /* ... */ },
  api: { /* ... */ },
  batch: { /* ... */ },
  // ...
};
```

### 3. Date-based tools

```typescript
// Для date queries нужно мокать текущую дату
vi.useFakeTimers();
vi.setSystemTime(new Date('2025-12-09'));
// ... тест
vi.useRealTimers();
```

---

## Шаблон теста для Task Tool

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { CreateTaskTool } from '#tools/tasks/create-task/create-task.tool.js';
import type { TickTickFacade } from '#ticktick_api/facade/ticktick.facade.js';
import type { Logger } from '@mcp-framework/infrastructure';

describe('CreateTaskTool', () => {
  let tool: CreateTaskTool;
  let mockFacade: TickTickFacade;
  let mockLogger: Logger;

  beforeEach(() => {
    mockFacade = {
      createTask: vi.fn(),
      // ... другие методы
    } as unknown as TickTickFacade;

    mockLogger = {
      debug: vi.fn(),
      info: vi.fn(),
      warn: vi.fn(),
      error: vi.fn(),
      child: vi.fn(() => mockLogger),
    } as unknown as Logger;

    tool = new CreateTaskTool(mockFacade, mockLogger);
  });

  it('должен вернуть definition', () => {
    const definition = tool.getDefinition();
    expect(definition.name).toBe('fr_ticktick_create_task');
    expect(definition.description).toBeDefined();
  });

  it('должен создать задачу', async () => {
    // Arrange
    const mockTask = { id: '123', title: 'New Task' };
    vi.mocked(mockFacade.createTask).mockResolvedValue(mockTask);

    // Act
    const result = await tool.execute({
      title: 'New Task',
      projectId: 'project-123',
    });

    // Assert
    expect(result.content[0].type).toBe('text');
    expect(mockFacade.createTask).toHaveBeenCalled();
  });

  it('должен валидировать параметры', async () => {
    // Act - нет title
    const result = await tool.execute({ projectId: '123' });

    // Assert
    expect(result.isError).toBe(true);
  });
});
```

---

## Шаблон теста для Date Query Tool

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { GetTasksDueTodayTool } from '#tools/api/date-queries/get-tasks-due-today/get-tasks-due-today.tool.js';
import type { TickTickFacade } from '#ticktick_api/facade/ticktick.facade.js';
import type { Logger } from '@mcp-framework/infrastructure';

describe('GetTasksDueTodayTool', () => {
  let tool: GetTasksDueTodayTool;
  let mockFacade: TickTickFacade;
  let mockLogger: Logger;

  beforeEach(() => {
    // Фиксируем дату для тестов
    vi.useFakeTimers();
    vi.setSystemTime(new Date('2025-12-09T10:00:00Z'));

    mockFacade = {
      getTasksDueToday: vi.fn(),
    } as unknown as TickTickFacade;

    mockLogger = {
      debug: vi.fn(),
      info: vi.fn(),
      warn: vi.fn(),
      error: vi.fn(),
      child: vi.fn(() => mockLogger),
    } as unknown as Logger;

    tool = new GetTasksDueTodayTool(mockFacade, mockLogger);
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  it('должен вернуть задачи на сегодня', async () => {
    // Arrange
    const mockTasks = [
      { id: '1', title: 'Task 1', dueDate: '2025-12-09' },
      { id: '2', title: 'Task 2', dueDate: '2025-12-09' },
    ];
    vi.mocked(mockFacade.getTasksDueToday).mockResolvedValue(mockTasks);

    // Act
    const result = await tool.execute({});

    // Assert
    expect(result.content[0].type).toBe('text');
    expect(mockFacade.getTasksDueToday).toHaveBeenCalled();
  });
});
```

---

## Валидация

```bash
cd packages/servers/ticktick

# Запуск тестов с покрытием
npm run test:coverage

# Ожидаемый результат:
# Lines: ≥80%
# Functions: ≥80%
# Branches: ≥75%
# Statements: ≥80%
```

---

## Коммит

```
test(ticktick): добавить unit тесты для достижения 80% покрытия

Добавлены тесты:
- Operations: tasks, projects
- Tools: tasks (11), projects (6), date-queries (5)
- Facade: ticktick.facade

Покрытие:
- Lines: X% → 80%+
- Functions: X% → 80%+
- Branches: X% → 75%+
```
