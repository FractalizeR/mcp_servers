# Этап 2.2: Smoke тесты для TickTick (parallel)

**Время:** ~2-3 часа
**Зависимости:** Этап 1 (снижение порогов)
**Параллельно с:** 2.1 (Wiki smoke тесты)

---

## Задача

Добавить 3 недостающих smoke теста в ticktick:
1. `definition-generation.smoke.test.ts`
2. `e2e-tool-execution.smoke.test.ts`
3. `tool-search.smoke.test.ts`

**Примечание:** `di-container.smoke.test.ts` уже существует.

---

## Чеклист

### Подготовка
- [ ] Создать `tests/helpers/schema-definition-matcher.ts`
- [ ] Проверить `tests/helpers/mock-factories.ts`

### Smoke тесты
- [ ] Создать `definition-generation.smoke.test.ts`
- [ ] Создать `e2e-tool-execution.smoke.test.ts`
- [ ] Создать `tool-search.smoke.test.ts`

### Валидация
- [ ] `npm run test:smoke` проходит
- [ ] Все 5 smoke тестов зелёные

---

## Источники для копирования

**Из yandex-tracker:**
- `tests/smoke/definition-generation.smoke.test.ts`
- `tests/smoke/e2e-tool-execution.smoke.test.ts`
- `tests/smoke/tool-search.smoke.test.ts`
- `tests/helpers/schema-definition-matcher.ts`

---

## Адаптации для TickTick

### 1. Замены импортов

```typescript
// Было (tracker):
import { YandexTrackerFacade } from '#tracker_api/facade/yandex-tracker.facade.js';
import type { ServerConfig } from '#config';

// Стало (ticktick):
import { TickTickFacade } from '#ticktick_api/facade/ticktick.facade.js';
import type { ServerConfig } from '#config';
```

### 2. Замены конфигурации

```typescript
// Было (tracker):
const fakeConfig: ServerConfig = {
  token: 'fake-test-token',
  orgId: 'fake-test-org',
  apiBase: 'https://api.tracker.yandex.net',
  requestTimeout: 30000,
  maxBatchSize: 50,
  maxConcurrentRequests: 10,
  logLevel: 'error',
  prettyLogs: false,
  toolDiscoveryMode: 'lazy',
  essentialTools: ['fr_yandex_tracker_ping'],
};

// Стало (ticktick):
// ВАЖНО: TickTick использует вложенную структуру конфигурации!
const fakeConfig: ServerConfig = {
  oauth: {
    clientId: 'fake-client-id',
    clientSecret: 'fake-client-secret',
    redirectUri: 'http://localhost:3000/callback',
  },
  api: {
    baseUrl: 'https://api.ticktick.com/open/v1',
    timeout: 30000,
  },
  batch: {
    maxBatchSize: 50,
    maxConcurrentRequests: 10,
  },
  tools: {
    discoveryMode: 'lazy',
    essentialTools: ['fr_ticktick_ping'],
  },
  logging: {
    level: 'error',
    prettyPrint: false,
  },
};
```

### 3. Замены tool names

```typescript
// Было (tracker):
'fr_yandex_tracker_ping'
'search_tools'

// Стало (ticktick):
'fr_ticktick_ping'
'search_tools'  // или 'fr_ticktick_search_tools' - проверить!
```

### 4. Замены Facade type

```typescript
// Было (tracker):
import type { YandexTrackerFacade } from '#tracker_api/facade/yandex-tracker.facade.js';
let mockFacade: YandexTrackerFacade;

// Стало (ticktick):
import type { TickTickFacade } from '#ticktick_api/facade/ticktick.facade.js';
let mockFacade: TickTickFacade;
```

### 5. Особенности TickTick

**OAuth конфигурация:**
```typescript
// TickTick требует OAuth, но для smoke тестов используем fake токен
// через TICKTICK_ACCESS_TOKEN environment variable
```

**OPERATION_DEFINITIONS vs OPERATION_CLASSES:**
```typescript
// TickTick использует OPERATION_DEFINITIONS вместо OPERATION_CLASSES
// В definition-generation тесте нужно адаптировать импорты
import { TOOL_CLASSES } from '#composition-root/definitions/tool-definitions.js';
// OPERATION_DEFINITIONS не нужны для smoke тестов tools
```

---

## schema-definition-matcher.ts

Такой же как для Wiki:

```typescript
/**
 * Валидация автогенерированных MCP Definition из Zod Schema
 */
export function validateGeneratedDefinition(inputSchema: {
  type?: string;
  properties?: Record<string, unknown>;
  required?: string[];
}): void {
  expect(inputSchema).toBeDefined();

  if (inputSchema.type) {
    expect(inputSchema.type).toBe('object');
  }

  if (inputSchema.properties) {
    expect(typeof inputSchema.properties).toBe('object');
    expect(inputSchema.properties).not.toBeNull();
  }

  if (inputSchema.required) {
    expect(Array.isArray(inputSchema.required)).toBe(true);
    inputSchema.required.forEach((field) => {
      expect(typeof field).toBe('string');
    });
  }
}
```

---

## Важные отличия TickTick

1. **Вложенная конфигурация** - ServerConfig имеет вложенную структуру
2. **OAuth авторизация** - требует clientId, clientSecret, redirectUri
3. **OPERATION_DEFINITIONS** - вместо OPERATION_CLASSES
4. **AuthenticatedHttpClient** - свой HTTP клиент вместо AxiosHttpClient

---

## Валидация

```bash
cd packages/servers/ticktick

# Запуск всех smoke тестов
npm run test:smoke

# Ожидаемый результат:
# ✓ tests/smoke/mcp-server-lifecycle.smoke.test.ts
# ✓ tests/smoke/di-container.smoke.test.ts
# ✓ tests/smoke/definition-generation.smoke.test.ts
# ✓ tests/smoke/e2e-tool-execution.smoke.test.ts
# ✓ tests/smoke/tool-search.smoke.test.ts
```

---

## Коммит

```
test(ticktick): добавить недостающие smoke тесты

Добавлены 3 smoke теста:
- definition-generation.smoke.test.ts - валидация MCP definitions
- e2e-tool-execution.smoke.test.ts - E2E выполнение tool
- tool-search.smoke.test.ts - поиск инструментов

Добавлен helper:
- tests/helpers/schema-definition-matcher.ts
```
