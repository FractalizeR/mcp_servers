# Этап 4.1: Unit тесты для Yandex Wiki (parallel)

**Время:** ~4-6 часов
**Зависимости:** Этап 3.1 (скрипты wiki)
**Параллельно с:** 4.2 (TickTick unit тесты)

---

## Текущее состояние

| Метрика | Текущее | Целевое | Разница |
|---------|---------|---------|---------|
| Lines | 51.09% | 80% | +28.91% |
| Functions | 56.2% | 80% | +23.8% |
| Branches | 16.6% | 75% | +58.4% |
| Statements | 51.44% | 80% | +28.56% |

---

## Задача

Добавить unit тесты для достижения 80% покрытия.

---

## Приоритеты тестирования

### Высокий приоритет (много логики)

1. **Operations** (~40% от недостающего покрытия)
   - `wiki_api/api_operations/page/*.operation.ts`
   - `wiki_api/api_operations/grid/*.operation.ts`
   - `wiki_api/api_operations/resource/*.operation.ts`

2. **Tools execute методы** (~30% от недостающего покрытия)
   - `tools/api/pages/*.tool.ts`
   - `tools/api/grids/*.tool.ts`
   - `tools/api/resources/*.tool.ts`

### Средний приоритет

3. **Facade** (~15% от недостающего покрытия)
   - `wiki_api/facade/yandex-wiki.facade.ts` (20% покрыто!)
   - `wiki_api/facade/services/*.service.ts`

### Низкий приоритет

4. **Config** (~5% от недостающего покрытия)
   - `config/config-loader.ts`

5. **Schemas** (~10% от недостающего покрытия)
   - Валидация Zod схем

---

## Чеклист

### Operations (Высокий приоритет)
- [ ] `tests/unit/wiki_api/api_operations/page/update-page.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/page/append-content.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/create-grid.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/update-grid.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/delete-grid.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/clone-grid.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/rows/*.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/columns/*.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/grid/cells/*.operation.test.ts`
- [ ] `tests/unit/wiki_api/api_operations/resource/get-resources.operation.test.ts`

### Tools (Высокий приоритет)
- [ ] `tests/unit/tools/api/pages/update-page.tool.test.ts`
- [ ] `tests/unit/tools/api/pages/create-page.tool.test.ts`
- [ ] `tests/unit/tools/api/pages/delete-page.tool.test.ts`
- [ ] `tests/unit/tools/api/pages/clone-page.tool.test.ts`
- [ ] `tests/unit/tools/api/pages/append-content.tool.test.ts`
- [ ] `tests/unit/tools/api/grids/*.tool.test.ts` (все grid tools)
- [ ] `tests/unit/tools/api/resources/get-resources.tool.test.ts`

### Facade (Средний приоритет)
- [ ] `tests/unit/wiki_api/facade/yandex-wiki.facade.test.ts`
- [ ] Расширить существующие тесты services

### Config (Низкий приоритет)
- [ ] `tests/unit/config/config-loader.test.ts`

---

## Шаблон теста для Operation

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { UpdatePageOperation } from '#wiki_api/api_operations/page/update-page.operation.js';
import type { IHttpClient } from '@mcp-framework/infrastructure/http/client/i-http-client.interface.js';
import type { Logger } from '@mcp-framework/infrastructure';

describe('UpdatePageOperation', () => {
  let operation: UpdatePageOperation;
  let mockHttpClient: IHttpClient;
  let mockLogger: Logger;

  beforeEach(() => {
    mockHttpClient = {
      get: vi.fn(),
      post: vi.fn(),
      patch: vi.fn(),
      put: vi.fn(),
      delete: vi.fn(),
    } as unknown as IHttpClient;

    mockLogger = {
      debug: vi.fn(),
      info: vi.fn(),
      warn: vi.fn(),
      error: vi.fn(),
      child: vi.fn(() => mockLogger),
    } as unknown as Logger;

    operation = new UpdatePageOperation(mockHttpClient, mockLogger);
  });

  it('должен обновить страницу', async () => {
    // Arrange
    const mockResponse = { id: '123', title: 'Updated' };
    vi.mocked(mockHttpClient.patch).mockResolvedValue(mockResponse);

    // Act
    const result = await operation.execute('123', { title: 'Updated' });

    // Assert
    expect(result).toEqual(mockResponse);
    expect(mockHttpClient.patch).toHaveBeenCalledWith(
      expect.stringContaining('/pages/123'),
      expect.any(Object)
    );
  });

  it('должен логировать ошибки', async () => {
    // Arrange
    const error = new Error('API Error');
    vi.mocked(mockHttpClient.patch).mockRejectedValue(error);

    // Act & Assert
    await expect(operation.execute('123', {})).rejects.toThrow('API Error');
    expect(mockLogger.error).toHaveBeenCalled();
  });
});
```

---

## Шаблон теста для Tool

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { UpdatePageTool } from '#tools/api/pages/update/update-page.tool.js';
import type { YandexWikiFacade } from '#wiki_api/facade/yandex-wiki.facade.js';
import type { Logger } from '@mcp-framework/infrastructure';

describe('UpdatePageTool', () => {
  let tool: UpdatePageTool;
  let mockFacade: YandexWikiFacade;
  let mockLogger: Logger;

  beforeEach(() => {
    mockFacade = {
      pages: {
        update: vi.fn(),
      },
    } as unknown as YandexWikiFacade;

    mockLogger = {
      debug: vi.fn(),
      info: vi.fn(),
      warn: vi.fn(),
      error: vi.fn(),
      child: vi.fn(() => mockLogger),
    } as unknown as Logger;

    tool = new UpdatePageTool(mockFacade, mockLogger);
  });

  it('должен вернуть definition', () => {
    const definition = tool.getDefinition();
    expect(definition.name).toBe('yw_update_page');
    expect(definition.description).toBeDefined();
  });

  it('должен выполнить обновление страницы', async () => {
    // Arrange
    const mockResult = { id: '123', title: 'Updated' };
    vi.mocked(mockFacade.pages.update).mockResolvedValue(mockResult);

    // Act
    const result = await tool.execute({
      pageId: '123',
      title: 'Updated',
    });

    // Assert
    expect(result.content[0].type).toBe('text');
    expect(mockFacade.pages.update).toHaveBeenCalledWith('123', { title: 'Updated' });
  });

  it('должен валидировать параметры', async () => {
    // Act
    const result = await tool.execute({});  // Нет pageId

    // Assert
    expect(result.isError).toBe(true);
  });
});
```

---

## Валидация

```bash
cd packages/servers/yandex-wiki

# Запуск тестов с покрытием
npm run test:coverage

# Ожидаемый результат:
# Lines: ≥80%
# Functions: ≥80%
# Branches: ≥75%
# Statements: ≥80%
```

---

## Коммит

```
test(wiki): добавить unit тесты для достижения 80% покрытия

Добавлены тесты:
- Operations: page, grid, resource
- Tools: pages, grids, resources
- Facade: yandex-wiki.facade

Покрытие:
- Lines: X% → 80%+
- Functions: X% → 80%+
- Branches: X% → 75%+
```
