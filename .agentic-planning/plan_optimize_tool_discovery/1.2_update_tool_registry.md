# Этап 1.2: Обновить ToolRegistry для сортировки по приоритету

**Цель:** Добавить сортировку инструментов по priority в ToolRegistry

**Затронутые пакеты:** `@mcp-framework/core`

**Время:** 1 час

**Зависимости:** Требует завершения этапа 1.1

---

## Чек-лист задач

### 1. Добавить метод сортировки

**Файл:** `packages/framework/core/src/tool-registry.ts`

- [ ] Добавить приватный метод `sortByPriority(tools: BaseTool[]): BaseTool[]`
- [ ] Реализовать логику сортировки: `critical → high → normal → low`
- [ ] Вторичная сортировка по алфавиту (name) для стабильности

**Пример:**
```typescript
private sortByPriority(tools: BaseTool[]): BaseTool[] {
  const priorityOrder = { critical: 0, high: 1, normal: 2, low: 3 };

  return tools.sort((a, b) => {
    const aPrio = priorityOrder[a.getDefinition().priority || 'normal'];
    const bPrio = priorityOrder[b.getDefinition().priority || 'normal'];

    // Сначала по priority
    if (aPrio !== bPrio) {
      return aPrio - bPrio;
    }

    // Затем по имени (алфавит)
    return a.getDefinition().name.localeCompare(b.getDefinition().name);
  });
}
```

### 2. Использовать сортировку в методах

**Файл:** `packages/framework/core/src/tool-registry.ts`

- [ ] Обновить `getDefinitions()` — применить `sortByPriority` перед возвратом
- [ ] Обновить `getEssentialDefinitions()` — применить `sortByPriority`
- [ ] Обновить `getDefinitionsByMode()` — использовать отсортированные данные

**Важно:** Сортировка должна происходить ПОСЛЕ фильтрации (lazy/eager), но ПЕРЕД возвратом.

### 3. Добавить логирование

**Файл:** `packages/framework/core/src/tool-registry.ts`

- [ ] Логировать порядок инструментов после сортировки (debug level)
- [ ] Показывать распределение по priority

**Пример:**
```typescript
this.logger.debug('Tools sorted by priority', {
  critical: sorted.filter(t => t.getDefinition().priority === 'critical').length,
  high: sorted.filter(t => t.getDefinition().priority === 'high').length,
  normal: sorted.filter(t => t.getDefinition().priority === 'normal').length,
  low: sorted.filter(t => t.getDefinition().priority === 'low').length,
});
```

### 4. Тесты

**Файл:** `packages/servers/yandex-tracker/tests/tool-registry.test.ts`

- [ ] Тест: инструменты отсортированы по priority (critical первые)
- [ ] Тест: в рамках одного priority — алфавитная сортировка
- [ ] Тест: undefined priority трактуется как 'normal'
- [ ] Тест: сортировка работает в eager mode
- [ ] Тест: сортировка работает в lazy mode

### 5. Валидация

- [ ] Запустить `npm run test --workspace=@mcp-framework/core`
- [ ] Запустить `npm run typecheck --workspace=@mcp-framework/core`
- [ ] Все тесты проходят

---

## Ожидаемый результат

✅ ToolRegistry сортирует инструменты по priority
✅ Порядок: critical → high → normal → low → алфавит
✅ Логирование распределения по приоритетам
✅ Тесты покрывают сортировку
✅ Все тесты проходят

---

## Следующий этап

→ **2.1_update_issues_tools.md** и **2.2_update_helper_tools.md** (можно параллельно)
