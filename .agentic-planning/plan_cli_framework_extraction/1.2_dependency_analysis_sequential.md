# 1.2 Анализ зависимостей

**Тип:** Sequential
**Зависимости:** 1.1 Инвентаризация
**Время:** ~30 минут

---

## Задача

Проанализировать граф зависимостей для нового пакета `@mcp-framework/cli` и убедиться, что он не нарушит существующую архитектуру monorepo.

---

## Действия

### 1. Определить место CLI в графе зависимостей

**Текущий граф:**
```
infrastructure (0 deps)
    ↓
core (deps: infrastructure)
    ↓
search (deps: core)
    ↓
yandex-tracker (deps: infrastructure, core, search)
```

**Вопросы:**
- Где должен быть CLI в этом графе?
- От каких framework пакетов он может зависеть?
- Кто может зависеть от CLI?

**Рекомендация:**
```
infrastructure (0 deps)
    ↓
    ├─→ core (deps: infrastructure)
    │      ↓
    │   search (deps: core)
    │
    └─→ cli (deps: infrastructure)  ← новый пакет
            ↓
     yandex-tracker (deps: infrastructure, core, search, cli)
```

### 2. Проверить импорты в текущем CLI

**Найти все импорты из других частей yandex-tracker:**
```bash
cd packages/servers/yandex-tracker/src/cli
grep -r "from '#" .
grep -r "from '@mcp-framework" .
```

**Классифицировать:**
- Импорты из `#constants` — нужно параметризовать
- Импорты из `#common` — могут быть перенесены в infrastructure
- Импорты из framework пакетов — ок

### 3. Создать dependency map

**Для каждого CLI компонента определить:**
- Что он импортирует из yandex-tracker?
- Что он импортирует из framework?
- Что он импортирует из node_modules?

**Формат:**
```markdown
### connectors/base/connector.interface.ts
- ❌ YT imports: нет
- ✅ Framework imports: нет
- ✅ Node imports: нет
- **Вердикт:** Готов к выносу

### utils/config-manager.ts
- ❌ YT imports: `#constants` (PROJECT_BASE_NAME)
- ✅ Framework imports: нет
- ✅ Node imports: path, fs
- **Вердикт:** Требует параметризации
```

### 4. Проверить обратные зависимости

**Найти все места в yandex-tracker, которые используют CLI:**
```bash
cd packages/servers/yandex-tracker/src
grep -r "from.*cli" . --exclude-dir=cli
```

**Вопросы:**
- Кто импортирует что-то из CLI?
- Как это повлияет на миграцию?

### 5. Проверить dependency-cruiser правила

**Файл:** `.dependency-cruiser.cjs`

**Вопросы:**
- Нужно ли обновить правила для нового пакета?
- Какие ограничения должны быть для CLI?

**Ожидаемые правила:**
```javascript
{
  name: 'cli-can-only-depend-on-infrastructure',
  from: { path: '^packages/framework/cli' },
  to: {
    path: '^packages/framework',
    pathNot: '^packages/framework/infrastructure'
  },
  severity: 'error'
}
```

---

## Результат

**Создать файл:** `DEPENDENCY_MAP.md` в корне плана

**Содержание:**
1. Граф зависимостей с новым CLI пакетом
2. Dependency map для каждого CLI компонента
3. Список проблемных зависимостей для рефакторинга
4. Предложения по обновлению dependency-cruiser правил

---

## Критерии готовности

- [x] Определено место CLI в графе зависимостей
- [x] Все импорты в CLI проанализированы
- [x] Идентифицированы проблемные зависимости
- [x] Проверены обратные зависимости
- [x] Предложены правила для dependency-cruiser
- [x] Документ `DEPENDENCY_MAP.md` создан

---

## ✅ Статус: ЗАВЕРШЕНО

**Дата завершения:** 2025-11-22
**Результат:** [DEPENDENCY_MAP.md](./DEPENDENCY_MAP.md)

**Ключевые находки:**
- CLI полностью изолирован (нет обратных зависимостей)
- Граф валиден: CLI параллельно core/search, зависит только от infrastructure
- Проблемные зависимости: 8 констант + isError (все параметризуемо)
- Dependency-cruiser требует 4 обновления правил
- Риски минимальны - чистая архитектура
