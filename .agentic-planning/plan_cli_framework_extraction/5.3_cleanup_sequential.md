# 5.3 Cleanup дублирующегося кода (после feature flags)

**Тип:** Sequential
**Зависимости:** 5.5 Feature Flags ⚠️ ИЗМЕНЕНО
**Время:** ~20 минут
**Критичность:** НИЗКАЯ — можно отложить

---

## ⚠️ ВАЖНОЕ ИЗМЕНЕНИЕ

**Этот этап теперь НЕ критичен** и может быть выполнен позже (после полного тестирования новой версии).

**Старый подход:** Удалить legacy код сразу после миграции
**Новый подход:** Сохранить legacy код для возможности отката (этап 5.5)

---

## Задача

Минимальная cleanup — удалить только дублирующийся код, который точно не нужен. Legacy CLI код НЕ трогаем (он в `cli-legacy/`).

---

## Что МОЖНО удалить безопасно

### 1. Временные файлы миграции

Если были созданы временные файлы для тестирования миграции:

```bash
# Удалить временные тестовые файлы
rm -f packages/servers/yandex-tracker/src/cli/*.tmp.ts
rm -f packages/servers/yandex-tracker/src/cli/*.backup.ts
```

### 2. Неиспользуемые imports

Проверить в `bin/mcp-connect-framework.ts` что нет неиспользуемых импортов:

```bash
cd packages/servers/yandex-tracker
npm run lint
```

### 3. Закомментированный код

Если в процессе миграции остался закомментированный код — удалить:

```typescript
// ❌ Удалить
// const oldRegistry = new OldRegistry();
// oldRegistry.register(...);

// ✅ Оставить только рабочий код
const registry = new ConnectorRegistry();
```

---

## Что НЕ ТРОГАЕМ

### ❌ НЕ удалять `cli-legacy/`

**Причина:** Нужен для rollback (этап 5.5)

**Когда удалять:** Только после 2-4 недель успешной работы новой версии (этап 8.1)

### ❌ НЕ удалять feature flags

**Причина:** Используются для переключения между версиями

**Когда удалять:** Вместе с legacy кодом (этап 8.1)

---

## Действия (минимальные)

### 1. Удалить временные файлы

```bash
cd packages/servers/yandex-tracker

# Найти временные файлы
find src/cli -name "*.tmp.ts" -o -name "*.backup.ts"

# Удалить если есть
find src/cli -name "*.tmp.ts" -delete
find src/cli -name "*.backup.ts" -delete
```

### 2. Проверить неиспользуемые импорты

```bash
npm run lint
```

**Если линтер находит unused imports** — удалить их.

### 3. Проверить структуру

**Ожидаемая структура:**
```
packages/servers/yandex-tracker/src/
├── cli/                          # новый CLI
│   ├── bin/
│   │   ├── mcp-connect.ts        (router с feature flag)
│   │   └── mcp-connect-framework.ts (новая логика)
│   ├── feature-flags.ts
│   ├── types.ts
│   ├── prompts.ts
│   └── README.md
└── cli-legacy/                   # старый CLI (НЕ ТРОГАТЬ!)
    ├── bin/mcp-connect.ts
    ├── connectors/
    ├── commands/
    └── utils/
```

### 4. Проверить размер кода

```bash
# Новый CLI (должен быть маленьким)
du -sh src/cli/
# Ожидаемо: ~50-100 KB (только типы, промпты, router)

# Legacy CLI (большой - нормально)
du -sh src/cli-legacy/
# Ожидаемо: ~500-700 KB (все коннекторы, команды, утилиты)
```

---

## Обновить README.md

**Файл:** `packages/servers/yandex-tracker/src/cli/README.md`

```markdown
# Yandex Tracker CLI

⚠️ **Migration in progress:** CLI использует `@mcp-framework/cli` с возможностью отката на legacy версию.

## Использование

```bash
# Новая версия (default)
npm run mcp:connect

# Legacy версия (если нужно)
USE_FRAMEWORK_CLI=false npm run mcp:connect
```

См. [MIGRATION_CLI.md](../../MIGRATION_CLI.md) для деталей.

## Конфигурация

Yandex Tracker требует:
- `token` — OAuth токен (секрет, не сохраняется)
- `orgId` — ID организации (сохраняется)
- `apiBase` — URL API (опционально)
- `logLevel` — Уровень логирования

Подробности: `src/cli/types.ts` и `src/cli/prompts.ts`

## Архитектура

Новый CLI построен на `@mcp-framework/cli`.

Документация: [packages/framework/cli/README.md](../../../framework/cli/README.md)
```

---

## Результат

- [ ] Временные файлы удалены
- [ ] Неиспользуемые imports удалены
- [ ] Legacy код СОХРАНЕН в `cli-legacy/`
- [ ] README обновлен с упоминанием миграции
- [ ] `npm run validate` проходит

---

## Критерии готовности

- [ ] Нет временных файлов
- [ ] Lint проходит без предупреждений
- [ ] Legacy CLI доступен для отката
- [ ] Структура чистая и понятная
- [ ] README отражает текущее состояние
