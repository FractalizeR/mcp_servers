# 5.5 Feature Flag Strategy –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥

**–¢–∏–ø:** Sequential
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 5.1 YT –∞–¥–∞–ø—Ç–µ—Ä
**–í—Ä–µ–º—è:** ~1 —á–∞—Å
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üö® –í–´–°–û–ö–ê–Ø ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ rollback

---

## –ó–∞–¥–∞—á–∞

–û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ framework/cli —á–µ—Ä–µ–∑ feature flags, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.

---

## –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ

**–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—Ä—è–º–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:**
- ‚ùå –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è ‚Äî –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å hotfix –∏ redeploy
- ‚ùå –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –±–µ–∑ revert –∫–æ–º–º–∏—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ feature flags:**
- ‚úÖ –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –¥–ª—è beta-—Ç–µ—Å—Ç–µ—Ä–æ–≤
- ‚úÖ –û—Ç–∫–∞—Ç –æ–¥–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout (0% ‚Üí 10% ‚Üí 50% ‚Üí 100%)

---

## –î–µ–π—Å—Ç–≤–∏—è

### 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π CLI –∫–æ–¥

**–í–ê–ñ–ù–û:** –ù–ï —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–∑ —ç—Ç–∞–ø–∞ 5.3!

–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:
```bash
cd packages/servers/yandex-tracker/src
mv cli cli-legacy
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:**
```
packages/servers/yandex-tracker/src/
‚îú‚îÄ‚îÄ cli/                    # –Ω–æ–≤—ã–π (framework-based)
‚îÇ   ‚îú‚îÄ‚îÄ bin/mcp-connect.ts
‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îî‚îÄ‚îÄ prompts.ts
‚îî‚îÄ‚îÄ cli-legacy/             # —Å—Ç–∞—Ä—ã–π (—Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è rollback)
    ‚îú‚îÄ‚îÄ connectors/
    ‚îú‚îÄ‚îÄ commands/
    ‚îî‚îÄ‚îÄ utils/
```

### 2. –°–æ–∑–¥–∞—Ç—å feature flag

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/cli/feature-flags.ts`

```typescript
/**
 * Feature flags –¥–ª—è CLI
 */

/**
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π framework-based CLI
 *
 * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:
 * - USE_FRAMEWORK_CLI=true - –Ω–æ–≤—ã–π CLI
 * - USE_FRAMEWORK_CLI=false - legacy CLI
 * - –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –Ω–æ–≤—ã–π CLI (default –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
 */
export const USE_FRAMEWORK_CLI = process.env.USE_FRAMEWORK_CLI !== 'false';

/**
 * –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
 */
export const DEBUG_CLI_MIGRATION = process.env.DEBUG_CLI_MIGRATION === 'true';
```

### 3. –û–±–Ω–æ–≤–∏—Ç—å bin/mcp-connect.ts —Å —É—Å–ª–æ–≤–∏–µ–º

**–§–∞–π–ª:** `packages/servers/yandex-tracker/src/cli/bin/mcp-connect.ts`

```typescript
#!/usr/bin/env node

import { USE_FRAMEWORK_CLI, DEBUG_CLI_MIGRATION } from '../feature-flags.js';

if (DEBUG_CLI_MIGRATION) {
  console.log(`[CLI Migration] USE_FRAMEWORK_CLI=${USE_FRAMEWORK_CLI}`);
}

if (USE_FRAMEWORK_CLI) {
  // –ù–æ–≤—ã–π framework-based CLI
  import('./mcp-connect-framework.js')
    .then(module => module.main())
    .catch(error => {
      console.error('[CLI Migration] Framework CLI failed, falling back to legacy');
      console.error(error);

      // Fallback –Ω–∞ legacy –ø—Ä–∏ –æ—à–∏–±–∫–µ
      import('../../cli-legacy/bin/mcp-connect.js')
        .then(module => module.main())
        .catch(legacyError => {
          console.error('[CLI Migration] Legacy CLI also failed');
          console.error(legacyError);
          process.exit(1);
        });
    });
} else {
  // Legacy CLI
  import('../../cli-legacy/bin/mcp-connect.js')
    .then(module => module.main())
    .catch(error => {
      console.error('CLI failed');
      console.error(error);
      process.exit(1);
    });
}
```

### 4. –†–∞–∑–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ —Ñ–∞–π–ª—ã

**–°–æ–∑–¥–∞—Ç—å:** `bin/mcp-connect-framework.ts` (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ —ç—Ç–∞–ø–∞ 5.1)

```typescript
import { program } from 'commander';
import {
  ConnectorRegistry,
  ConfigManager,
  InteractivePrompter,
  connectCommand,
  // ... –∏ —Ç.–¥.
} from '@mcp-framework/cli';

export async function main() {
  // –í—Å—è –ª–æ–≥–∏–∫–∞ –Ω–æ–≤–æ–≥–æ CLI –∑–¥–µ—Å—å
  // (–∫–æ–¥ –∏–∑ —ç—Ç–∞–ø–∞ 5.1)
}
```

**–û—Å—Ç–∞–≤–∏—Ç—å:** `cli-legacy/bin/mcp-connect.ts` (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)

### 5. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/integration/cli-migration.test.ts`

```typescript
import { describe, it, expect } from 'vitest';

describe('CLI Migration', () => {
  it('should use framework CLI when flag is true', async () => {
    process.env.USE_FRAMEWORK_CLI = 'true';
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç framework
  });

  it('should use legacy CLI when flag is false', async () => {
    process.env.USE_FRAMEWORK_CLI = 'false';
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç legacy
  });

  it('should fallback to legacy on framework error', async () => {
    // –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ framework CLI
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–∫–∞—Ç–∏–ª–æ—Å—å –Ω–∞ legacy
  });
});
```

### 6. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–§–∞–π–ª:** `packages/servers/yandex-tracker/MIGRATION_CLI.md` (–Ω–æ–≤—ã–π)

```markdown
# CLI Migration Guide

## –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

CLI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ framework.

**–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:**

```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
export USE_FRAMEWORK_CLI=false
npm run mcp:connect
```

## –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

```bash
USE_FRAMEWORK_CLI=true npm run mcp:connect
```

### –û—Ç–ª–∞–¥–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
DEBUG_CLI_MIGRATION=true npm run mcp:connect
```

### –û—Ç–∫–∞—Ç –Ω–∞ production

–ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

```bash
# –í production –æ–∫—Ä—É–∂–µ–Ω–∏–∏
export USE_FRAMEWORK_CLI=false

# –ò–ª–∏ —á–µ—Ä–µ–∑ CI/CD –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# –û–±–Ω–æ–≤–∏—Ç—å USE_FRAMEWORK_CLI=false –≤ –¥–µ–ø–ª–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

## Timeline

- **–ù–µ–¥–µ–ª—è 1:** USE_FRAMEWORK_CLI=true —Ç–æ–ª—å–∫–æ –≤ dev
- **–ù–µ–¥–µ–ª—è 2:** Beta —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ù–µ–¥–µ–ª—è 3:** 50% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ù–µ–¥–µ–ª—è 4:** 100% –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º
- **–ù–µ–¥–µ–ª—è 6:** –£–¥–∞–ª–∏—Ç—å legacy –∫–æ–¥ (—ç—Ç–∞–ø 8.1)
```

---

## –ü–ª–∞–Ω –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ rollout

### –ù–µ–¥–µ–ª—è 1: Dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```bash
# –í dev –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
USE_FRAMEWORK_CLI=true
DEBUG_CLI_MIGRATION=true
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ù–µ–¥–µ–ª—è 2: Beta –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```bash
# Beta –≥—Ä—É–ø–ø–∞ (10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
USE_FRAMEWORK_CLI=true
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
- –°–±–æ—Ä feedback
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ù–µ–¥–µ–ª—è 3: 50% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```bash
# Canary deployment
# 50% —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å USE_FRAMEWORK_CLI=true
# 50% —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å USE_FRAMEWORK_CLI=false
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (performance, errors)
- –†–µ—à–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏

### –ù–µ–¥–µ–ª—è 4: 100% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```bash
# –í—Å–µ –Ω–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
USE_FRAMEWORK_CLI=true (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

**–î–µ–π—Å—Ç–≤–∏—è:**
- –§–∏–Ω–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —É–¥–∞–ª–µ–Ω–∏—é legacy –∫–æ–¥–∞

### –ù–µ–¥–µ–ª—è 6: –£–¥–∞–ª–µ–Ω–∏–µ legacy
- –£–¥–∞–ª–∏—Ç—å `cli-legacy/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- –£–¥–∞–ª–∏—Ç—å feature flags
- –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –°–º. —ç—Ç–∞–ø 8.1 "Legacy Cleanup"

---

## Rollback –ø–ª–∞–Ω

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–æ–±–ª–µ–º—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ legacy
USE_FRAMEWORK_CLI=false npm run mcp:connect
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–±–ª–µ–º—ã –≤ production

```bash
# Hotfix —á–µ—Ä–µ–∑ environment variable
# –ù–µ —Ç—Ä–µ–±—É–µ—Ç redeploy –∏–ª–∏ revert –∫–æ–º–º–∏—Ç–æ–≤

# –í CI/CD pipeline
export USE_FRAMEWORK_CLI=false

# –í Docker
docker run -e USE_FRAMEWORK_CLI=false ...

# –í Kubernetes
env:
  - name: USE_FRAMEWORK_CLI
    value: "false"
```

**–í—Ä–µ–º—è –æ—Ç–∫–∞—Ç–∞:** ~5 –º–∏–Ω—É—Ç (—Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ env variable)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è legacy

```bash
# Revert –∫–æ–º–º–∏—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è legacy –∫–æ–¥–∞
git revert <commit-sha>
git push

# –û—Ç–∫–∞—Ç–∏—Ç—å USE_FRAMEWORK_CLI
export USE_FRAMEWORK_CLI=false
```

**–í—Ä–µ–º—è –æ—Ç–∫–∞—Ç–∞:** ~15-30 –º–∏–Ω—É—Ç (—Å redeploy)

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:**

1. **Error rate:**
   - CLI crashes
   - Connection failures
   - Validation errors

2. **Performance:**
   - Startup time (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)
   - Memory usage
   - Bundle size

3. **User feedback:**
   - GitHub issues
   - Support tickets
   - User complaints

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è rollback:**
- Error rate >5% –≤—ã—à–µ legacy
- Performance degradation >20%
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –±–µ–∑ –±—ã—Å—Ç—Ä–æ–≥–æ —Ñ–∏–∫—Å–∞

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç

- [ ] Legacy –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ `cli-legacy/`
- [ ] Feature flag —Å–æ–∑–¥–∞–Ω
- [ ] bin/mcp-connect.ts –æ–±–Ω–æ–≤–ª–µ–Ω —Å —É—Å–ª–æ–≤–∏–µ–º
- [ ] Fallback –Ω–∞ legacy –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] MIGRATION_CLI.md —Å–æ–∑–¥–∞–Ω
- [ ] Rollout –ø–ª–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] `npm run validate` –ø—Ä–æ—Ö–æ–¥–∏—Ç

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É legacy –∏ framework CLI
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Rollback –∑–∞–Ω–∏–º–∞–µ—Ç <5 –º–∏–Ω—É—Ç
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–Ω—è—Ç–Ω–∞
- [ ] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ–±–∞ —Ä–µ–∂–∏–º–∞
