# 2.3 Вынос коннекторов

**Тип:** Sequential
**Зависимости:** 2.2 Базовые типы
**Время:** ~1.5 часа

---

## Задача

Перенести все специфичные коннекторы (Claude Desktop, Claude Code, Codex, Gemini, Qwen) и реестр из yandex-tracker в framework/cli.

---

## Действия

### 1. Создать file-based-connector.ts

**Базовый класс для коннекторов с файловой конфигурацией:**

Скопировать из `yandex-tracker/src/cli/connectors/base/file-based-connector.ts` и адаптировать под generic типы.

**Изменения:**
- Использовать `BaseMCPServerConfig` вместо конкретного типа
- Параметризовать `TConfig` и `TClientConfig`
- Убрать YT-специфичные методы (если есть)

### 2. Перенести Claude Desktop connector

**Файлы:**
- `src/connectors/claude-desktop/claude-desktop.connector.ts`

**Действия:**
1. Скопировать из yandex-tracker
2. Изменить imports на `@mcp-framework/cli`
3. Убрать зависимости от YT констант
4. Параметризовать generic тип
5. Обновить методы для работы с generic config

**Ключевые изменения:**
```typescript
// Было:
export class ClaudeDesktopConnector extends FileBasedConnector {
  async connect(config: MCPServerConfig): Promise<void> {
    // Использование config.token, config.orgId напрямую
  }
}

// Стало:
export class ClaudeDesktopConnector<TConfig extends BaseMCPServerConfig>
  extends FileBasedConnector<TConfig> {
  async connect(config: TConfig): Promise<void> {
    // Использование config.env для передачи всех env переменных
    // env должен содержать TOKEN, ORG_ID и т.д.
  }
}
```

### 3. Перенести остальные коннекторы

**По аналогии перенести:**
- Claude Code connector
- Codex connector
- Gemini connector
- Qwen connector

**Для каждого:**
1. Копировать файл
2. Адаптировать под generic типы
3. Убрать YT-специфику
4. Обновить imports

### 4. Создать ConnectorRegistry

**Файл:** `src/connectors/registry.ts`

```typescript
import type { MCPConnector, BaseMCPServerConfig, ConnectionStatus } from '../types.js';

/**
 * Реестр MCP коннекторов
 */
export class ConnectorRegistry<TConfig extends BaseMCPServerConfig = BaseMCPServerConfig> {
  private connectors: Map<string, MCPConnector<TConfig>> = new Map();

  /**
   * Зарегистрировать коннектор
   */
  register(connector: MCPConnector<TConfig>): void {
    const info = connector.getClientInfo();
    this.connectors.set(info.name, connector);
  }

  /**
   * Получить коннектор по имени
   */
  get(name: string): MCPConnector<TConfig> | undefined {
    return this.connectors.get(name);
  }

  /**
   * Получить все коннекторы
   */
  getAll(): MCPConnector<TConfig>[] {
    return Array.from(this.connectors.values());
  }

  /**
   * Найти установленные клиенты
   */
  async findInstalled(): Promise<MCPConnector<TConfig>[]> {
    const installed: MCPConnector<TConfig>[] = [];

    for (const connector of this.connectors.values()) {
      if (await connector.isInstalled()) {
        installed.push(connector);
      }
    }

    return installed;
  }

  /**
   * Проверить статус всех клиентов
   */
  async checkAllStatuses(): Promise<Map<string, ConnectionStatus>> {
    const statuses = new Map<string, ConnectionStatus>();

    for (const [name, connector] of this.connectors) {
      const status = await connector.getStatus();
      statuses.set(name, status);
    }

    return statuses;
  }
}
```

**ВАЖНО:** Registry больше НЕ регистрирует коннекторы в конструкторе автоматически.
Это должно делать приложение (yandex-tracker).

### 5. Создать barrel exports

**src/connectors/index.ts:**
```typescript
export * from './base/index.js';
export * from './claude-desktop/claude-desktop.connector.js';
export * from './claude-code/claude-code.connector.js';
export * from './codex/codex.connector.js';
export * from './gemini/gemini.connector.js';
export * from './qwen/qwen.connector.js';
export * from './registry.js';
```

### 6. Обновить главный index.ts

```typescript
export * from './types.js';
export * from './connectors/index.js';
```

---

## Тестирование

**Для каждого коннектора создать unit тест:**

**Пример:** `tests/unit/connectors/claude-desktop.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { ClaudeDesktopConnector } from '../../../src/connectors/claude-desktop/claude-desktop.connector.js';
import type { BaseMCPServerConfig } from '../../../src/types.js';

describe('ClaudeDesktopConnector', () => {
  let connector: ClaudeDesktopConnector<BaseMCPServerConfig>;

  beforeEach(() => {
    connector = new ClaudeDesktopConnector();
  });

  it('should return client info', () => {
    const info = connector.getClientInfo();
    expect(info.name).toBe('claude-desktop');
    expect(info.displayName).toBeDefined();
  });

  it('should validate config', async () => {
    const config: BaseMCPServerConfig = {
      projectPath: '',
      logLevel: 'info',
    };

    const errors = await connector.validateConfig(config);
    expect(errors.length).toBeGreaterThan(0);
  });

  // ... больше тестов
});
```

---

## Результат

- [ ] `file-based-connector.ts` создан
- [ ] Все 5 коннекторов перенесены и адаптированы
- [ ] `ConnectorRegistry` создан
- [ ] Barrel exports настроены
- [ ] Unit тесты для всех коннекторов написаны
- [ ] `npm run build` проходит
- [ ] `npm run test` проходит
- [ ] `npm run lint` проходит

---

## Критерии готовности

- [ ] Все коннекторы работают с generic типами
- [ ] Нет зависимостей от yandex-tracker
- [ ] Registry не содержит автоматической регистрации
- [ ] Тесты покрывают базовую функциональность
- [ ] TypeScript compilation успешен
- [ ] Все exports работают корректно
