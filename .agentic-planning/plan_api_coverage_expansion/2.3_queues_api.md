# Этап 2.3: Queues API (Очереди)

**Статус:** ✅ Завершен
**Приоритет:** Критический
**Время выполнения:** 5-7 дней
**Зависимости:** `1.1_preparation.md`
**Параллельность:** ✅ Да
**Важно:** Блокирует Projects и Components API!

## Цель
Реализовать поддержку работы с очередями задач - получение, создание, обновление, управление полями и правами доступа.

## API Endpoints

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/v3/queues/` | Получить список очередей (с пагинацией) |
| GET | `/v3/queues/{queueId}` | Получить параметры очереди |
| POST | `/v3/queues/` | Создать очередь |
| PATCH | `/v3/queues/{queueId}` | Изменить очередь |
| GET | `/v3/queues/{queueId}/fields` | Получить обязательные поля |
| PATCH | `/v3/queues/{queueId}/permissions` | Управление доступом |

## MCP Tools (6 инструментов)

1. `yandex_tracker_get_queues` - получить список очередей
2. `yandex_tracker_get_queue` - получить параметры очереди
3. `yandex_tracker_create_queue` - создать очередь
4. `yandex_tracker_update_queue` - обновить очередь
5. `yandex_tracker_get_queue_fields` - получить обязательные поля
6. `yandex_tracker_manage_queue_access` - управление правами доступа

---

## Чек-лист задач

### 1. Entities

- [ ] **1.1** Создать `queue.entity.ts`
  ```typescript
  export interface Queue extends WithUnknownFields {
    id: string;
    self: string;
    key: string;
    version: number;
    name: string;
    description?: string;
    lead: UserRef;
    assignAuto: boolean;
    defaultType: {
      id: string;
      key: string;
      display: string;
    };
    defaultPriority: {
      id: string;
      key: string;
      display: string;
    };
    issueTypes?: Array<{id: string; key: string; display: string}>;
    workflows?: Record<string, Array<{id: string; display: string}>>;
    denyVoting?: boolean;
    issueTypesConfig?: Array<{
      issueType: {id: string};
      workflow: {id: string};
      resolutions: Array<{id: string}>;
    }>;
  }
  ```

- [ ] **1.2** Создать `queue-field.entity.ts` для полей очереди
  ```typescript
  export interface QueueField extends WithUnknownFields {
    id: string;
    key: string;
    name: string;
    required: boolean;
    type: string; // 'string', 'user', 'date', etc.
    category?: {
      id: string;
      display: string;
    };
  }
  ```

- [ ] **1.3** Создать `queue-permission.entity.ts`
  ```typescript
  export interface QueuePermission extends WithUnknownFields {
    id: string;
    self: string;
    display: string;
  }

  export type QueueRole = 'queue-lead' | 'team-member' | 'follower' | 'access';
  ```

- [ ] **1.4** Экспорты и unit-тесты

### 2. DTO

- [ ] **2.1** `get-queues.input.ts` - с пагинацией и expand
- [ ] **2.2** `create-queue.input.ts`
  ```typescript
  export interface CreateQueueInput {
    key: string;            // Уникальный ключ (A-Z, 2-10 символов)
    name: string;           // Название очереди
    lead: string;           // ID или login руководителя
    defaultType: string;    // ID типа задачи по умолчанию
    defaultPriority: string;// ID приоритета по умолчанию
    description?: string;
    issueTypes?: string[];  // Массив ID типов задач
  }
  ```
- [ ] **2.3** `update-queue.input.ts` - Partial от create
- [ ] **2.4** `manage-queue-access.input.ts`
  ```typescript
  export interface ManageQueueAccessInput {
    role: QueueRole;
    subjects: string[]; // Массив ID пользователей или групп
    action: 'add' | 'remove';
  }
  ```
- [ ] **2.5** Output DTO: `queue.output.ts`, `queues-list.output.ts`, `queue-fields.output.ts`

### 3. API Operations

- [ ] **3.1** `GetQueuesOperation` - GET с пагинацией
- [ ] **3.2** `GetQueueOperation` - GET одной очереди
- [ ] **3.3** `CreateQueueOperation` - POST
- [ ] **3.4** `UpdateQueueOperation` - PATCH
- [ ] **3.5** `GetQueueFieldsOperation` - GET required fields
- [ ] **3.6** `ManageQueueAccessOperation` - PATCH permissions
- [ ] **3.7** Unit-тесты для всех 6 операций

### 4. MCP Tools (6 tools)

- [ ] **4.1** `get-queues` tool
  - Schema: `perPage`, `page`, `expand` (опционально)
  - Support pagination
  - Unit + Integration тесты

- [ ] **4.2** `get-queue` tool
  - Schema: `queueId` (string, required), `expand` (optional)
  - Unit + Integration тесты

- [ ] **4.3** `create-queue` tool
  - Schema: все поля из CreateQueueInput
  - Валидация ключа очереди (regex: `^[A-Z]{2,10}$`)
  - Unit + Integration тесты

- [ ] **4.4** `update-queue` tool
  - Schema: `queueId` + partial поля
  - Unit + Integration тесты

- [ ] **4.5** `get-queue-fields` tool
  - Schema: `queueId`
  - Unit + Integration тесты

- [ ] **4.6** `manage-queue-access` tool
  - Schema: `queueId`, `role`, `subjects[]`, `action`
  - Enum для role и action
  - Unit + Integration тесты

- [ ] **4.7** Index exports `tools/api/queues/index.ts`

### 5. DI Registration

- [ ] **5.1** Зарегистрировать все 6 операций
- [ ] **5.2** Добавить токены

### 6. Test Fixtures

- [ ] **6.1** `queue.fixture.ts` - createQueueFixture()
- [ ] **6.2** `queue-field.fixture.ts` - различные типы полей
- [ ] **6.3** `queue-permission.fixture.ts`

### 7. Документация

- [ ] **7.1** Обновить `entities/README.md` - Queue, QueueField, QueuePermission
- [ ] **7.2** Обновить `api_operations/README.md` - Queue Operations
- [ ] **7.3** Обновить `tools/README.md` - Queue Tools с примерами создания очереди

### 8. Валидация

- [ ] **8.1** `npm run validate`
- [ ] **8.2** Покрытие ≥90%
- [ ] **8.3** `npm run depcruise`
- [ ] **8.4** `npm run cpd`

### 9. Integration Tests

- [ ] **9.1** E2E: Получить список очередей (проверить пагинацию)
- [ ] **9.2** E2E: Получить параметры существующей очереди
- [ ] **9.3** E2E: Создать новую очередь (ОСТОРОЖНО: не в production!)
- [ ] **9.4** E2E: Обновить параметры очереди
- [ ] **9.5** E2E: Получить обязательные поля очереди
- [ ] **9.6** E2E: Управление доступом (добавить/удалить пользователя из роли)

### 10. Коммит

- [ ] **10.1** Коммит `feat: добавить поддержку Queues API`
- [ ] **10.2** Push
- [ ] **10.3** Обновить `0.0_overview.md`

---

## Критерии готовности

- ✅ 6 MCP инструментов работают
- ✅ Поддержка пагинации для списка очередей
- ✅ Валидация ключа очереди (A-Z, 2-10 символов)
- ✅ Покрытие ≥90%
- ✅ Документация обновлена

---

## Важные заметки

⚠️ **Осторожно при создании очередей!**
- Создание очередей - администраторская операция
- В integration тестах использовать только тестовые очереди
- Не создавать очереди в production окружении без согласования

⚠️ **Этот API блокирует:**
- Projects API (проекты привязаны к очередям)
- Components API (компоненты привязаны к очередям)

---

## Примеры MCP запросов

### Получить список очередей
```json
{
  "name": "yandex_tracker_get_queues",
  "arguments": {
    "perPage": 50,
    "page": 1
  }
}
```

### Создать очередь
```json
{
  "name": "yandex_tracker_create_queue",
  "arguments": {
    "key": "TESTQ",
    "name": "Test Queue",
    "lead": "john.doe",
    "defaultType": "1",
    "defaultPriority": "2"
  }
}
```

### Управление доступом
```json
{
  "name": "yandex_tracker_manage_queue_access",
  "arguments": {
    "queueId": "TESTQ",
    "role": "team-member",
    "subjects": ["user123", "user456"],
    "action": "add"
  }
}
```

---

**Создано:** 2025-01-18
**Версия:** 1.0
