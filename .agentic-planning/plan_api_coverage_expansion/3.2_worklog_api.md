# Этап 3.2: Worklog API (Учёт времени)

**Статус:** ⏪ Не начат
**Приоритет:** Важный
**Время:** 3-5 дней
**Зависимости:** `1.1_preparation.md`
**Параллельность:** ✅ Да

## Цель
Реализовать учёт затраченного времени на задачи - добавление, получение, редактирование, удаление записей.

## API Endpoints

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/v3/issues/{issueId}/worklog` | Получить записи времени |
| POST | `/v3/issues/{issueId}/worklog` | Добавить запись |
| PATCH | `/v3/issues/{issueId}/worklog/{worklogId}` | Изменить запись |
| DELETE | `/v3/issues/{issueId}/worklog/{worklogId}` | Удалить запись |

## MCP Tools (4)

1. `yandex_tracker_get_worklog`
2. `yandex_tracker_add_worklog`
3. `yandex_tracker_update_worklog`
4. `yandex_tracker_delete_worklog`

---

## Структура реализации

### 1. Entities
- [ ] `worklog.entity.ts`
  ```typescript
  export interface Worklog extends WithUnknownFields {
    id: string;
    self: string;
    issue: {
      id: string;
      key: string;
      display: string;
    };
    comment?: string;
    createdBy: UserRef;
    updatedBy?: UserRef;
    createdAt: string;
    updatedAt?: string;
    start: string;        // ISO 8601 дата начала работы
    duration: string;     // Формат: "PT1H30M" (ISO 8601 duration)
  }
  ```

### 2. DTO
- [ ] `add-worklog.input.ts`
  ```typescript
  export interface AddWorklogInput {
    start: string;      // ISO 8601
    duration: string;   // "1h 30m", "2h", "45m" или ISO 8601
    comment?: string;
  }
  ```
- [ ] `update-worklog.input.ts` - Partial
- [ ] Output DTO

### 3. Utilities
- [ ] `duration.util.ts` - конвертация "1h 30m" ↔ "PT1H30M"
  ```typescript
  export class DurationUtil {
    static parseHumanReadable(duration: string): string; // "1h 30m" -> "PT1H30M"
    static toISO8601(duration: string): string;
    static toHumanReadable(iso: string): string;         // "PT1H30M" -> "1h 30m"
  }
  ```

### 4. Operations (4)
- [ ] GetWorklogOperation
- [ ] AddWorklogOperation (с конвертацией duration)
- [ ] UpdateWorklogOperation
- [ ] DeleteWorklogOperation
- [ ] Unit-тесты

### 5. Tools (4)
- [ ] get-worklog tool + tests
- [ ] add-worklog tool + tests (принимает "1h", "30m", "2h 15m")
- [ ] update-worklog tool + tests
- [ ] delete-worklog tool + tests

### 6. Infrastructure
- [ ] DI registration
- [ ] Fixtures
- [ ] Документация (примеры форматов времени)

### 7. Validation & Tests
- [ ] Unit tests ≥90%
- [ ] Integration tests
- [ ] Тесты конвертации duration форматов
- [ ] `npm run validate`

### 8. Commit
- [ ] `feat: добавить поддержку Worklog API`
- [ ] Push + update overview

---

## Примеры

```json
// Добавить запись времени
{
  "name": "yandex_tracker_add_worklog",
  "arguments": {
    "issueId": "TEST-123",
    "start": "2025-01-18T10:00:00Z",
    "duration": "2h 30m",
    "comment": "Code review and testing"
  }
}

// Получить все записи
{
  "name": "yandex_tracker_get_worklog",
  "arguments": {
    "issueId": "TEST-123"
  }
}
```

---

**Создано:** 2025-01-18
