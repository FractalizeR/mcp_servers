# Этап 2.2: Links API (Связи между задачами)

**Статус:** ✅ Выполнен
**Приоритет:** Критический
**Время выполнения:** 3-5 дней
**Зависимости:** `1.1_preparation.md`
**Параллельность:** ✅ Да

## Цель
Реализовать поддержку создания, получения и удаления связей между задачами (subtask, depends, relates, duplicates, epic).

## API Endpoints

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/v3/issues/{issueId}/links` | Получить связи задачи |
| POST | `/v3/issues/{issueId}/links` | Создать связь |
| DELETE | `/v3/issues/{issueId}/links/{linkId}` | Удалить связь |

## MCP Tools (3 инструмента)

1. `yandex_tracker_get_issue_links` - получить связи задачи
2. `yandex_tracker_create_link` - создать связь между задачами
3. `yandex_tracker_delete_link` - удалить связь

---

## Чек-лист задач

### 1. Entities

- [ ] **1.1** Создать `link.entity.ts`
  ```typescript
  export interface Link extends WithUnknownFields {
    id: string;
    self: string;
    type: {
      id: string;
      inward: string;  // "является подзадачей"
      outward: string; // "имеет подзадачу"
    };
    direction: 'inward' | 'outward';
    object: {
      id: string;
      key: string;
      display: string;
    };
    createdBy: UserRef;
    createdAt: string;
    updatedBy?: UserRef;
    updatedAt?: string;
  }

  export type LinkRelationship =
    | 'relates'      // связана с
    | 'is duplicated by' | 'duplicates'
    | 'is subtask of' | 'has subtasks'
    | 'depends on' | 'is dependent by'
    | 'is epic of' | 'has epic';
  ```

- [ ] **1.2** Создать `link-type.entity.ts` (типы связей из API)

- [ ] **1.3** Экспорты и тесты

### 2. DTO

- [ ] **2.1** `create-link.input.ts`
  ```typescript
  export interface CreateLinkInput {
    relationship: LinkRelationship;
    issue: string; // ID или ключ связываемой задачи
  }
  ```

- [ ] **2.2** `link.output.ts`

- [ ] **2.3** `links-list.output.ts` с массивом Link[]

### 3. API Operations

- [ ] **3.1** `GetIssueLinksOperation` - GET запрос, возвращает массив
- [ ] **3.2** `CreateLinkOperation` - POST запрос с relationship и issue
- [ ] **3.3** `DeleteLinkOperation` - DELETE запрос (использует метод из BaseOperation)
- [ ] **3.4** Unit-тесты для каждой операции

### 4. MCP Tools

- [ ] **4.1** `get-issue-links` tool
  - Schema: `issueId` (string, required)
  - Definition с описанием типов связей
  - Tool класс
  - Unit + Integration тесты

- [ ] **4.2** `create-link` tool
  - Schema: `issueId`, `relationship`, `targetIssue`
  - Enum для relationship в zod схеме
  - Tool класс
  - Unit + Integration тесты

- [ ] **4.3** `delete-link` tool
  - Schema: `issueId`, `linkId`
  - Tool класс
  - Unit + Integration тесты

- [ ] **4.4** Создать `tools/api/links/index.ts` и обновить родительские индексы

### 5. DI Registration

- [ ] **5.1** Зарегистрировать все 3 операции в container.ts
- [ ] **5.2** Добавить токены в tokens.ts (если нужно)

### 6. Test Fixtures

- [ ] **6.1** `link.fixture.ts` с createLinkFixture()
- [ ] **6.2** `link-type.fixture.ts` с различными типами связей

### 7. Документация

- [ ] **7.1** Обновить `entities/README.md` - секция Link Entity
- [ ] **7.2** Обновить `api_operations/README.md` - секция Link Operations
- [ ] **7.3** Обновить `tools/README.md` - секция Link Tools с примерами

### 8. Валидация

- [ ] **8.1** `npm run validate` - успешно
- [ ] **8.2** Покрытие тестами ≥90%
- [ ] **8.3** `npm run depcruise` - без нарушений
- [ ] **8.4** `npm run cpd` - ≤5% дублирования

### 9. Integration Tests

- [ ] **9.1** E2E: Создать связь "subtask" между двумя задачами
- [ ] **9.2** E2E: Получить список связей задачи
- [ ] **9.3** E2E: Удалить связь
- [ ] **9.4** E2E: Проверить различные типы связей (relates, duplicates, depends)

### 10. Коммит

- [ ] **10.1** Коммит с префиксом `feat: добавить поддержку Links API`
- [ ] **10.2** Push в ветку
- [ ] **10.3** Обновить статус в `0.0_overview.md`

---

## Критерии готовности

- ✅ 3 MCP инструмента работают
- ✅ Все типы связей (relates, subtask, depends, duplicates, epic) поддерживаются
- ✅ Покрытие ≥90%
- ✅ Валидация проходит
- ✅ Документация обновлена

---

## Примеры MCP запросов

### Получить связи
```json
{
  "name": "yandex_tracker_get_issue_links",
  "arguments": {"issueId": "TEST-123"}
}
```

### Создать subtask связь
```json
{
  "name": "yandex_tracker_create_link",
  "arguments": {
    "issueId": "TEST-123",
    "relationship": "has subtasks",
    "targetIssue": "TEST-456"
  }
}
```

### Удалить связь
```json
{
  "name": "yandex_tracker_delete_link",
  "arguments": {
    "issueId": "TEST-123",
    "linkId": "67890"
  }
}
```

---

**Создано:** 2025-01-18
**Версия:** 1.0
