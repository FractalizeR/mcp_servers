# –≠—Ç–∞–ø 2.4: Attachments API (–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã)

**–°—Ç–∞—Ç—É—Å:** ‚è™ –ù–µ –Ω–∞—á–∞—Ç
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 5-7 –¥–Ω–µ–π
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** `1.1_preparation.md` (–æ—Å–æ–±–µ–Ω–Ω–æ FileUploadUtil)
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å:** ‚úÖ –î–∞

## –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏: –∑–∞–≥—Ä—É–∑–∫–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, —Ä–∞–±–æ—Ç–∞ —Å –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º–∏.

## API Endpoints

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/v3/issues/{issueId}/attachments` | –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ |
| POST | `/v3/issues/{issueId}/attachments` | –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª |
| GET | `/v3/issues/{issueId}/attachments/{attachmentId}/{filename}` | –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª |
| DELETE | `/v3/issues/{issueId}/attachments/{attachmentId}` | –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª |
| GET | `/v3/issues/{issueId}/thumbnails/{attachmentId}` | –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É |

## MCP Tools (5 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)

1. `yandex_tracker_get_attachments` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
2. `yandex_tracker_upload_attachment` - –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
3. `yandex_tracker_download_attachment` - —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
4. `yandex_tracker_delete_attachment` - —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
5. `yandex_tracker_get_thumbnail` - –ø–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

---

## –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–¥–∞—á

### 1. Entities

- [ ] **1.1** –°–æ–∑–¥–∞—Ç—å `attachment.entity.ts`
  ```typescript
  export interface Attachment extends WithUnknownFields {
    id: string;
    self: string;
    name: string;
    content: string;      // URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    thumbnail?: string;   // URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã (–µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    createdBy: UserRef;
    createdAt: string;
    mimetype: string;
    size: number;         // –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
  }
  ```

- [ ] **1.2** Unit-—Ç–µ—Å—Ç—ã –¥–ª—è entity

### 2. DTO

- [ ] **2.1** `upload-attachment.input.ts`
  ```typescript
  export interface UploadAttachmentInput {
    filename: string;
    file: Buffer | string;  // Buffer –∏–ª–∏ base64 —Å—Ç—Ä–æ–∫–∞
    mimetype?: string;      // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
  }
  ```

- [ ] **2.2** `download-attachment.input.ts`
  ```typescript
  export interface DownloadAttachmentInput {
    saveToPath?: string;    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    returnBase64?: boolean; // –í–µ—Ä–Ω—É—Ç—å –∫–∞–∫ base64 –≤–º–µ—Å—Ç–æ Buffer
  }
  ```

- [ ] **2.3** Output DTO:
  - `attachment.output.ts` - –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ñ–∞–π–ª
  - `attachments-list.output.ts` - –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤
  - `download-attachment.output.ts` - Buffer –∏–ª–∏ base64 + metadata

### 3. –£—Ç–∏–ª–∏—Ç—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ Preparation)

- [ ] **3.1** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `FileUploadUtil` –∏–∑ Preparation —ç—Ç–∞–ø–∞
  - –ú–µ—Ç–æ–¥ `prepareMultipartFormData`
  - –ú–µ—Ç–æ–¥ `validateFileSize`
  - –ú–µ—Ç–æ–¥ `getMimeType`

- [ ] **3.2** –°–æ–∑–¥–∞—Ç—å `file-download.util.ts`
  ```typescript
  export class FileDownloadUtil {
    static bufferToBase64(buffer: Buffer): string;
    static saveBufferToFile(buffer: Buffer, path: string): Promise<void>;
    static getFileExtension(filename: string): string;
  }
  ```

- [ ] **3.3** Unit-—Ç–µ—Å—Ç—ã –¥–ª—è —É—Ç–∏–ª–∏—Ç

### 4. API Operations

- [ ] **4.1** `GetAttachmentsOperation` - GET —Å–ø–∏—Å–æ–∫
  ```typescript
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ Attachment[]
  ```

- [ ] **4.2** `UploadAttachmentOperation` - POST —Å multipart/form-data
  ```typescript
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç BaseOperation.uploadFile() –∏–∑ Preparation
  // Content-Type: multipart/form-data
  ```

- [ ] **4.3** `DownloadAttachmentOperation` - GET —Ñ–∞–π–ª
  ```typescript
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç BaseOperation.downloadFile()
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Buffer
  ```

- [ ] **4.4** `DeleteAttachmentOperation` - DELETE

- [ ] **4.5** `GetThumbnailOperation` - GET –º–∏–Ω–∏–∞—Ç—é—Ä—É
  ```typescript
  // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint –¥–ª—è thumbnails
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Buffer (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
  ```

- [ ] **4.6** Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–º–æ–∫–∏ –¥–ª—è file I/O)

### 5. MCP Tools

#### 5.1 Get Attachments Tool
- [ ] **5.1.1** Schema: `issueId` (required)
- [ ] **5.1.2** Definition
- [ ] **5.1.3** Tool implementation
- [ ] **5.1.4** Unit + Integration —Ç–µ—Å—Ç—ã

#### 5.2 Upload Attachment Tool
- [ ] **5.2.1** Schema: `issueId`, `filename`, `fileContent` (base64 –∏–ª–∏ path)
- [ ] **5.2.2** Definition —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ª–∏–º–∏—Ç–æ–≤ —Ä–∞–∑–º–µ—Ä–∞
- [ ] **5.2.3** Tool implementation:
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ base64
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ file path
  - –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME type
- [ ] **5.2.4** Unit + Integration —Ç–µ—Å—Ç—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã)

#### 5.3 Download Attachment Tool
- [ ] **5.3.1** Schema: `issueId`, `attachmentId`, `filename`, `saveToPath` (optional)
- [ ] **5.3.2** Definition
- [ ] **5.3.3** Tool implementation:
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç base64 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è MCP response)
  - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª
- [ ] **5.3.4** Unit + Integration —Ç–µ—Å—Ç—ã

#### 5.4 Delete Attachment Tool
- [ ] **5.4.1** Schema: `issueId`, `attachmentId`
- [ ] **5.4.2** Definition
- [ ] **5.4.3** Tool implementation
- [ ] **5.4.4** Unit + Integration —Ç–µ—Å—Ç—ã

#### 5.5 Get Thumbnail Tool
- [ ] **5.5.1** Schema: `issueId`, `attachmentId`, `saveToPath` (optional)
- [ ] **5.5.2** Definition (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
- [ ] **5.5.3** Tool implementation
- [ ] **5.5.4** Unit + Integration —Ç–µ—Å—Ç—ã

- [ ] **5.6** Index exports `tools/api/attachments/index.ts`

### 6. DI Registration

- [ ] **6.1** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] **6.2** –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

### 7. Test Fixtures & Helpers

- [ ] **7.1** `attachment.fixture.ts` - createAttachmentFixture()
- [ ] **7.2** `test-files/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏:
  - `test-image.png` (–¥–ª—è upload/download —Ç–µ—Å—Ç–æ–≤)
  - `test-document.pdf`
  - `test-text.txt`
- [ ] **7.3** `file-test.helper.ts` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
  ```typescript
  export class FileTestHelper {
    static createTestBuffer(size: number): Buffer;
    static createTestImage(): Buffer;
    static compareBuffers(a: Buffer, b: Buffer): boolean;
  }
  ```

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ ] **8.1** –û–±–Ω–æ–≤–∏—Ç—å `entities/README.md` - Attachment Entity
- [ ] **8.2** –û–±–Ω–æ–≤–∏—Ç—å `api_operations/README.md` - Attachment Operations
  - –ü—Ä–∏–º–µ—Ä—ã upload/download
  - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å multipart/form-data
- [ ] **8.3** –û–±–Ω–æ–≤–∏—Ç—å `tools/README.md` - Attachment Tools
  - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (base64 –∏ file path)
  - –ü—Ä–∏–º–µ—Ä—ã —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  - –õ–∏–º–∏—Ç—ã —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤

### 9. –í–∞–ª–∏–¥–∞—Ü–∏—è

- [ ] **9.1** `npm run validate`
- [ ] **9.2** –ü–æ–∫—Ä—ã—Ç–∏–µ ‚â•90%
- [ ] **9.3** `npm run depcruise`
- [ ] **9.4** `npm run cpd`

### 10. Integration Tests (E2E)

- [ ] **10.1** E2E: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∑–∞–¥–∞—á—É
- [ ] **10.2** E2E: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∑–∞–¥–∞—á–∏
- [ ] **10.3** E2E: –°–∫–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
- [ ] **10.4** E2E: –°—Ä–∞–≤–Ω–∏—Ç—å —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º (binary compare)
- [ ] **10.5** E2E: –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- [ ] **10.6** E2E: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
- [ ] **10.7** E2E: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ MIME types (image, pdf, text)

### 11. –ö–æ–º–º–∏—Ç

- [ ] **11.1** –ö–æ–º–º–∏—Ç `feat: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Attachments API`
- [ ] **11.2** Push
- [ ] **11.3** –û–±–Ω–æ–≤–∏—Ç—å `0.0_overview.md`

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- ‚úÖ 5 MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ upload/download —Ñ–∞–π–ª–æ–≤
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ MIME types
- ‚úÖ Binary integrity –ø—Ä–∏ upload/download
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ ‚â•90%
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

‚ö†Ô∏è **–õ–∏–º–∏—Ç—ã API:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: —É—Ç–æ—á–Ω–∏—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

‚ö†Ô∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å MIME type
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

üí° **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å streaming
- Thumbnails –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–≤–Ω–µ scope —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞)

---

## –ü—Ä–∏–º–µ—Ä—ã MCP –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
```json
{
  "name": "yandex_tracker_get_attachments",
  "arguments": {
    "issueId": "TEST-123"
  }
}
```

### –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (base64)
```json
{
  "name": "yandex_tracker_upload_attachment",
  "arguments": {
    "issueId": "TEST-123",
    "filename": "screenshot.png",
    "fileContent": "iVBORw0KGgoAAAANSUhEUgAAAAUA..."
  }
}
```

### –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (file path)
```json
{
  "name": "yandex_tracker_upload_attachment",
  "arguments": {
    "issueId": "TEST-123",
    "filePath": "/path/to/document.pdf"
  }
}
```

### –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
```json
{
  "name": "yandex_tracker_download_attachment",
  "arguments": {
    "issueId": "TEST-123",
    "attachmentId": "67890",
    "filename": "report.pdf",
    "saveToPath": "/downloads/report.pdf"
  }
}
```

### –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É
```json
{
  "name": "yandex_tracker_get_thumbnail",
  "arguments": {
    "issueId": "TEST-123",
    "attachmentId": "67890"
  }
}
```

### –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
```json
{
  "name": "yandex_tracker_delete_attachment",
  "arguments": {
    "issueId": "TEST-123",
    "attachmentId": "67890"
  }
}
```

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-01-18
**–í–µ—Ä—Å–∏—è:** 1.0
