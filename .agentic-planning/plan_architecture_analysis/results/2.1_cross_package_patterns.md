# Cross-Package Patterns Analysis

**Date:** 2025-11-21
**Scope:** Framework packages (infrastructure, core, search)

---

## ğŸ“‹ Analysis Categories

1. Error Handling
2. Testing Patterns
3. Configuration Management
4. NPM Scripts Consistency
5. Dependency Management

---

## âœ… Strong Points

### 1. **Perfect NPM Scripts Consistency**

**All three packages have IDENTICAL npm scripts:**

```json
{
  "scripts": {
    "build": "tsc -b && tsc-alias",
    "clean": "rimraf dist",
    "format": "prettier --write \"src/**/*.ts\" \"tests/**/*.ts\"",
    "format:check": "prettier --check \"src/**/*.ts\" \"tests/**/*.ts\"",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix",
    "lint:quiet": "eslint src --ext .ts --quiet",
    "test": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:quiet": "vitest run --reporter=dot --silent",
    "test:verbose": "vitest run --reporter=verbose",
    "test:watch": "vitest watch",
    "typecheck": "tsc --noEmit",
    "validate": "npm run lint && npm run typecheck && npm run test",
    "validate:quiet": "npm run lint:quiet && npm run typecheck && npm run test:quiet"
  }
}
```

**Why this is excellent:**
- âœ… **Matches CLAUDE.md requirements exactly**
- âœ… **Predictable workflow** - same commands work everywhere
- âœ… **CI/CD friendly** - easy to automate
- âœ… **Developer friendly** - muscle memory works across packages
- âœ… **Quiet modes for AI agents** - saves tokens

---

### 2. **Unified Error Handling**

**Pattern: ApiErrorClass + formatError()**

**Infrastructure layer provides:**
```typescript
// infrastructure/src/http/error/api-error.class.ts
export class ApiErrorClass extends Error {
  constructor(
    public readonly statusCode: HttpStatusCode,
    message: string,
    public readonly errors?: Record<string, string[]>,
    public readonly retryAfter?: number
  ) {
    super(message);
  }

  toJSON(): ApiErrorDetails {
    return {
      statusCode: this.statusCode,
      message: this.message,
      errors: this.errors,
      retryAfter: this.retryAfter,
    };
  }
}
```

**Core layer uses it:**
```typescript
// core/src/tools/base/base-tool.ts
protected formatError(message: string, error?: unknown): ToolResult {
  let errorDetails: string | ApiErrorDetails | undefined;
  if (error instanceof ApiErrorClass) {
    errorDetails = error.toJSON(); // âœ… Preserves full details
  } else if (error instanceof Error) {
    errorDetails = error.message;
  }
  // ...
}
```

**Why this is excellent:**
- âœ… **Single source of truth** for API errors
- âœ… **Type-safe** - discriminated union for 429 vs other errors
- âœ… **Full context preservation** - statusCode, errors, retryAfter all passed to MCP client
- âœ… **Consistent handling** across all tools

---

### 3. **Consistent Testing Framework**

**All packages use:**
- Vitest for testing
- Same test commands (test, test:coverage, test:quiet, etc.)
- TypeScript for tests
- Similar test structure (`tests/` directory)

**Test file naming:**
- âœ… `*.test.ts` convention across all packages
- âœ… Mirrors source structure (`src/foo/bar.ts` â†’ `tests/foo/bar.test.ts`)

---

### 4. **Clean Dependency Graph**

**Actual dependencies:**
```
infrastructure â†’ axios, pino, p-limit (external only)
core â†’ @mcp-framework/infrastructure, inversify, zod
search â†’ @mcp-framework/core, @mcp-framework/infrastructure
```

**Why this is good:**
- âœ… **No circular dependencies**
- âœ… **Clear hierarchy** (infrastructure â†’ core â†’ search)
- âœ… **Minimal external deps** (infrastructure has only 5 deps)

---

### 5. **Consistent Package Structure**

**All packages follow:**
```
package/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Main export
â”‚   â”œâ”€â”€ <modules>/        # Feature modules
â”‚   â””â”€â”€ README.md         # Package docs
â”œâ”€â”€ tests/                # Test files
â”œâ”€â”€ package.json          # NPM metadata
â””â”€â”€ tsconfig.json         # TypeScript config
```

---

## âš ï¸ Issues

### Problem #1: Configuration in Infrastructure Package

**Priority:** ğŸ”´ CRITICAL (related to Infrastructure Problem #1)
**SOLID Violation:** SRP
**File:** `infrastructure/src/config.ts` (372 lines)

**Current state:**
```typescript
// infrastructure/src/config.ts - WRONG PLACE!
export function loadConfig(): ServerConfig {
  const token = process.env['YANDEX_TRACKER_TOKEN'];
  // ... Yandex Tracker specific configuration
}
```

**Why this is a problem:**
- Configuration loading is domain-specific
- Infrastructure should be config-agnostic
- Violates "zero domain coupling" for framework

**Recommended solution:**
- Move `config.ts` â†’ `packages/servers/yandex-tracker/src/config/`
- Infrastructure provides generic config utilities (if any)
- Each server package handles its own configuration

**Effort:** MEDIUM (included in Infrastructure refactoring)

---

### Problem #2: No Shared Test Utilities

**Priority:** ğŸŸ¢ NICE TO HAVE
**SOLID Violation:** DRY (for tests)

**Current state:**
- Each package has isolated tests
- No shared test helpers/mocks
- Some duplication (e.g., mock logger, mock HTTP responses)

**Example duplication:**
```typescript
// Duplicated in multiple test files
const mockLogger = {
  debug: vi.fn(),
  info: vi.fn(),
  warn: vi.fn(),
  error: vi.fn(),
};
```

**Recommended solution:**
```
packages/framework/test-utils/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mocks/
â”‚   â”‚   â”œâ”€â”€ mock-logger.ts
â”‚   â”‚   â”œâ”€â”€ mock-http-client.ts
â”‚   â”‚   â””â”€â”€ mock-cache.ts
â”‚   â””â”€â”€ fixtures/
â”‚       â””â”€â”€ test-data.ts
â””â”€â”€ package.json

// Usage
import { createMockLogger } from '@mcp-framework/test-utils';

const logger = createMockLogger();
```

**Benefits:**
- âœ… DRY principle for tests
- âœ… Consistent mocking patterns
- âœ… Easier test maintenance

**Trade-off:**
- âš ï¸ Adds dependency between test files
- âš ï¸ May not be worth it for small projects

**Verdict:** NICE TO HAVE but not critical

---

### Problem #3: No Shared Constants Package

**Priority:** ğŸŸ¢ NICE TO HAVE

**Current state:**
- Each package defines its own constants
- Some duplication (e.g., HTTP status codes)

**Example:**
```typescript
// infrastructure/src/types.ts
export enum HttpStatusCode {
  OK = 200,
  NOT_FOUND = 404,
  // ...
}

// Could be in @mcp-framework/constants
```

**Recommended solution:**
```
Option 1: Keep as-is (RECOMMENDED)
- Constants are domain-specific to each package
- No real duplication (HttpStatusCode only in infrastructure)

Option 2: Create @mcp-framework/constants
- Only if we see real duplication
- Not needed right now
```

**Verdict:** No action needed (not DRY violation, different contexts)

---

## ğŸ“Š Pattern Comparison Table

| Pattern | Infrastructure | Core | Search | Status |
|---------|---------------|------|--------|--------|
| **Error Handling** | ApiErrorClass, ErrorMapper | formatError() uses ApiErrorClass | formatError() uses ApiErrorClass | âœ… Consistent |
| **Testing** | Vitest | Vitest | Vitest | âœ… Consistent |
| **NPM Scripts** | Standard set | Standard set | Standard set | âœ… Consistent |
| **Build** | tsc -b && tsc-alias | tsc -b && tsc-alias | tsc -b && tsc-alias | âœ… Consistent |
| **Linting** | ESLint | ESLint | ESLint | âœ… Consistent |
| **Formatting** | Prettier | Prettier | Prettier | âœ… Consistent |
| **Configuration** | âŒ Domain-specific config | âœ… No config | âœ… No config | âš ï¸ Infrastructure issue |

---

## ğŸ’¡ Key Takeaways

### Strengths
1. **ğŸ† Perfect NPM scripts consistency** - All packages follow exact same pattern
2. **ğŸ† Unified error handling** - ApiErrorClass used consistently
3. **ğŸ† Same testing framework** - Vitest everywhere
4. **ğŸ† Clean dependency graph** - No cycles, clear hierarchy

### Issues
1. **ğŸ”´ Configuration in wrong package** - Should be in yandex-tracker, not infrastructure
2. **ğŸŸ¢ No shared test utils** - Minor duplication, not critical

### Priority Actions
1. **Move configuration to yandex-tracker** (part of Infrastructure refactoring)
2. **(Optional) Create test-utils package** - Only if duplication becomes significant

---

## ğŸ“ˆ Consistency Score

| Category | Score | Comment |
|----------|-------|---------|
| NPM Scripts | 10/10 | Perfect consistency |
| Error Handling | 9/10 | Unified pattern, minor issues |
| Testing | 9/10 | Same framework, isolated tests |
| Build System | 10/10 | Identical across packages |
| Configuration | 5/10 | Domain-specific config in infrastructure |
| **Overall** | **8.6/10** | Excellent consistency |

---

## ğŸ”— Related Files

- [Infrastructure Package Analysis](./2.1_infrastructure_analysis.md)
- [Core Package Analysis](./2.1_core_analysis.md)
- [Search Package Analysis](./2.1_search_analysis.md)
- [API Design Analysis](./2.1_api_design.md)
