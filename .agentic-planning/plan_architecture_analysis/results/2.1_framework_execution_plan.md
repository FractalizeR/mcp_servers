# Framework Packages - Execution Plan

**Date:** 2025-11-21
**Total Estimated Time:** 14-22 hours (can be parallelized to 8-12 hours)

---

## ğŸ—ºï¸ Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 0: Prerequisites (Optional)   â”‚
â”‚ - Review current architecture       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: Foundation (CRITICAL - Sequential)     â”‚
â”‚ [P1.1] Extract config/constants/types from      â”‚
â”‚        infrastructure â†’ yandex-tracker           â”‚
â”‚        Effort: 6-8h | Impact: HIGH               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ BLOCKS
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: Important Improvements (Can be Parallel)        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ [P2.1] Refactor â”‚  â”‚ [P2.2] Move     â”‚                 â”‚
â”‚ â”‚ ToolRegistry    â”‚  â”‚ generated-index â”‚                 â”‚
â”‚ â”‚ Effort: 4-6h    â”‚  â”‚ Effort: 1-2h    â”‚                 â”‚
â”‚ â”‚ Impact: MEDIUM  â”‚  â”‚ Impact: MEDIUM  â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚ â”‚ [P2.3] Add      â”‚                                       â”‚
â”‚ â”‚ HttpClient      â”‚                                       â”‚
â”‚ â”‚ interface       â”‚                                       â”‚
â”‚ â”‚ Effort: 2-3h    â”‚                                       â”‚
â”‚ â”‚ Impact: MEDIUM  â”‚                                       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: Nice to Have (Optional, Can Parallel)  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚ [P3.1] DRY   â”‚  â”‚ [P3.2] Betterâ”‚              â”‚
â”‚ â”‚ text utils   â”‚  â”‚ LRU cache    â”‚              â”‚
â”‚ â”‚ Effort: 0.5h â”‚  â”‚ Effort: 1-2h â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚ â”‚ [P3.3] Sharedâ”‚                                 â”‚
â”‚ â”‚ test utils   â”‚                                 â”‚
â”‚ â”‚ Effort: 3-4h â”‚                                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 0: Prerequisites (Optional)

**Time:** 1-2 hours
**Status:** Optional (can skip)

### Tasks

- [ ] Review ARCHITECTURE.md for current patterns
- [ ] Check existing yandex-tracker structure
- [ ] Identify all files that reference infrastructure config
- [ ] Plan backward compatibility strategy (if needed)

**Deliverables:**
- Migration checklist
- List of affected files

---

## Phase 1: Foundation (CRITICAL - Must Do)

**Time:** 6-8 hours
**Execution:** SEQUENTIAL (cannot parallelize)
**Why First:** Blocks all other framework improvements

### [P1.1] Extract Domain Code from Infrastructure

**Priority:** ğŸ”´ CRITICAL
**Effort:** 6-8 hours
**Impact:** HIGH (unblocks reusability)

#### Files to Move

**1. Configuration (372 lines)**
```bash
# Source
packages/framework/infrastructure/src/config.ts

# Destination
packages/servers/yandex-tracker/src/config/
â”œâ”€â”€ server-config.ts        # ServerConfig interface
â”œâ”€â”€ config-loader.ts         # loadConfig() function
â””â”€â”€ index.ts
```

**2. Constants (40 lines, partial)**
```bash
# Keep in infrastructure (generic):
- HttpStatusCode enum
- Generic timeout/batch defaults

# Move to yandex-tracker:
- DEFAULT_API_BASE = 'https://api.tracker.yandex.net'
- ENV_VAR_NAMES (YANDEX_TRACKER_*, etc.)
- DEFAULT_TOOL_DISCOVERY_MODE
- DEFAULT_ESSENTIAL_TOOLS
```

**3. Entity Cache Key (46 lines)**
```bash
# Source
packages/framework/infrastructure/src/cache/entity-cache-key.ts

# Destination
packages/servers/yandex-tracker/src/cache/entity-cache-key.ts

# Or make generic in infrastructure:
class EntityCacheKey<TType extends string> {
  static createKey(type: TType, id: string): string { /*...*/ }
}
```

**4. Types (289 lines, partial)**
```bash
# Keep in infrastructure (generic):
- HttpStatusCode
- ApiError (discriminated union)
- QueryParams, QueryParamValue
- ToolCallParams, ToolResult
- BatchResult, FulfilledResult, RejectedResult

# Move to yandex-tracker:
- ServerConfig
- ParsedCategoryFilter
- LogLevel (or keep generic)
```

#### Steps

1. **Create new files in yandex-tracker** (1-2h)
   ```bash
   mkdir -p packages/servers/yandex-tracker/src/config
   # Create server-config.ts, config-loader.ts, index.ts
   # Move domain-specific code
   ```

2. **Update infrastructure** (1-2h)
   - Remove domain-specific code
   - Keep only generic types/utilities
   - Update exports in `infrastructure/src/index.ts`

3. **Update imports** (2-3h)
   ```bash
   # Find all files importing from infrastructure
   grep -r "from '@mcp-framework/infrastructure'" packages/servers/yandex-tracker/src

   # Update to import from local config
   # Example:
   # Before: import { ServerConfig } from '@mcp-framework/infrastructure';
   # After:  import { ServerConfig } from '#config/server-config.js';
   ```

4. **Update tests** (1-2h)
   - Move/update config tests to yandex-tracker
   - Update infrastructure tests

5. **Validate** (30min)
   ```bash
   npm run validate:quiet
   npm run build
   ```

#### Success Criteria

- [ ] Infrastructure builds without domain code
- [ ] Yandex-tracker builds with local config
- [ ] All tests pass
- [ ] No grep hits for "yandex\|tracker\|issue\|queue" in infrastructure/src

#### Risks & Mitigation

**Risk:** Breaking existing imports in yandex-tracker
**Mitigation:** Use search & replace, test thoroughly

**Risk:** Circular dependency created
**Mitigation:** Keep yandex-tracker importing from infrastructure (not vice versa)

---

## Phase 2: Important Improvements (Can Parallel)

**Time:** 7-11 hours total (can do in 4-6h if parallel)
**Execution:** Can run 2-3 tasks in parallel

### [P2.1] Refactor ToolRegistry

**Priority:** ğŸŸ¡ IMPORTANT
**Effort:** 4-6 hours
**Impact:** MEDIUM (code quality, maintainability)
**Can run parallel with:** P2.2, P2.3

#### Current State
- `tool-registry.ts`: 549 lines (exceeds 400 limit)
- Multiple responsibilities

#### Target Structure
```
packages/framework/core/src/tool-registry/
â”œâ”€â”€ tool-registry.ts         (~200 lines)
â”œâ”€â”€ tool-filter.service.ts   (~150 lines)
â”œâ”€â”€ tool-sorter.ts           (~80 lines)
â”œâ”€â”€ types.ts                 (~50 lines)
â”œâ”€â”€ index.ts
â””â”€â”€ README.md
```

#### Steps

1. **Create new files** (30min)
   ```bash
   mkdir packages/framework/core/src/tool-registry
   mv packages/framework/core/src/tool-registry.ts \
      packages/framework/core/src/tool-registry/tool-registry.ts
   ```

2. **Extract ToolFilterService** (2-3h)
   ```typescript
   // tool-filter.service.ts
   export class ToolFilterService {
     filterByCategories(tools: BaseTool[], filter: ParsedCategoryFilter): BaseTool[];
     applyDisabledFilter(tools: BaseTool[], filter: ParsedCategoryFilter): BaseTool[];
     validateCategories(filter: ParsedCategoryFilter, known: Set<string>): void;
   }
   ```

3. **Extract ToolSorter** (1h)
   ```typescript
   // tool-sorter.ts
   export class ToolSorter {
     sortByPriority(tools: BaseTool[]): BaseTool[];
   }
   ```

4. **Update ToolRegistry** (1-2h)
   - Inject FilterService and Sorter
   - Delegate filtering/sorting
   - Keep only registration logic

5. **Update tests** (1h)
   - Split tests into registry/filter/sorter
   - Test each class independently

6. **Validate** (30min)
   ```bash
   npm run validate:quiet -w @mcp-framework/core
   wc -l packages/framework/core/src/tool-registry/tool-registry.ts
   # Should be < 250 lines
   ```

#### Success Criteria

- [ ] tool-registry.ts < 250 lines
- [ ] ToolFilterService < 200 lines
- [ ] ToolSorter < 100 lines
- [ ] All tests pass
- [ ] No functionality lost

---

### [P2.2] Move generated-index.ts to Yandex-Tracker

**Priority:** ğŸŸ¡ IMPORTANT
**Effort:** 1-2 hours
**Impact:** MEDIUM (reusability)
**Depends on:** P1.1 (infrastructure cleanup)
**Can run parallel with:** P2.1, P2.3

#### Steps

1. **Move file** (15min)
   ```bash
   mv packages/framework/search/src/generated-index.ts \
      packages/servers/yandex-tracker/src/tools/tool-index.ts
   ```

2. **Update search/src/index.ts** (5min)
   ```typescript
   // Remove this line:
   export { TOOL_SEARCH_INDEX } from './generated-index.js';

   // Keep (for dynamic index):
   export { buildIndexFromRegistry } from './utils/build-index-from-registry.js';
   ```

3. **Update yandex-tracker composition-root** (30min)
   ```typescript
   // composition-root/search.module.ts
   import { TOOL_SEARCH_INDEX } from '#tools/tool-index.js';

   const searchEngine = new ToolSearchEngine(
     TOOL_SEARCH_INDEX,  // Use local index
     toolRegistry,
     strategy
   );
   ```

4. **Update generation script** (30min)
   ```bash
   # packages/servers/yandex-tracker/package.json
   "scripts": {
     "generate:index": "tsx scripts/generate-tool-index.ts"
   }
   ```

5. **Validate** (15min)
   ```bash
   npm run build -w @mcp-framework/search
   npm run build -w @mcp-server/yandex-tracker
   npm run validate:quiet
   ```

#### Success Criteria

- [ ] Search package builds without domain index
- [ ] Yandex-tracker uses local index
- [ ] Search can still be used with dynamic index
- [ ] All tests pass

---

### [P2.3] Add HttpClient Interface

**Priority:** ğŸŸ¡ IMPORTANT
**Effort:** 2-3 hours
**Impact:** MEDIUM (testability, DIP compliance)
**Can run parallel with:** P2.1, P2.2

#### Steps

1. **Create interface** (30min)
   ```typescript
   // infrastructure/src/http/client/http-client.interface.ts
   export interface IHttpClient {
     get<T>(path: string, params?: QueryParams): Promise<T>;
     post<T>(path: string, data?: unknown): Promise<T>;
     patch<T>(path: string, data?: unknown): Promise<T>;
     delete<T>(path: string): Promise<T>;
   }
   ```

2. **Rename class** (15min)
   ```typescript
   // http-client.ts
   export class AxiosHttpClient implements IHttpClient {
     // ... existing code
   }
   ```

3. **Update exports** (5min)
   ```typescript
   // infrastructure/src/http/index.ts
   export type { IHttpClient } from './client/http-client.interface.js';
   export { AxiosHttpClient } from './client/http-client.js';
   ```

4. **Update yandex-tracker** (1h)
   ```typescript
   // Use interface type
   constructor(
     private readonly httpClient: IHttpClient,  // Was: HttpClient
     // ...
   ) {}
   ```

5. **Add mock for tests** (30min)
   ```typescript
   // infrastructure/tests/mocks/mock-http-client.ts
   export class MockHttpClient implements IHttpClient {
     // ...
   }
   ```

6. **Validate** (30min)
   ```bash
   npm run validate:quiet
   ```

#### Success Criteria

- [ ] IHttpClient interface defined
- [ ] AxiosHttpClient implements IHttpClient
- [ ] Yandex-tracker uses interface type
- [ ] All tests pass
- [ ] MockHttpClient available for tests

---

## Phase 3: Nice to Have (Optional)

**Time:** 4.5-7 hours total
**Execution:** Can run all in parallel
**Status:** Optional (low priority)

### [P3.1] Extract Text Utils (DRY)

**Priority:** ğŸŸ¢ NICE TO HAVE
**Effort:** 30 minutes
**Impact:** LOW (reduces 20 lines duplication)
**Can run parallel with:** P3.2, P3.3

#### Steps

1. **Create utils file** (10min)
   ```typescript
   // search/src/utils/text-utils.ts
   export function tokenize(text: string): string[] { /*...*/ }
   export function getShortDescription(description: string): string { /*...*/ }
   ```

2. **Update imports** (15min)
   ```typescript
   // engine/tool-search-engine.ts
   import { tokenize, getShortDescription } from '../utils/text-utils.js';
   ```

3. **Validate** (5min)
   ```bash
   npm run validate:quiet -w @mcp-framework/search
   ```

---

### [P3.2] Improve LRU Cache

**Priority:** ğŸŸ¢ NICE TO HAVE
**Effort:** 1-2 hours
**Impact:** LOW (better hit rate for frequent queries)
**Can run parallel with:** P3.1, P3.3

#### Current

```typescript
// Simple FIFO (first inserted, first deleted)
if (this.cache.size > this.MAX_CACHE_SIZE) {
  const firstKey = this.cache.keys().next().value;
  this.cache.delete(firstKey);
}
```

#### Target

```typescript
// True LRU (least recently used)
get(key: K): V | undefined {
  const value = this.cache.get(key);
  if (value !== undefined) {
    // Move to end (most recently used)
    this.cache.delete(key);
    this.cache.set(key, value);
  }
  return value;
}
```

#### Options

**Option 1:** Implement simple LRU (1h)
**Option 2:** Use `lru-cache` package (30min, adds dependency)

**Recommendation:** Option 1 (no new dependency)

---

### [P3.3] Create Shared Test Utils

**Priority:** ğŸŸ¢ NICE TO HAVE
**Effort:** 3-4 hours
**Impact:** LOW (reduces test duplication)
**Trade-off:** Adds dependency between test files

#### Structure

```
packages/framework/test-utils/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mocks/
â”‚   â”‚   â”œâ”€â”€ mock-logger.ts
â”‚   â”‚   â”œâ”€â”€ mock-http-client.ts
â”‚   â”‚   â”œâ”€â”€ mock-cache.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â””â”€â”€ test-data.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### Verdict

**SKIP** - Not worth the effort
- Low duplication (each package has 2-3 test files)
- Adds complexity (new package, dependencies)
- Tests should be isolated anyway

---

## ğŸ“Š Estimated Timeline

### Sequential Execution (One Person)

| Phase | Time | Can Start After |
|-------|------|-----------------|
| Phase 0 (optional) | 1-2h | Immediately |
| Phase 1.1 (critical) | 6-8h | Phase 0 (or immediately) |
| Phase 2.1 | 4-6h | Phase 1.1 |
| Phase 2.2 | 1-2h | Phase 1.1 |
| Phase 2.3 | 2-3h | Phase 1.1 |
| Phase 3 (optional) | 4.5-7h | Any time |
| **Total** | **14-22h** | 2-3 days |

### Parallel Execution (Multiple People or Sessions)

| Phase | Time | Parallelizable |
|-------|------|----------------|
| Phase 0 (optional) | 1-2h | No (prep work) |
| Phase 1.1 (critical) | 6-8h | No (foundation) |
| Phase 2 (all tasks) | 4-6h | **YES** (can do 2.1, 2.2, 2.3 together) |
| Phase 3 (optional) | 1-2h | **YES** (can do all together) |
| **Total** | **8-12h** | 1-2 days |

---

## âœ… Definition of Done

### Phase 1
- [ ] No grep hits for domain terms in infrastructure/src
- [ ] Infrastructure builds without yandex-tracker references
- [ ] Yandex-tracker has local config module
- [ ] All tests pass
- [ ] `npm run validate:quiet` succeeds

### Phase 2
- [ ] ToolRegistry < 250 lines
- [ ] generated-index.ts moved to yandex-tracker
- [ ] IHttpClient interface defined and used
- [ ] All tests pass

### Phase 3
- [ ] (Optional) Text utils extracted
- [ ] (Optional) LRU cache improved
- [ ] All tests pass

---

## ğŸ”— Related Files

- [Framework Packages Summary](./2.1_framework_packages_summary.md)
- [Infrastructure Analysis](./2.1_infrastructure_analysis.md)
- [Core Analysis](./2.1_core_analysis.md)
- [Search Analysis](./2.1_search_analysis.md)
