# Test Coverage - Execution Plan

**Дата:** 2025-11-21
**Текущий coverage:** 89.0% average
**Целевой coverage:** 95%+ average
**Текущий Grade:** B+ (8.2/10)

---

## Dependency Analysis

### Можно делать сейчас (не зависит от рефакторинга)

✅ **Framework packages:**
- Core: ZodJsonSchemaAdapter - стабильный компонент
- Search: ToolSearchEngine - стабильный компонент
- Infrastructure: HttpClient - стабильный компонент
- Infrastructure: Logger - стабильный компонент

✅ **Smoke tests:**
- Не зависят от внутренней архитектуры
- Тестируют public API и critical paths

### Ждем архитектурных изменений

⏳ **После рефакторинга (из Phase 2):**
- DI container tests - если будет рефакторинг composition-root
- Facade integration tests - если будет split на меньшие классы
- Operation tests - если будет изменение базовых классов

**Стратегия:**
1. Делаем Phase 1 полностью (critical framework + smoke tests)
2. Делаем Phase 2 частично (Logger, branches)
3. Откладываем DI tests до завершения Phase 2 рефакторинга

---

## Phase 1: Critical Gaps (P0 - немедленно)

**Цель:** Покрыть critical framework components и добавить smoke tests
**Время:** 7.5 часов
**Impact:** Coverage 89% → 95%, Grade B+ → A-

### Task 1.1: Core - ZodJsonSchemaAdapter

**Файл:** `packages/framework/core/src/definition/zod-json-schema-adapter.ts`
**Текущий coverage:** 53.84%
**Целевой coverage:** 95%+
**Непокрытые строки:** 69-75, 86-101, 106, 133-149

**Добавить тесты для:**
1. ✅ Все Zod primitive types:
   - `z.string()`, `z.number()`, `z.boolean()`
   - `z.null()`, `z.undefined()`, `z.void()`
   - `z.any()`, `z.unknown()`

2. ✅ Zod modifiers:
   - `z.optional()`, `z.nullable()`
   - `z.default()`, `z.describe()`
   - `z.min()`, `z.max()` для string/number

3. ✅ Complex types:
   - `z.array()`, `z.object()`
   - `z.union()`, `z.intersection()`
   - `z.record()`, `z.tuple()`

4. ✅ Edge cases:
   - Empty schemas
   - Nested objects
   - Circular references (if supported)
   - Invalid schema types

**Новый файл:** `tests/definition/zod-json-schema-adapter.extended.test.ts`
**Estimate:** 2 часа (~20 тестов)

### Task 1.2: Search - ToolSearchEngine

**Файл:** `packages/framework/search/src/engine/tool-search-engine.ts`
**Текущий coverage:** 71.42%
**Целевой coverage:** 95%+
**Непокрытые строки:** 56-108, 152, 207

**Добавить тесты для:**
1. ✅ Search strategies:
   - Exact match vs fuzzy match
   - Name search vs description search
   - Category filtering
   - Weighted combined results

2. ✅ Edge cases:
   - Empty query
   - Query with special chars
   - No results found
   - Multiple results with same score

3. ✅ Performance scenarios:
   - Large tool set (100+ tools)
   - Long queries (>100 chars)
   - Complex queries

4. ✅ Error handling:
   - Invalid query
   - Malformed tool definitions

**Новый файл:** `tests/engine/tool-search-engine.extended.test.ts`
**Estimate:** 2 часа (~15 тестов)

### Task 1.3: Infrastructure - HttpClient

**Файл:** `packages/framework/infrastructure/src/http/client/http-client.ts`
**Текущий coverage:** 69.69%
**Целевой coverage:** 90%+
**Непокрытые строки:** 66-71, 78-84, 145

**Добавить тесты для:**
1. ✅ Retry logic:
   - Успешный retry после временной ошибки
   - Exhausted retries (max retries reached)
   - Exponential backoff timing
   - Retry на разных HTTP status codes

2. ✅ Timeout scenarios:
   - Request timeout
   - Connection timeout
   - Response timeout

3. ✅ Error handling:
   - Network errors (ECONNREFUSED, etc.)
   - HTTP 4xx errors (не должны retry)
   - HTTP 5xx errors (должны retry)
   - Malformed response

4. ✅ Headers & auth:
   - Custom headers
   - Authorization header
   - Content-Type handling

**Новый файл:** `tests/http/client/http-client.extended.test.ts`
**Estimate:** 1.5 часа (~10 тестов)

### Task 1.4: Add Smoke Tests

**Текущее:** 1 smoke test file
**Целевое:** 6 smoke test files

#### 1.4.1: MCP Server Startup/Shutdown

**Файл:** `packages/servers/yandex-tracker/tests/smoke/mcp-server-lifecycle.smoke.test.ts`

**Тесты:**
- Server starts successfully
- Server responds to ping
- Server lists all tools
- Server shuts down cleanly
- Server handles restart

**Estimate:** 30 минут

#### 1.4.2: Real API Connectivity

**Файл:** `packages/servers/yandex-tracker/tests/smoke/api-connectivity.smoke.test.ts`

**Тесты:**
- Ping operation succeeds
- Authentication works (с valid token)
- Rate limiting respected
- Timeout handling

**Note:** Требует test credentials, может быть skipped в CI

**Estimate:** 30 минут

#### 1.4.3: End-to-End Tool Execution

**Файл:** `packages/servers/yandex-tracker/tests/smoke/e2e-tool-execution.smoke.test.ts`

**Тесты:**
- Execute GetIssues tool end-to-end
- Tool → Facade → Operation → HTTP flow works
- Response parsing correct
- Error handling в full flow

**Estimate:** 30 минут

#### 1.4.4: Tool Search Integration

**Файл:** `packages/servers/yandex-tracker/tests/smoke/tool-search.smoke.test.ts`

**Тесты:**
- Search finds relevant tools by name
- Search finds tools by description
- Search handles typos (fuzzy match)
- SearchTools helper tool works

**Estimate:** 20 минут

#### 1.4.5: DI Container Smoke Test

**Файл:** `packages/servers/yandex-tracker/tests/smoke/di-container.smoke.test.ts`

**Тесты:**
- All DI tokens resolve successfully
- No circular dependencies
- Singletons return same instance
- Container cleanup works

**Estimate:** 20 минут

---

## Phase 2: Important Improvements (P1 - желательно)

**Цель:** Улучшить architecture confidence
**Время:** 3.5 часа
**Impact:** Coverage 95% → 96%, Grade A- → A

### Task 2.1: DI Container Integration Tests

**Статус:** ⏳ **ОТЛОЖЕНО до Phase 2 рефакторинга**

**Причина:** Если в Phase 2 архитектурного анализа будет рефакторинг composition-root или изменение DI structure, эти тесты потребуют переписывания.

**Когда делать:** После завершения Phase 2.2 Yandex-Tracker Analysis и принятия решений по архитектуре.

**Файл:** `packages/servers/yandex-tracker/tests/composition-root/di-integration.test.ts`

**Тесты (при выполнении):**
- All service tokens defined
- All operation tokens defined
- All tool tokens defined
- Lifecycle management works
- Error on missing dependency
- Error on circular dependency

**Estimate:** 2 часа (~15 тестов)

### Task 2.2: Infrastructure - Logger

**Файл:** `packages/framework/infrastructure/src/logging/logger.ts`
**Текущий coverage:** 75.8%
**Целевой coverage:** 90%+
**Непокрытые строки:** 58, 89-91, 94, 134, 165, 178-179, 218, 228

**Добавить тесты для:**
1. ✅ Log levels:
   - Trace level logging
   - Fatal level logging
   - Level filtering

2. ✅ Formatting:
   - Pretty print mode
   - JSON mode
   - Custom formatters

3. ✅ Child loggers:
   - Context inheritance
   - Context isolation
   - Nested child loggers (уже есть, расширить)

4. ✅ Error scenarios:
   - Logging with circular objects
   - Logging with undefined/null
   - File write errors (if file logging)

**Новый файл:** `tests/logging/logger.extended.test.ts`
**Estimate:** 1 час (~10 тестов)

### Task 2.3: Core - Branches Coverage

**Файл:** `packages/framework/core/src/definition/zod-json-schema-adapter.ts`
**Текущий branches:** 84.9%
**Целевой branches:** 85%+

**Добавить тесты для:**
- Branch условия в адаптере (if/else paths)
- Error branches
- Edge cases в type conversions

**Estimate:** 30 минут (~2 теста)

---

## Phase 3: Polish (P2 - опционально)

**Цель:** Professional quality & long-term maintainability
**Время:** 6 часов
**Impact:** Maintenance cost reduction, documentation

### Task 3.1: Optimize Test Code

**Текущий test/source ratio:** 177%
**Целевой ratio:** 120-150%

**Действия:**
1. ✅ Review smoke tests (209 тестов в 1 файле):
   - Возможно, разделить на модули
   - Удалить избыточные проверки

2. ✅ Refactor verbose integration tests:
   - Выделить общие setup/teardown
   - Использовать больше test helpers

3. ✅ Remove duplicate assertions:
   - Некоторые integration тесты дублируют unit тесты

**Estimate:** 3 часа

### Task 3.2: Performance Monitoring

**Добавить:**
1. CI check для slow tests:
   - Fail если test >1s (кроме известных)
   - Report медленных тестов

2. Test performance dashboard:
   - Track test duration trends
   - Identify performance regressions

**Estimate:** 2 часа

### Task 3.3: Test Documentation

**Добавить README для test helpers:**
- `tests/helpers/README.md` - как использовать mock factories
- `tests/README.md` - обновить с новыми smoke tests
- Документировать DI testing patterns

**Estimate:** 1 час

---

## Execution Order

### Recommended: Phase 1 Only (минимум)

**Day 1:**
1. Morning (4 hours):
   - Task 1.1: ZodJsonSchemaAdapter (2h)
   - Task 1.2: ToolSearchEngine (2h)

2. Afternoon (3.5 hours):
   - Task 1.3: HttpClient (1.5h)
   - Task 1.4: Smoke tests (2h)

**Total:** 7.5 hours
**Result:** Coverage 89% → 95%, Grade B+ → A-

### Optimal: Phase 1 + Phase 2 (без DI tests)

**Day 1:** Phase 1 (7.5 hours)

**Day 2:**
1. Morning (1.5 hours):
   - Task 2.2: Logger (1h)
   - Task 2.3: Branches (0.5h)

**Total:** 9 hours
**Result:** Coverage 89% → 96%, Grade B+ → A (почти)

### Comprehensive: All Phases

**Day 1:** Phase 1 (7.5h)
**Day 2:** Phase 2 (3.5h) + Phase 3 начало (3h)
**Day 3:** Phase 3 завершение (3h)

**Total:** 17 hours
**Result:** Grade A+, optimized maintenance

---

## Success Criteria

### Phase 1 Done

- ✅ ZodJsonSchemaAdapter ≥95%
- ✅ ToolSearchEngine ≥95%
- ✅ HttpClient ≥90%
- ✅ 6 smoke test files
- ✅ All packages pass `npm run test:coverage`
- ✅ Average coverage ≥95%

### Phase 2 Done

- ✅ Logger ≥90%
- ✅ Core branches ≥85%
- ⏳ DI integration tests (после Phase 2 рефакторинга)
- ✅ Average coverage ≥96%

### Phase 3 Done

- ✅ Test/source ratio ≤150%
- ✅ CI performance checks
- ✅ Test documentation complete

---

## Risk Mitigation

### If Phase 1 Takes Longer

**Reduce scope:**
- ZodJsonSchemaAdapter: Только primitive types, отложить complex types
- ToolSearchEngine: Только основные strategies, отложить edge cases
- Smoke tests: Минимум 3 вместо 5

**Minimum viable:** 5 hours, coverage 92-93%

### If Phase 2 Рефакторинг Происходит

**DI tests:**
- ⏳ Ждем завершения рефакторинга
- Создаем tests после новой архитектуры
- Оцениваем заново (может потребоваться больше/меньше времени)

### If Tests Fail During Development

**Troubleshooting:**
1. Check mock setup (DI container, HTTP client mocks)
2. Verify test isolation (beforeEach/afterEach)
3. Check async handling (await, promises)
4. Review error messages carefully

---

## Validation

### После каждого task

```bash
# Run tests для измененного пакета
cd packages/framework/core
npm run test:coverage

# Проверить пороги
# Должно быть: Lines ≥90%, Functions ≥90%, Branches ≥85%
```

### После Phase 1

```bash
# Полная валидация
npm run test:coverage

# Все пакеты должны пройти пороги
# Average coverage ≥95%
```

### После Phase 2

```bash
# Финальная валидация
npm run validate

# Все должно быть green
```

---

## Final Recommendations

**Рекомендуемый путь:**

1. ✅ **Execute Phase 1** (7.5 hours) - обязательно
   - Покрывает critical gaps
   - Добавляет smoke tests
   - Достигает Grade A-

2. ⏳ **Wait for Phase 2 Refactoring** results
   - Смотрим что будет рефакториться
   - Определяем scope для DI tests

3. ✅ **Execute Phase 2** (partial, 1.5h) - после рефакторинга
   - Logger + Branches (не зависят от рефакторинга)
   - DI tests после Phase 2 завершения

4. ⚪ **Phase 3** опционально
   - Только если есть время
   - Не критично для quality

**Priority:** Phase 1 > Phase 2 (Logger/Branches) > Phase 2 (DI) > Phase 3

**Expected outcome:** Grade A (9/10) после Phase 1 + Phase 2 partial
