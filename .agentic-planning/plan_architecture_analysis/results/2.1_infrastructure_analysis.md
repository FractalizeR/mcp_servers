# Infrastructure Package Analysis

**Date:** 2025-11-21
**Package:** `@mcp-framework/infrastructure`
**Path:** `packages/framework/infrastructure/`

---

## üìä Metrics

| Metric | Value | Status |
|--------|-------|--------|
| Total LoC | 2106 | ‚úÖ |
| Total files | 23 | ‚úÖ |
| Average LoC per file | 91.6 | ‚úÖ Good |
| Max file size | 372 lines (config.ts) | ‚úÖ Below limit |
| Average imports per file | 1.43 | ‚úÖ Low coupling |
| `any` usage | 0 | ‚úÖ Excellent |
| Files >400 lines | 0 | ‚úÖ |

---

## ‚úÖ Strong Points

### 1. **Excellent Component Design**

**HTTP Client (`http/client/http-client.ts`):**
- ‚úÖ Clean SRP - handles only HTTP requests
- ‚úÖ Proper delegation: retry ‚Üí RetryHandler, errors ‚Üí ErrorMapper
- ‚úÖ Clean interceptor pattern for logging
- ‚úÖ Type-safe with generics

**Logger (`logging/logger.ts`):**
- ‚úÖ Production-ready with Pino
- ‚úÖ Log rotation with `rotating-file-stream`
- ‚úÖ Dual output (stderr + files)
- ‚úÖ Structured logging (JSON)
- ‚úÖ Alerting transport interface (extensibility)
- ‚úÖ Child logger support for request tracing

**ParallelExecutor (`async/parallel-executor.ts`):**
- ‚úÖ Excellent concurrency control with `p-limit`
- ‚úÖ Type-safe BatchResult discriminated union
- ‚úÖ Proper separation: execution vs business logic
- ‚úÖ Detailed metrics and logging
- ‚úÖ Helper methods (isAllSuccess, hasErrors, etc.)

**CacheManager (`cache/cache-manager.interface.ts`):**
- ‚úÖ Strategy Pattern - easy to swap implementations
- ‚úÖ Clean interface (get, set, delete, clear, prune)

### 2. **Low Coupling & High Cohesion**
- Average 1.43 imports per file (excellent!)
- Clear module boundaries
- Minimal dependencies between components

### 3. **Type Safety**
- Zero `any` usage (except in legitimate cases)
- Strong generic types throughout
- Proper use of discriminated unions (ApiError, BatchResult)

### 4. **Proper Code Organization**
- Clear directory structure (http, cache, async, logging)
- Each component in its own module
- No files exceeding limits

---

## üî¥ Critical Problems

### Problem #1: Domain Coupling - Yandex Tracker Specific Code

**Priority:** üî¥ CRITICAL
**SOLID Violation:** SRP, DIP
**Blocks Reusability:** YES

**Files affected:**
1. `config.ts` (372 lines) - **100% domain-specific**
2. `constants.ts` (40 lines) - **Contains Yandex Tracker URLs and env var names**
3. `entity-cache-key.ts` (46 lines) - **EntityType enum with Issue, Queue, Comment, etc.**
4. `types.ts` (289 lines) - **Contains ServerConfig, ParsedCategoryFilter (tool categories), etc.**

**Evidence:**

```typescript
// constants.ts - DOMAIN LEAKAGE
export const DEFAULT_API_BASE = 'https://api.tracker.yandex.net' as const;
export const ENV_VAR_NAMES = {
  YANDEX_TRACKER_TOKEN: 'YANDEX_TRACKER_TOKEN',
  YANDEX_ORG_ID: 'YANDEX_ORG_ID',
  // ...
}

// entity-cache-key.ts - DOMAIN LEAKAGE
export enum EntityType {
  ISSUE = 'issue',
  QUEUE = 'queue',
  USER = 'user',
  COMMENT = 'comment',
  // ...
}

// types.ts - DOMAIN LEAKAGE
export interface ServerConfig {
  /** OAuth —Ç–æ–∫–µ–Ω –¥–ª—è API –Ø–Ω–¥–µ–∫—Å.–¢—Ä–µ–∫–µ—Ä–∞ */
  token: string;
  /** ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–Ø–Ω–¥–µ–∫—Å 360 –¥–ª—è –±–∏–∑–Ω–µ—Å–∞) */
  orgId?: string;
  /** –ë–∞–∑–æ–≤—ã–π URL API */
  apiBase: string;
  // ... tool discovery, essential tools, categories, etc.
}
```

**Why this is CRITICAL:**
- Infrastructure package **cannot be reused** for other projects without Yandex Tracker
- Violates the **Zero Dependencies on Domain** rule (explicitly stated in CLAUDE.md)
- Makes framework packages non-portable
- Tight coupling between infrastructure and yandex-tracker domain

**Impact on SOLID:**
- **SRP:** config.ts mixes infrastructure config loading with domain-specific validation
- **DIP:** Infrastructure depends on domain concepts instead of abstractions

---

## ‚ö†Ô∏è Important Issues

### Problem #2: Missing Interface for HttpClient

**Priority:** üü° IMPORTANT
**SOLID Violation:** DIP, OCP
**Blocks Reusability:** Partially

**Current state:**
- `HttpClient` is a concrete class
- No interface defined
- Direct instantiation via `new HttpClient()`
- Makes testing harder (need to mock concrete class)

**Why this matters:**
- Harder to swap implementations (e.g., `fetch` instead of `axios`)
- Violates Dependency Inversion (depend on abstractions, not concretions)
- Less testable (cannot easily mock)

**Recommendation:**
```typescript
// Good: Define interface
export interface IHttpClient {
  get<T>(path: string, params?: QueryParams): Promise<T>;
  post<T>(path: string, data?: unknown): Promise<T>;
  patch<T>(path: string, data?: unknown): Promise<T>;
  delete<T>(path: string): Promise<T>;
}

// Implementation
export class AxiosHttpClient implements IHttpClient {
  // ...
}
```

---

### Problem #3: HttpConfig Interface Contains Domain Concepts

**Priority:** üü° IMPORTANT
**SOLID Violation:** SRP
**Related to:** Problem #1

**Current state:**
```typescript
// http/client/http-config.interface.ts
export interface HttpConfig {
  /** –ë–∞–∑–æ–≤—ã–π URL API (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'https://api.tracker.yandex.net') */
  baseURL: string;
  /** ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (Yandex Cloud Organization) */
  cloudOrgId?: string;
  // ...
}
```

**Why this is a problem:**
- Comments mention Yandex Tracker explicitly
- `cloudOrgId` is Yandex-specific concept
- Should be generic (e.g., `customHeaders?: Record<string, string>`)

---

## üü¢ Nice to Have

### Improvement #1: Add Cache Implementation

**Priority:** üü¢ NICE TO HAVE
**Effort:** MEDIUM

**Current state:**
- Only `CacheManager` interface and `NoOpCache` stub
- No real in-memory cache implementation

**Recommendation:**
- Add `MemoryCacheManager` implementation using `Map` + TTL
- Would make infrastructure more feature-complete

---

### Improvement #2: Add HttpClient Request/Response Interceptor Interface

**Priority:** üü¢ NICE TO HAVE
**Effort:** LOW

**Current state:**
- Interceptors hardcoded in `setupInterceptors()`
- Not extensible from outside

**Recommendation:**
```typescript
export interface RequestInterceptor {
  onRequest(config: AxiosRequestConfig): AxiosRequestConfig;
  onError(error: unknown): Promise<never>;
}

export interface ResponseInterceptor {
  onResponse(response: AxiosResponse): AxiosResponse;
  onError(error: unknown): Promise<never>;
}

// Add to constructor
constructor(
  config: HttpConfig,
  logger: Logger,
  retryStrategy: RetryStrategy,
  requestInterceptors: RequestInterceptor[] = [],
  responseInterceptors: ResponseInterceptor[] = []
) {
  // ...
}
```

---

## üìã SOLID Compliance

| Principle | Status | Comment |
|-----------|--------|---------|
| **SRP** | ‚ö†Ô∏è | **Violated by config.ts** (mixes infrastructure + domain logic), other components ‚úÖ |
| **OCP** | ‚ö†Ô∏è | **Partially:** interfaces exist but HttpClient has no interface |
| **LSP** | ‚úÖ | No inheritance issues found |
| **ISP** | ‚úÖ | Interfaces are focused (CacheManager, Logger) |
| **DIP** | ‚ùå | **Violated:** Infrastructure depends on domain (config, constants, types), HttpClient is concrete class |

---

## üí° Key Takeaways

### Strengths
1. **Excellent individual component design** (HttpClient, Logger, ParallelExecutor)
2. **Strong type safety** (zero `any`, generics, discriminated unions)
3. **Low coupling** (1.43 imports/file)

### Critical Issues
1. **üî¥ Domain coupling blocks reusability** - config, constants, entity-cache-key, types must be moved to yandex-tracker
2. **üü° Missing abstractions** - HttpClient needs interface

### Priority Actions
1. **Extract domain-specific code** from infrastructure ‚Üí yandex-tracker
2. **Add HttpClient interface** for DIP compliance
3. **Make HttpConfig generic** (remove Yandex-specific fields)

---

## üìà Reusability Assessment

**Current State:** ‚ùå **NOT REUSABLE**

**Reasons:**
- Hardcoded Yandex Tracker API URL
- Yandex-specific config loading (YANDEX_TRACKER_TOKEN, etc.)
- EntityType enum tied to Yandex Tracker domain

**After Fixes:** ‚úÖ **FULLY REUSABLE**

**What's needed:**
- Move config.ts, constants.ts to yandex-tracker
- Make entity-cache-key.ts generic or move to domain layer
- Extract domain types from types.ts

---

## üîó Related Files

- [Core Package Analysis](./2.1_core_analysis.md)
- [Search Package Analysis](./2.1_search_analysis.md)
- [Cross-Package Patterns](./2.1_cross_package_patterns.md)
