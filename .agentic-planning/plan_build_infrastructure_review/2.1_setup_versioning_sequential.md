# 2.1 Настройка механизма версионирования (Sequential)

**Приоритет:** Высокий
**Тип:** Sequential (требует согласования)
**Оценка:** ~1 час

---

## Предварительное решение

Нужно выбрать стратегию версионирования:

**Вариант A: Fixed versioning (все пакеты — одна версия)**
- Проще в управлении
- Подходит для тесно связанных пакетов
- Changesets с `"fixed": [["@mcp-framework/*", "@mcp-server/*"]]`

**Вариант B: Independent versioning (каждый пакет — своя версия)**
- Текущий подход
- Сложнее отслеживать совместимость
- Больше гибкости

**Рекомендация:** Вариант A (Fixed) для framework пакетов, Independent для servers.

---

## Чеклист

### 1. Настроить Changesets

- [ ] Обновить `.changeset/config.json`:

```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.1.1/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [
    ["@mcp-framework/infrastructure", "@mcp-framework/cli", "@mcp-framework/core", "@mcp-framework/search"]
  ],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

### 2. Добавить скрипты версионирования в корневой package.json

- [ ] Добавить `"changeset": "changeset"`
- [ ] Добавить `"version": "changeset version"`
- [ ] Добавить `"release": "npm run build && changeset publish"`

### 3. Синхронизировать версии framework пакетов

- [ ] Установить единую версию для всех framework пакетов (например, 0.2.0)
- [ ] Обновить зависимости между пакетами

**Файлы:**
- `packages/framework/infrastructure/package.json` → version: "0.2.0"
- `packages/framework/cli/package.json` → version: "0.2.0"
- `packages/framework/core/package.json` → version: "0.2.0"
- `packages/framework/search/package.json` → version: "0.2.0"

### 4. Создать скрипт для локальной версии (dev build)

- [ ] Создать `scripts/set-dev-version.ts`
- [ ] Скрипт устанавливает версию `0.0.0-dev.{timestamp}` для локальной разработки
- [ ] Добавить в prebuild hook (опционально)

### 5. Обновить CI workflows

- [ ] Удалить `publish.yml` (дублирует release.yml)
- [ ] Обновить `release.yml`:
  - [ ] Проверять версии ВСЕХ пакетов, не только yandex-tracker
  - [ ] Использовать `changeset publish` вместо `npm publish --workspaces`

**Пример проверки версий:**
```yaml
- name: Verify versions match tag
  run: |
    TAG_VERSION="${GITHUB_REF#refs/tags/v}"
    for pkg in packages/framework/*/package.json packages/servers/*/package.json; do
      PKG_VERSION=$(node -p "require('./$pkg').version")
      PKG_NAME=$(node -p "require('./$pkg').name")
      echo "Checking $PKG_NAME: $PKG_VERSION"
    done
```

### 6. Валидация

- [ ] Запустить `npx changeset status` — проверить статус
- [ ] Создать тестовый changeset
- [ ] Запустить `npx changeset version` — проверить обновление версий
- [ ] Откатить изменения (git checkout)

---

## Критерии завершения

- Changesets настроен для fixed versioning framework пакетов
- CI публикует пакеты корректно
- Локальная сборка не требует тега для работы
