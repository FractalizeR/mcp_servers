# Этап 4.2: Task Tools (parallel)

**Тип выполнения:** parallel (можно выполнять параллельно с 4.1, 4.3)
**Причина:** Независимые tools
**Зависимости:** Этап 3.1 завершён

---

## Задачи

### 4.2.1. GetTaskTool

**Категория:** tasks:read
**Приоритет:** critical

```typescript
// Schema
export const GetTaskParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  taskId: z.string().min(1).describe('ID задачи'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_TASK_TOOL_METADATA: ToolMetadata = {
  name: 'get_task',
  description: '[Tasks/Read] Получить задачу по ID.',
  category: 'tasks',
  subcategory: 'read',
  priority: 'critical',
  tags: ['task', 'get', 'read'],
};
```

### 4.2.2. GetTasksTool (batch)

**Категория:** tasks:read
**Приоритет:** critical

```typescript
// Schema
export const GetTasksParamsSchema = z.object({
  tasks: z.array(z.object({
    projectId: z.string().min(1),
    taskId: z.string().min(1),
  })).min(1).max(100).describe('Список задач для получения'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Tool - использует ParallelExecutor
async execute(params: unknown) {
  const { tasks, fields } = this.validateParams(params, GetTasksParamsSchema).data;

  const refs = tasks.map(t => ({ projectId: t.projectId, taskId: t.taskId }));
  const results = await this.facade.getTasks(refs);

  const filtered = BatchResultProcessor.process(results, task =>
    ResponseFieldFilter.filter(task, fields)
  );

  return this.formatSuccess({
    total: tasks.length,
    successful: filtered.successful,
    failed: filtered.failed,
    fieldsReturned: fields,
  });
}
```

### 4.2.3. GetAllTasksTool

**Категория:** tasks:read
**Приоритет:** high

```typescript
// Schema
export const GetAllTasksParamsSchema = z.object({
  fields: FieldsSchema.describe('Поля для возврата'),
  status: z.enum(['all', 'uncompleted', 'completed']).optional().default('uncompleted')
    .describe('Фильтр по статусу'),
});

// Metadata
export const GET_ALL_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'get_all_tasks',
  description: '[Tasks/Read] Получить все задачи пользователя из всех проектов.',
  category: 'tasks',
  subcategory: 'read',
  priority: 'high',
  tags: ['tasks', 'all', 'list'],
};

// Tool
async execute(params: unknown) {
  const { fields, status } = this.validateParams(params, GetAllTasksParamsSchema).data;

  let tasks = await this.facade.getAllTasks();

  // Фильтр по статусу
  if (status === 'uncompleted') {
    tasks = tasks.filter(t => t.status !== 2);
  } else if (status === 'completed') {
    tasks = tasks.filter(t => t.status === 2);
  }

  const filtered = tasks.map(task => ResponseFieldFilter.filter(task, fields));

  return this.formatSuccess({
    total: filtered.length,
    tasks: filtered,
    fieldsReturned: fields,
  });
}
```

### 4.2.4. SearchTasksTool

**Категория:** tasks:read
**Приоритет:** high

```typescript
// Schema
export const SearchTasksParamsSchema = z.object({
  query: z.string().min(1).describe('Поисковый запрос (по title и content)'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const SEARCH_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'search_tasks',
  description: '[Tasks/Read] Поиск задач по тексту в названии и описании.',
  category: 'tasks',
  subcategory: 'read',
  priority: 'high',
  tags: ['tasks', 'search', 'find', 'query'],
};
```

### 4.2.5. CreateTaskTool

**Категория:** tasks:write
**Приоритет:** critical

```typescript
// Schema
export const CreateTaskParamsSchema = z.object({
  title: z.string().min(1).max(500).describe('Название задачи'),
  projectId: z.string().optional().describe('ID проекта (по умолчанию Inbox)'),
  content: z.string().optional().describe('Описание задачи'),
  priority: z.number().int().min(0).max(5).optional()
    .describe('Приоритет: 0=нет, 1=низкий, 3=средний, 5=высокий'),
  dueDate: z.string().optional().describe('Срок выполнения (ISO date)'),
  startDate: z.string().optional().describe('Дата начала (ISO date)'),
  tags: z.array(z.string()).optional().describe('Теги'),
  items: z.array(z.object({
    title: z.string().min(1),
  })).optional().describe('Подзадачи/чек-лист'),
  fields: FieldsSchema.optional().describe('Поля для возврата'),
});

// Metadata
export const CREATE_TASK_TOOL_METADATA: ToolMetadata = {
  name: 'create_task',
  description: '[Tasks/Write] Создать новую задачу.',
  category: 'tasks',
  subcategory: 'write',
  priority: 'critical',
  tags: ['task', 'create', 'new', 'add'],
};
```

### 4.2.6. BatchCreateTasksTool

**Категория:** tasks:write
**Приоритет:** high

```typescript
// Schema
export const BatchCreateTasksParamsSchema = z.object({
  tasks: z.array(z.object({
    title: z.string().min(1).max(500),
    projectId: z.string().optional(),
    content: z.string().optional(),
    priority: z.number().int().min(0).max(5).optional(),
    dueDate: z.string().optional(),
  })).min(1).max(50).describe('Задачи для создания (max 50)'),
  fields: FieldsSchema.optional().describe('Поля для возврата'),
});

// Metadata
export const BATCH_CREATE_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'batch_create_tasks',
  description: '[Tasks/Write] Массовое создание задач (до 50 за раз).',
  category: 'tasks',
  subcategory: 'write',
  priority: 'high',
  tags: ['tasks', 'batch', 'create', 'bulk'],
};
```

### 4.2.7. UpdateTaskTool

**Категория:** tasks:write
**Приоритет:** critical

```typescript
// Schema
export const UpdateTaskParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  taskId: z.string().min(1).describe('ID задачи'),
  title: z.string().min(1).max(500).optional().describe('Новое название'),
  content: z.string().optional().describe('Новое описание'),
  priority: z.number().int().min(0).max(5).optional().describe('Новый приоритет'),
  dueDate: z.string().nullable().optional().describe('Новый срок (null для удаления)'),
  tags: z.array(z.string()).optional().describe('Новые теги'),
  fields: FieldsSchema.optional().describe('Поля для возврата'),
});

// Metadata
export const UPDATE_TASK_TOOL_METADATA: ToolMetadata = {
  name: 'update_task',
  description: '[Tasks/Write] Обновить задачу.',
  category: 'tasks',
  subcategory: 'write',
  priority: 'critical',
  tags: ['task', 'update', 'edit', 'modify'],
};
```

### 4.2.8. CompleteTaskTool

**Категория:** tasks:write
**Приоритет:** high

```typescript
// Schema
export const CompleteTaskParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  taskId: z.string().min(1).describe('ID задачи'),
});

// Metadata
export const COMPLETE_TASK_TOOL_METADATA: ToolMetadata = {
  name: 'complete_task',
  description: '[Tasks/Write] Отметить задачу как выполненную.',
  category: 'tasks',
  subcategory: 'write',
  priority: 'high',
  tags: ['task', 'complete', 'done', 'finish'],
};

// Tool
async execute(params: unknown) {
  const { projectId, taskId } = this.validateParams(params, CompleteTaskParamsSchema).data;

  // Получить название для подтверждения
  const task = await this.facade.getTask(projectId, taskId);

  await this.facade.completeTask(projectId, taskId);

  return this.formatSuccess({
    message: `Задача "${task.title}" отмечена как выполненная`,
    completedTaskId: taskId,
  });
}
```

### 4.2.9. DeleteTaskTool

**Категория:** tasks:write
**Приоритет:** normal

```typescript
// Schema
export const DeleteTaskParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  taskId: z.string().min(1).describe('ID задачи'),
});

// Metadata
export const DELETE_TASK_TOOL_METADATA: ToolMetadata = {
  name: 'delete_task',
  description: '[Tasks/Write] Удалить задачу.',
  category: 'tasks',
  subcategory: 'write',
  priority: 'normal',
  tags: ['task', 'delete', 'remove'],
};
```

### 4.2.10. GetTasksByPriorityTool

**Категория:** tasks:read
**Приоритет:** normal

```typescript
// Schema
export const GetTasksByPriorityParamsSchema = z.object({
  priority: z.number().int().min(0).max(5)
    .describe('Приоритет: 0=нет, 1=низкий, 3=средний, 5=высокий'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_TASKS_BY_PRIORITY_TOOL_METADATA: ToolMetadata = {
  name: 'get_tasks_by_priority',
  description: '[Tasks/Read] Получить задачи с указанным приоритетом.',
  category: 'tasks',
  subcategory: 'read',
  priority: 'normal',
  tags: ['tasks', 'priority', 'filter'],
};
```

---

## Валидация

```bash
npm run typecheck
npm run lint
```

---

## Чек-лист завершения

- [ ] 10 tools созданы
- [ ] GetTasksTool использует batch processing
- [ ] ResponseFieldFilter применяется везде
- [ ] Metadata содержит все необходимые поля
- [ ] `npm run typecheck` проходит
