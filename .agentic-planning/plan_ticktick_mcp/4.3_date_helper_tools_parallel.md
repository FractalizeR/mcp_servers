# Этап 4.3: Date-based и Helper Tools (parallel)

**Тип выполнения:** parallel (можно выполнять параллельно с 4.1, 4.2)
**Причина:** Независимые tools
**Зависимости:** Этап 3.1 завершён

---

## Date-based Tools (категория tasks:date)

### 4.3.1. GetTasksDueTodayTool

**Приоритет:** high

```typescript
// Schema
export const GetTasksDueTodayParamsSchema = z.object({
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_TASKS_DUE_TODAY_TOOL_METADATA: ToolMetadata = {
  name: 'get_tasks_due_today',
  description: '[Tasks/Date] Получить задачи со сроком на сегодня.',
  category: 'tasks',
  subcategory: 'date',
  priority: 'high',
  tags: ['tasks', 'today', 'due', 'deadline'],
};

// Tool
async execute(params: unknown) {
  const { fields } = this.validateParams(params, GetTasksDueTodayParamsSchema).data;

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  const tasks = await this.facade.getTasksDueInRange(today, tomorrow);
  const filtered = tasks.map(t => ResponseFieldFilter.filter(t, fields));

  return this.formatSuccess({
    date: today.toISOString().split('T')[0],
    total: filtered.length,
    tasks: filtered,
    fieldsReturned: fields,
  });
}
```

### 4.3.2. GetTasksDueTomorrowTool

**Приоритет:** normal

```typescript
// Metadata
export const GET_TASKS_DUE_TOMORROW_TOOL_METADATA: ToolMetadata = {
  name: 'get_tasks_due_tomorrow',
  description: '[Tasks/Date] Получить задачи со сроком на завтра.',
  category: 'tasks',
  subcategory: 'date',
  priority: 'normal',
  tags: ['tasks', 'tomorrow', 'due'],
};

// Tool - аналогично, но tomorrow → day after tomorrow
```

### 4.3.3. GetTasksDueInDaysTool

**Приоритет:** normal

```typescript
// Schema
export const GetTasksDueInDaysParamsSchema = z.object({
  days: z.number().int().min(1).max(365).describe('Количество дней'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_TASKS_DUE_IN_DAYS_TOOL_METADATA: ToolMetadata = {
  name: 'get_tasks_due_in_days',
  description: '[Tasks/Date] Получить задачи со сроком в ближайшие N дней.',
  category: 'tasks',
  subcategory: 'date',
  priority: 'normal',
  tags: ['tasks', 'due', 'days', 'upcoming'],
};

// Tool
async execute(params: unknown) {
  const { days, fields } = this.validateParams(params, GetTasksDueInDaysParamsSchema).data;

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const endDate = new Date(today);
  endDate.setDate(endDate.getDate() + days);

  const tasks = await this.facade.getTasksDueInRange(today, endDate);
  const filtered = tasks.map(t => ResponseFieldFilter.filter(t, fields));

  return this.formatSuccess({
    fromDate: today.toISOString().split('T')[0],
    toDate: endDate.toISOString().split('T')[0],
    total: filtered.length,
    tasks: filtered,
    fieldsReturned: fields,
  });
}
```

### 4.3.4. GetTasksDueThisWeekTool

**Приоритет:** normal

```typescript
// Metadata
export const GET_TASKS_DUE_THIS_WEEK_TOOL_METADATA: ToolMetadata = {
  name: 'get_tasks_due_this_week',
  description: '[Tasks/Date] Получить задачи со сроком на эту неделю (7 дней).',
  category: 'tasks',
  subcategory: 'date',
  priority: 'normal',
  tags: ['tasks', 'week', 'due'],
};

// Tool - использует getTasksDueInRange с days=7
```

### 4.3.5. GetOverdueTasksTool

**Приоритет:** high

```typescript
// Schema
export const GetOverdueTasksParamsSchema = z.object({
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_OVERDUE_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'get_overdue_tasks',
  description: '[Tasks/Date] Получить просроченные задачи.',
  category: 'tasks',
  subcategory: 'date',
  priority: 'high',
  tags: ['tasks', 'overdue', 'late', 'missed'],
};

// Tool
async execute(params: unknown) {
  const { fields } = this.validateParams(params, GetOverdueTasksParamsSchema).data;

  const tasks = await this.facade.getOverdueTasks();
  const filtered = tasks.map(t => ResponseFieldFilter.filter(t, fields));

  // Сортировка по дате (самые старые первыми)
  filtered.sort((a, b) => {
    const dateA = new Date(a.dueDate || 0);
    const dateB = new Date(b.dueDate || 0);
    return dateA.getTime() - dateB.getTime();
  });

  return this.formatSuccess({
    total: filtered.length,
    tasks: filtered,
    fieldsReturned: fields,
  });
}
```

---

## Helper Tools (категория helpers)

### 4.3.6. PingTool

**Приоритет:** critical

```typescript
// Schema
export const PingParamsSchema = z.object({}).optional();

// Metadata
export const PING_TOOL_METADATA: ToolMetadata = {
  name: 'ping',
  description: '[Helpers] Проверить подключение к TickTick API.',
  category: 'helpers',
  subcategory: undefined,
  priority: 'critical',
  tags: ['ping', 'health', 'status', 'test'],
};

// Tool
async execute() {
  try {
    const startTime = Date.now();
    const projects = await this.facade.getProjects();
    const latency = Date.now() - startTime;

    return this.formatSuccess({
      status: 'connected',
      latencyMs: latency,
      projectCount: projects.length,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    return this.formatError({
      status: 'disconnected',
      error: error instanceof Error ? error.message : 'Unknown error',
      timestamp: new Date().toISOString(),
    });
  }
}
```

### 4.3.7. SearchToolsTool

**Приоритет:** critical

```typescript
// Schema
export const SearchToolsParamsSchema = z.object({
  query: z.string().min(1).describe('Поисковый запрос для поиска инструментов'),
  limit: z.number().int().min(1).max(50).optional().default(10)
    .describe('Максимальное количество результатов'),
});

// Metadata
export const SEARCH_TOOLS_TOOL_METADATA: ToolMetadata = {
  name: 'search_tools',
  description: '[Helpers] Поиск доступных инструментов по описанию или тегам.',
  category: 'helpers',
  subcategory: undefined,
  priority: 'critical',
  tags: ['search', 'tools', 'help', 'find'],
};

// Tool - использует ToolSearchEngine из @mcp-framework/search
async execute(params: unknown) {
  const { query, limit } = this.validateParams(params, SearchToolsParamsSchema).data;

  const results = this.searchEngine.search(query, { limit });

  return this.formatSuccess({
    query,
    total: results.length,
    tools: results.map(r => ({
      name: r.name,
      description: r.description,
      category: r.category,
      score: r.score,
    })),
  });
}
```

### 4.3.8. GetEngagedTasksTool (GTD)

**Приоритет:** normal

```typescript
// Schema
export const GetEngagedTasksParamsSchema = z.object({
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_ENGAGED_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'get_engaged_tasks',
  description: '[Helpers/GTD] Получить "горящие" задачи: высокий приоритет ИЛИ просроченные.',
  category: 'helpers',
  subcategory: 'gtd',
  priority: 'normal',
  tags: ['gtd', 'engaged', 'urgent', 'important'],
};

// Tool
async execute(params: unknown) {
  const { fields } = this.validateParams(params, GetEngagedTasksParamsSchema).data;

  const [highPriority, overdue] = await Promise.all([
    this.facade.getTasksByPriority(5),
    this.facade.getOverdueTasks(),
  ]);

  // Объединить и убрать дубликаты
  const taskMap = new Map<string, TaskWithUnknownFields>();
  [...highPriority, ...overdue].forEach(task => {
    taskMap.set(task.id, task);
  });

  const tasks = Array.from(taskMap.values());
  const filtered = tasks.map(t => ResponseFieldFilter.filter(t, fields));

  return this.formatSuccess({
    description: 'Высокий приоритет ИЛИ просроченные',
    total: filtered.length,
    tasks: filtered,
    fieldsReturned: fields,
  });
}
```

### 4.3.9. GetNextTasksTool (GTD)

**Приоритет:** normal

```typescript
// Metadata
export const GET_NEXT_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'get_next_tasks',
  description: '[Helpers/GTD] Получить "следующие" задачи: средний приоритет ИЛИ срок завтра.',
  category: 'helpers',
  subcategory: 'gtd',
  priority: 'normal',
  tags: ['gtd', 'next', 'upcoming'],
};

// Tool - объединяет priority=3 и dueDate=tomorrow
```

---

## tool-definitions.ts

```typescript
// src/composition-root/definitions/tool-definitions.ts
import { PingTool } from '#tools/helpers/ping/ping.tool.js';
import { SearchToolsTool } from '#tools/helpers/search-tools/search-tools.tool.js';

import { GetProjectsTool } from '#tools/api/projects/get-projects/get-projects.tool.js';
import { GetProjectTool } from '#tools/api/projects/get-project/get-project.tool.js';
import { GetProjectTasksTool } from '#tools/api/projects/get-project-tasks/get-project-tasks.tool.js';
import { CreateProjectTool } from '#tools/api/projects/create-project/create-project.tool.js';
import { UpdateProjectTool } from '#tools/api/projects/update-project/update-project.tool.js';
import { DeleteProjectTool } from '#tools/api/projects/delete-project/delete-project.tool.js';

import { GetTaskTool } from '#tools/api/tasks/get-task/get-task.tool.js';
import { GetTasksTool } from '#tools/api/tasks/get-tasks/get-tasks.tool.js';
import { GetAllTasksTool } from '#tools/api/tasks/get-all-tasks/get-all-tasks.tool.js';
import { SearchTasksTool } from '#tools/api/tasks/search-tasks/search-tasks.tool.js';
import { CreateTaskTool } from '#tools/api/tasks/create-task/create-task.tool.js';
import { BatchCreateTasksTool } from '#tools/api/tasks/batch-create-tasks/batch-create-tasks.tool.js';
import { UpdateTaskTool } from '#tools/api/tasks/update-task/update-task.tool.js';
import { CompleteTaskTool } from '#tools/api/tasks/complete-task/complete-task.tool.js';
import { DeleteTaskTool } from '#tools/api/tasks/delete-task/delete-task.tool.js';
import { GetTasksByPriorityTool } from '#tools/api/tasks/get-tasks-by-priority/get-tasks-by-priority.tool.js';

import { GetTasksDueTodayTool } from '#tools/api/date-queries/get-tasks-due-today/get-tasks-due-today.tool.js';
import { GetTasksDueTomorrowTool } from '#tools/api/date-queries/get-tasks-due-tomorrow/get-tasks-due-tomorrow.tool.js';
import { GetTasksDueInDaysTool } from '#tools/api/date-queries/get-tasks-due-in-days/get-tasks-due-in-days.tool.js';
import { GetTasksDueThisWeekTool } from '#tools/api/date-queries/get-tasks-due-this-week/get-tasks-due-this-week.tool.js';
import { GetOverdueTasksTool } from '#tools/api/date-queries/get-overdue-tasks/get-overdue-tasks.tool.js';

import { GetEngagedTasksTool } from '#tools/helpers/gtd/get-engaged-tasks/get-engaged-tasks.tool.js';
import { GetNextTasksTool } from '#tools/helpers/gtd/get-next-tasks/get-next-tasks.tool.js';

export const TOOL_CLASSES = [
  // Helpers (critical)
  PingTool,
  SearchToolsTool,

  // Projects
  GetProjectsTool,
  GetProjectTool,
  GetProjectTasksTool,
  CreateProjectTool,
  UpdateProjectTool,
  DeleteProjectTool,

  // Tasks
  GetTaskTool,
  GetTasksTool,
  GetAllTasksTool,
  SearchTasksTool,
  CreateTaskTool,
  BatchCreateTasksTool,
  UpdateTaskTool,
  CompleteTaskTool,
  DeleteTaskTool,
  GetTasksByPriorityTool,

  // Date queries
  GetTasksDueTodayTool,
  GetTasksDueTomorrowTool,
  GetTasksDueInDaysTool,
  GetTasksDueThisWeekTool,
  GetOverdueTasksTool,

  // GTD helpers
  GetEngagedTasksTool,
  GetNextTasksTool,
] as const;
```

---

## Валидация

```bash
npm run typecheck
npm run lint
```

---

## Чек-лист завершения

- [x] 5 date-based tools созданы
- [x] 3 helper tools созданы (ping, 2 GTD) - search_tools уже в @mcp-framework/search
- [x] tool-definitions.ts содержит 8 tools из этапа 4.3 (остальные tools из 4.1 и 4.2)
- [x] Metadata правильно категоризирует tools (добавлен ToolCategory.TASKS в core)
- [x] `npm run typecheck` проходит
- [x] `npm run lint:quiet` проходит

**Примечание:** SearchToolsTool не создаётся локально, он импортируется из @mcp-framework/search и регистрируется в container.ts (как в yandex-tracker).
