# Этап 1.1: Инфраструктура и настройка пакета (sequential)

**Тип выполнения:** sequential (один агент, последовательно)
**Причина:** Зависимости между файлами, базовая структура для всего проекта

---

## Задачи

### 1.1.1. Создать структуру директорий
- [ ] Создать `packages/servers/ticktick/`
- [ ] Создать поддиректории согласно архитектуре

```bash
mkdir -p packages/servers/ticktick/{src/{composition-root/definitions,config,ticktick_api/{api_operations/{projects,tasks},facade,entities,dto},tools/{api/{projects,tasks},helpers},cli},tests/{unit,integration}}
```

### 1.1.2. Создать package.json
- [ ] Скопировать структуру из yandex-tracker
- [ ] Обновить имя: `@mcp-server/ticktick`
- [ ] Обновить описание
- [ ] Сохранить все скрипты (build, test, lint, validate)
- [ ] Добавить зависимости от framework пакетов

```json
{
  "name": "@mcp-server/ticktick",
  "version": "0.1.0",
  "description": "MCP Server for TickTick todo-list application",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsc -b && tsc-alias",
    "clean": "rimraf dist",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix",
    "lint:quiet": "eslint src --ext .ts --quiet",
    "format": "prettier --write \"src/**/*.ts\" \"tests/**/*.ts\"",
    "format:check": "prettier --check \"src/**/*.ts\" \"tests/**/*.ts\"",
    "test": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:quiet": "vitest run --reporter=dot --silent",
    "test:verbose": "vitest run --reporter=verbose",
    "test:watch": "vitest watch",
    "test:smoke": "vitest run tests/smoke",
    "typecheck": "tsc --noEmit",
    "validate": "npm run lint && npm run typecheck && npm run test && npm run test:smoke",
    "validate:quiet": "npm run lint:quiet && npm run typecheck && npm run test:quiet"
  },
  "dependencies": {
    "@mcp-framework/core": "workspace:*",
    "@mcp-framework/infrastructure": "workspace:*",
    "@mcp-framework/cli": "workspace:*",
    "@mcp-framework/search": "workspace:*",
    "@modelcontextprotocol/sdk": "^0.5.0",
    "inversify": "^6.0.2",
    "reflect-metadata": "^0.2.1",
    "zod": "^3.22.4"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "rimraf": "^5.0.5",
    "tsc-alias": "^1.8.8",
    "typescript": "^5.3.2",
    "vitest": "^1.0.4"
  }
}
```

### 1.1.3. Создать tsconfig.json
- [ ] Скопировать из yandex-tracker
- [ ] Настроить subpath imports (#ticktick_api/*, #tools/*, etc.)

```json
{
  "extends": "../../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "composite": true,
    "baseUrl": "./src",
    "paths": {
      "#ticktick_api/*": ["./ticktick_api/*"],
      "#tools/*": ["./tools/*"],
      "#composition-root/*": ["./composition-root/*"],
      "#config/*": ["./config/*"],
      "#cli/*": ["./cli/*"],
      "#constants": ["./constants.ts"]
    }
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### 1.1.4. Создать constants.ts
- [ ] MCP_TOOL_PREFIX для TickTick
- [ ] Константы по умолчанию

```typescript
// src/constants.ts
export const MCP_TOOL_PREFIX = 'fr_ticktick_';
export const DEFAULT_MAX_BATCH_SIZE = 100;
export const DEFAULT_MAX_CONCURRENT_REQUESTS = 5;
export const DEFAULT_CACHE_TTL_MS = 300000; // 5 min
export const API_BASE_URL = 'https://api.ticktick.com/open/v1';
```

### 1.1.5. Создать config-loader.ts
- [ ] Загрузка переменных окружения
- [ ] OAuth конфигурация
- [ ] API конфигурация
- [ ] Парсинг категорий инструментов

```typescript
// src/config/config-loader.ts
import type { ServerConfig } from './server-config.interface.js';

export function loadConfig(): ServerConfig {
  return {
    oauth: {
      clientId: process.env.TICKTICK_CLIENT_ID ?? '',
      clientSecret: process.env.TICKTICK_CLIENT_SECRET ?? '',
      redirectUri: process.env.TICKTICK_REDIRECT_URI ?? 'http://localhost:3000/callback',
      accessToken: process.env.TICKTICK_ACCESS_TOKEN,
      refreshToken: process.env.TICKTICK_REFRESH_TOKEN,
    },
    api: {
      baseUrl: process.env.TICKTICK_API_BASE_URL ?? 'https://api.ticktick.com/open/v1',
    },
    batch: {
      maxBatchSize: parseInt(process.env.MAX_BATCH_SIZE ?? '100', 10),
      maxConcurrentRequests: parseInt(process.env.MAX_CONCURRENT_REQUESTS ?? '5', 10),
    },
    retry: {
      attempts: parseInt(process.env.TICKTICK_RETRY_ATTEMPTS ?? '3', 10),
      minDelay: parseInt(process.env.TICKTICK_RETRY_MIN_DELAY ?? '1000', 10),
      maxDelay: parseInt(process.env.TICKTICK_RETRY_MAX_DELAY ?? '10000', 10),
    },
    cache: {
      ttlMs: parseInt(process.env.CACHE_TTL_MS ?? '300000', 10),
    },
    tools: {
      discoveryMode: (process.env.TOOL_DISCOVERY_MODE as 'lazy' | 'eager') ?? 'eager',
      enabledCategories: parseEnabledToolCategories(process.env.ENABLED_TOOL_CATEGORIES),
      disabledGroups: parseDisabledToolGroups(process.env.DISABLED_TOOL_GROUPS),
    },
  };
}

// Переиспользовать функции парсинга из yandex-tracker
```

### 1.1.6. Создать server-config.interface.ts
- [ ] Типы для всей конфигурации

```typescript
// src/config/server-config.interface.ts
export interface OAuthConfig {
  clientId: string;
  clientSecret: string;
  redirectUri: string;
  accessToken?: string;
  refreshToken?: string;
}

export interface ApiConfig {
  baseUrl: string;
}

export interface BatchConfig {
  maxBatchSize: number;
  maxConcurrentRequests: number;
}

export interface RetryConfig {
  attempts: number;
  minDelay: number;
  maxDelay: number;
}

export interface CacheConfig {
  ttlMs: number;
}

export interface ToolsConfig {
  discoveryMode: 'lazy' | 'eager';
  enabledCategories?: ParsedCategoryFilter;
  disabledGroups?: ParsedCategoryFilter;
}

export interface ServerConfig {
  oauth: OAuthConfig;
  api: ApiConfig;
  batch: BatchConfig;
  retry: RetryConfig;
  cache: CacheConfig;
  tools: ToolsConfig;
}
```

---

## Валидация

После выполнения:
```bash
cd packages/servers/ticktick
npm install
npm run typecheck
```

---

## Чек-лист завершения

- [ ] Структура директорий создана
- [ ] package.json корректный, npm install успешен
- [ ] tsconfig.json настроен, пути работают
- [ ] constants.ts экспортирует константы
- [ ] config-loader.ts загружает конфигурацию
- [ ] `npm run typecheck` проходит без ошибок
