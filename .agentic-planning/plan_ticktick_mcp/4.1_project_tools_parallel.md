# Этап 4.1: Project Tools (parallel)

**Тип выполнения:** parallel (можно выполнять параллельно с 4.2, 4.3)
**Причина:** Независимые tools, нет взаимных зависимостей
**Зависимости:** Этап 3.1 завершён

---

## Общий паттерн Tool

Каждый tool состоит из 4 файлов:
```
src/tools/api/projects/{action}/
├── {name}.schema.ts       # Zod schema
├── {name}.metadata.ts     # Static metadata
├── {name}.tool.ts         # Tool class
└── index.ts
```

---

## Задачи

### 4.1.1. GetProjectsTool

**Категория:** projects:read
**Приоритет:** high

```typescript
// src/tools/api/projects/get-projects/get-projects.schema.ts
import { z } from 'zod';
import { FieldsSchema } from '@mcp-framework/core';

export const GetProjectsParamsSchema = z.object({
  fields: FieldsSchema.describe('Поля для возврата (экономия контекста)'),
});

export type GetProjectsParams = z.infer<typeof GetProjectsParamsSchema>;
```

```typescript
// src/tools/api/projects/get-projects/get-projects.metadata.ts
import type { ToolMetadata } from '@mcp-framework/core';

export const GET_PROJECTS_TOOL_METADATA: ToolMetadata = {
  name: 'get_projects',
  description: '[Projects/Read] Получить все проекты пользователя. Возвращает список проектов с фильтрацией полей.',
  category: 'projects',
  subcategory: 'read',
  priority: 'high',
  tags: ['projects', 'list', 'read'],
};
```

```typescript
// src/tools/api/projects/get-projects/get-projects.tool.ts
import { BaseTool, generateDefinitionFromSchema, ResponseFieldFilter } from '@mcp-framework/core';
import type { TickTickFacade } from '#ticktick_api/facade/ticktick.facade.js';
import { GET_PROJECTS_TOOL_METADATA } from './get-projects.metadata.js';
import { GetProjectsParamsSchema, type GetProjectsParams } from './get-projects.schema.js';

export class GetProjectsTool extends BaseTool<TickTickFacade> {
  static override readonly METADATA = GET_PROJECTS_TOOL_METADATA;

  getDefinition() {
    return generateDefinitionFromSchema(this.metadata, GetProjectsParamsSchema);
  }

  async execute(params: unknown) {
    const { fields } = this.validateParams(params, GetProjectsParamsSchema).data as GetProjectsParams;

    const projects = await this.facade.getProjects();

    const filtered = projects.map(project =>
      ResponseFieldFilter.filter(project, fields)
    );

    return this.formatSuccess({
      total: filtered.length,
      projects: filtered,
      fieldsReturned: fields,
    });
  }
}
```

### 4.1.2. GetProjectTool

**Категория:** projects:read
**Приоритет:** high

```typescript
// Schema
export const GetProjectParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  fields: FieldsSchema.describe('Поля для возврата'),
});

// Metadata
export const GET_PROJECT_TOOL_METADATA: ToolMetadata = {
  name: 'get_project',
  description: '[Projects/Read] Получить проект по ID.',
  category: 'projects',
  subcategory: 'read',
  priority: 'high',
  tags: ['project', 'get', 'read'],
};

// Tool
async execute(params: unknown) {
  const { projectId, fields } = this.validateParams(params, GetProjectParamsSchema).data;

  const project = await this.facade.getProject(projectId);
  const filtered = ResponseFieldFilter.filter(project, fields);

  return this.formatSuccess({
    project: filtered,
    fieldsReturned: fields,
  });
}
```

### 4.1.3. GetProjectTasksTool

**Категория:** projects:read
**Приоритет:** high

```typescript
// Schema
export const GetProjectTasksParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  fields: FieldsSchema.describe('Поля задач для возврата'),
});

// Metadata
export const GET_PROJECT_TASKS_TOOL_METADATA: ToolMetadata = {
  name: 'get_project_tasks',
  description: '[Projects/Read] Получить все задачи проекта. Возвращает проект и его задачи.',
  category: 'projects',
  subcategory: 'read',
  priority: 'high',
  tags: ['project', 'tasks', 'list'],
};

// Tool
async execute(params: unknown) {
  const { projectId, fields } = this.validateParams(params, GetProjectTasksParamsSchema).data;

  const data = await this.facade.getProjectData(projectId);

  const filteredTasks = data.tasks.map(task =>
    ResponseFieldFilter.filter(task, fields)
  );

  return this.formatSuccess({
    projectId,
    projectName: data.project.name,
    total: filteredTasks.length,
    tasks: filteredTasks,
    fieldsReturned: fields,
  });
}
```

### 4.1.4. CreateProjectTool

**Категория:** projects:write
**Приоритет:** normal

```typescript
// Schema
export const CreateProjectParamsSchema = z.object({
  name: z.string().min(1).max(100).describe('Название проекта'),
  color: z.string().optional().describe('Цвет проекта (hex)'),
  viewMode: z.enum(['list', 'kanban', 'timeline']).optional().describe('Режим отображения'),
  kind: z.enum(['TASK', 'NOTE']).optional().describe('Тип проекта'),
  fields: FieldsSchema.optional().describe('Поля для возврата'),
});

// Metadata
export const CREATE_PROJECT_TOOL_METADATA: ToolMetadata = {
  name: 'create_project',
  description: '[Projects/Write] Создать новый проект.',
  category: 'projects',
  subcategory: 'write',
  priority: 'normal',
  tags: ['project', 'create', 'new'],
};

// Tool
async execute(params: unknown) {
  const { name, color, viewMode, kind, fields } = this.validateParams(params, CreateProjectParamsSchema).data;

  const project = await this.facade.createProject({ name, color, viewMode, kind });

  const result = fields ? ResponseFieldFilter.filter(project, fields) : project;

  return this.formatSuccess({
    message: `Проект "${name}" создан`,
    project: result,
    fieldsReturned: fields,
  });
}
```

### 4.1.5. UpdateProjectTool

**Категория:** projects:write
**Приоритет:** normal

```typescript
// Schema
export const UpdateProjectParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта'),
  name: z.string().min(1).max(100).optional().describe('Новое название'),
  color: z.string().optional().describe('Новый цвет'),
  viewMode: z.enum(['list', 'kanban', 'timeline']).optional().describe('Новый режим'),
  closed: z.boolean().optional().describe('Закрыть/открыть проект'),
  fields: FieldsSchema.optional().describe('Поля для возврата'),
});

// Metadata
export const UPDATE_PROJECT_TOOL_METADATA: ToolMetadata = {
  name: 'update_project',
  description: '[Projects/Write] Обновить проект.',
  category: 'projects',
  subcategory: 'write',
  priority: 'normal',
  tags: ['project', 'update', 'edit'],
};

// Tool
async execute(params: unknown) {
  const { projectId, name, color, viewMode, closed, fields } =
    this.validateParams(params, UpdateProjectParamsSchema).data;

  const project = await this.facade.updateProject(projectId, { name, color, viewMode, closed });

  const result = fields ? ResponseFieldFilter.filter(project, fields) : project;

  return this.formatSuccess({
    message: `Проект обновлён`,
    project: result,
    fieldsReturned: fields,
  });
}
```

### 4.1.6. DeleteProjectTool

**Категория:** projects:write
**Приоритет:** low

```typescript
// Schema
export const DeleteProjectParamsSchema = z.object({
  projectId: z.string().min(1).describe('ID проекта для удаления'),
});

// Metadata
export const DELETE_PROJECT_TOOL_METADATA: ToolMetadata = {
  name: 'delete_project',
  description: '[Projects/Write] Удалить проект. ВНИМАНИЕ: удаляет все задачи проекта!',
  category: 'projects',
  subcategory: 'write',
  priority: 'low',
  tags: ['project', 'delete', 'remove'],
};

// Tool
async execute(params: unknown) {
  const { projectId } = this.validateParams(params, DeleteProjectParamsSchema).data;

  // Получить имя для подтверждения
  const project = await this.facade.getProject(projectId);

  await this.facade.deleteProject(projectId);

  return this.formatSuccess({
    message: `Проект "${project.name}" удалён`,
    deletedProjectId: projectId,
  });
}
```

---

## Валидация

```bash
npm run typecheck
npm run lint
```

---

## Чек-лист завершения

- [x] 6 tools созданы (get_projects, get_project, get_project_tasks, create, update, delete)
- [x] Каждый tool имеет schema, metadata, tool файлы
- [x] ResponseFieldFilter применяется для экономии контекста
- [x] Metadata содержит category, subcategory, priority, tags
- [x] index.ts экспортирует все tools
- [x] `npm run typecheck` проходит

**Этап завершён: 2025-12-07**
