# Этап 5.1: Интеграция MCP и CLI (sequential)

**Тип выполнения:** sequential
**Причина:** Зависит от всех предыдущих компонентов
**Зависимости:** Этапы 4.1, 4.2, 4.3 завершены

---

## Задачи

### 5.1.1. Создать MCP Server Entry Point

```typescript
// src/index.ts
import 'reflect-metadata';
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';

import { createContainer } from '#composition-root/container.js';
import { TYPES } from '#composition-root/types.js';
import type { ToolRegistry } from '@mcp-framework/core';
import type { Logger } from '@mcp-framework/infrastructure';
import { MCP_TOOL_PREFIX } from '#constants';

async function main(): Promise<void> {
  const container = createContainer();
  const logger = container.get<Logger>(TYPES.Logger);
  const toolRegistry = container.get<ToolRegistry>(TYPES.ToolRegistry);

  const server = new Server(
    {
      name: 'ticktick-mcp',
      version: '0.1.0',
    },
    {
      capabilities: {
        tools: {},
      },
    }
  );

  // Handle tools/list
  server.setRequestHandler('tools/list', async () => {
    const definitions = toolRegistry.getDefinitions();

    return {
      tools: definitions.map(def => ({
        name: `${MCP_TOOL_PREFIX}${def.name}`,
        description: def.description,
        inputSchema: def.inputSchema,
      })),
    };
  });

  // Handle tools/call
  server.setRequestHandler('tools/call', async (request) => {
    const { name, arguments: args } = request.params;

    // Remove prefix
    const toolName = name.startsWith(MCP_TOOL_PREFIX)
      ? name.slice(MCP_TOOL_PREFIX.length)
      : name;

    const tool = toolRegistry.getTool(toolName);
    if (!tool) {
      throw new Error(`Tool "${toolName}" not found`);
    }

    try {
      const result = await tool.execute(args);
      return {
        content: [
          {
            type: 'text',
            text: JSON.stringify(result, null, 2),
          },
        ],
      };
    } catch (error) {
      logger.error({ error, toolName }, 'Tool execution failed');
      return {
        content: [
          {
            type: 'text',
            text: JSON.stringify({
              error: error instanceof Error ? error.message : 'Unknown error',
            }),
          },
        ],
        isError: true,
      };
    }
  });

  // Start server
  const transport = new StdioServerTransport();
  await server.connect(transport);

  logger.info('TickTick MCP Server started');
}

main().catch((error) => {
  console.error('Failed to start server:', error);
  process.exit(1);
});
```

### 5.1.2. Создать CLI для подключения

```typescript
// src/cli/index.ts
import { MCPConnectionCLI } from '@mcp-framework/cli';

const cli = new MCPConnectionCLI({
  serverName: 'ticktick-mcp',
  serverVersion: '0.1.0',
  serverDescription: 'MCP Server for TickTick todo-list application',

  // OAuth flow helper
  authCommands: {
    login: {
      description: 'Authenticate with TickTick',
      handler: async () => {
        // Открыть браузер для OAuth
        // Запустить локальный сервер для callback
        // Сохранить токены в .env
      },
    },
    logout: {
      description: 'Clear TickTick credentials',
      handler: async () => {
        // Удалить токены из .env
      },
    },
    status: {
      description: 'Check authentication status',
      handler: async () => {
        // Проверить валидность токена
      },
    },
  },
});

cli.run();
```

### 5.1.3. Обновить package.json bin

```json
{
  "bin": {
    "ticktick-mcp": "./dist/index.js",
    "ticktick-mcp-cli": "./dist/cli/index.js"
  }
}
```

### 5.1.4. Создать OAuth Callback Server

```typescript
// src/cli/oauth-callback-server.ts
import http from 'node:http';
import { URL } from 'node:url';

export function startOAuthCallbackServer(
  port: number,
  onCode: (code: string) => Promise<void>
): Promise<void> {
  return new Promise((resolve, reject) => {
    const server = http.createServer(async (req, res) => {
      const url = new URL(req.url ?? '/', `http://localhost:${port}`);

      if (url.pathname === '/callback') {
        const code = url.searchParams.get('code');
        const error = url.searchParams.get('error');

        if (error) {
          res.writeHead(400);
          res.end(`Error: ${error}`);
          server.close();
          reject(new Error(error));
          return;
        }

        if (code) {
          try {
            await onCode(code);
            res.writeHead(200, { 'Content-Type': 'text/html' });
            res.end(`
              <html>
                <body>
                  <h1>Authentication successful!</h1>
                  <p>You can close this window.</p>
                </body>
              </html>
            `);
            server.close();
            resolve();
          } catch (err) {
            res.writeHead(500);
            res.end(`Error: ${err instanceof Error ? err.message : 'Unknown'}`);
            server.close();
            reject(err);
          }
        }
      }
    });

    server.listen(port, () => {
      console.log(`OAuth callback server listening on port ${port}`);
    });

    // Timeout после 5 минут
    setTimeout(() => {
      server.close();
      reject(new Error('OAuth timeout'));
    }, 5 * 60 * 1000);
  });
}
```

### 5.1.5. Интегрировать Tool Search Engine

```typescript
// В container.ts добавить
import { ToolSearchEngine, buildSearchIndex } from '@mcp-framework/search';

function bindMCP(container: Container, config: ServerConfig): void {
  // Build search index at startup
  const searchIndex = buildSearchIndex(TOOL_CLASSES);

  container.bind(TYPES.SearchEngine).toDynamicValue(() => {
    return new ToolSearchEngine(searchIndex);
  });

  container.bind(TYPES.ToolRegistry).toDynamicValue((context) => {
    const tools = TOOL_CLASSES.map(ToolClass =>
      context.container.get(Symbol.for(ToolClass.name))
    );
    return new ToolRegistry(tools, config.tools);
  });
}
```

---

## Валидация

```bash
npm run build
npm run typecheck
npm run lint

# Тест запуска
node dist/index.js &
# Должен запуститься без ошибок
```

---

## Чек-лист завершения

- [ ] index.ts создаёт MCP Server
- [ ] tools/list возвращает все tools с префиксом
- [ ] tools/call выполняет tools
- [ ] CLI с командами login/logout/status
- [ ] OAuth callback server работает
- [ ] Search Engine интегрирован
- [ ] `npm run build` проходит
- [ ] Сервер запускается без ошибок
