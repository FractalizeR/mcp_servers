# Этап 2.2: Task Operations (parallel)

**Тип выполнения:** parallel (можно выполнять параллельно с 2.1)
**Причина:** Независимые операции, нет взаимных зависимостей
**Зависимости:** Этап 1.2 завершён

---

## Задачи

### 2.2.1. Создать Task entity
- [ ] Интерфейс Task с unknown полями

```typescript
// src/ticktick_api/entities/task.entity.ts
export interface ChecklistItem {
  id: string;
  title: string;
  status: number;  // 0=uncompleted, 1=completed
  sortOrder?: number;
}

export interface Task {
  id: string;
  projectId: string;
  title: string;
  content?: string;
  desc?: string;
  priority: number;           // 0=none, 1=low, 3=medium, 5=high
  status: number;             // 0=uncompleted, 2=completed
  dueDate?: string;           // ISO date
  startDate?: string;
  timeZone?: string;
  isAllDay?: boolean;
  reminders?: string[];       // ['TRIGGER:P0DT9H0M0S']
  repeatFlag?: string;        // 'RRULE:FREQ=DAILY'
  tags?: string[];
  items?: ChecklistItem[];    // Subtasks/checklist
  progress?: number;          // 0-100
  completedTime?: string;
  createdTime: string;
  modifiedTime: string;
  sortOrder?: number;
  kind?: 'TEXT' | 'CHECKLIST';
}

export interface TaskWithUnknownFields extends Task {
  [key: string]: unknown;
}
```

### 2.2.2. Создать Task DTOs
- [ ] CreateTaskDto
- [ ] UpdateTaskDto

```typescript
// src/ticktick_api/dto/task.dto.ts
export interface CreateTaskDto {
  title: string;
  projectId?: string;         // Опционально, default inbox
  content?: string;
  desc?: string;
  priority?: number;          // 0-5
  dueDate?: string;
  startDate?: string;
  timeZone?: string;
  isAllDay?: boolean;
  reminders?: string[];
  repeatFlag?: string;
  tags?: string[];
  items?: CreateChecklistItemDto[];
}

export interface CreateChecklistItemDto {
  title: string;
  status?: number;
}

export interface UpdateTaskDto {
  title?: string;
  content?: string;
  desc?: string;
  priority?: number;
  status?: number;
  dueDate?: string;
  startDate?: string;
  isAllDay?: boolean;
  reminders?: string[];
  repeatFlag?: string;
  tags?: string[];
  items?: UpdateChecklistItemDto[];
}

export interface UpdateChecklistItemDto {
  id?: string;                // Если есть — update, нет — create
  title: string;
  status?: number;
}
```

### 2.2.3. GetTaskOperation
- [ ] GET /project/{projectId}/task/{taskId}

```typescript
// src/ticktick_api/api_operations/tasks/get-task.operation.ts
import { BaseOperation } from '@mcp-framework/infrastructure';
import type { TaskWithUnknownFields } from '#ticktick_api/entities/task.entity.js';

export class GetTaskOperation extends BaseOperation {
  async execute(projectId: string, taskId: string): Promise<TaskWithUnknownFields> {
    const cacheKey = `task:${projectId}:${taskId}`;

    return this.withCache(cacheKey, async () => {
      return this.httpClient.get<TaskWithUnknownFields>(
        `/project/${projectId}/task/${taskId}`
      );
    });
  }
}
```

### 2.2.4. GetTasksOperation (batch)
- [ ] Получение нескольких задач параллельно
- [ ] Использование ParallelExecutor

```typescript
// src/ticktick_api/api_operations/tasks/get-tasks.operation.ts
import { BaseOperation, ParallelExecutor, type BatchResult } from '@mcp-framework/infrastructure';
import type { TaskWithUnknownFields } from '#ticktick_api/entities/task.entity.js';

export interface TaskRef {
  projectId: string;
  taskId: string;
}

export class GetTasksOperation extends BaseOperation {
  private readonly parallelExecutor: ParallelExecutor;

  constructor(httpClient, cacheManager, logger, config) {
    super(httpClient, cacheManager, logger);
    this.parallelExecutor = new ParallelExecutor(logger, {
      maxBatchSize: config.batch.maxBatchSize,
      maxConcurrentRequests: config.batch.maxConcurrentRequests,
    });
  }

  async execute(taskRefs: TaskRef[]): Promise<BatchResult<string, TaskWithUnknownFields>> {
    const operations = taskRefs.map(ref => ({
      key: ref.taskId,
      fn: async () => {
        const cacheKey = `task:${ref.projectId}:${ref.taskId}`;
        return this.withCache(cacheKey, async () => {
          return this.httpClient.get<TaskWithUnknownFields>(
            `/project/${ref.projectId}/task/${ref.taskId}`
          );
        });
      },
    }));

    return this.parallelExecutor.executeParallel(operations, 'get tasks');
  }
}
```

### 2.2.5. CreateTaskOperation
- [ ] POST /task

```typescript
// src/ticktick_api/api_operations/tasks/create-task.operation.ts
import type { CreateTaskDto } from '#ticktick_api/dto/task.dto.js';

export class CreateTaskOperation extends BaseOperation {
  async execute(dto: CreateTaskDto): Promise<TaskWithUnknownFields> {
    const result = await this.httpClient.post<TaskWithUnknownFields>('/task', dto);

    // Инвалидация кеша проекта
    if (result.projectId) {
      this.cacheManager.delete(`project:${result.projectId}:data`);
    }

    return result;
  }
}
```

### 2.2.6. UpdateTaskOperation
- [ ] POST /project/{projectId}/task/{taskId}

```typescript
// src/ticktick_api/api_operations/tasks/update-task.operation.ts
import type { UpdateTaskDto } from '#ticktick_api/dto/task.dto.js';

export class UpdateTaskOperation extends BaseOperation {
  async execute(
    projectId: string,
    taskId: string,
    dto: UpdateTaskDto
  ): Promise<TaskWithUnknownFields> {
    const result = await this.httpClient.post<TaskWithUnknownFields>(
      `/project/${projectId}/task/${taskId}`,
      dto
    );

    // Инвалидация кеша
    this.cacheManager.delete(`task:${projectId}:${taskId}`);
    this.cacheManager.delete(`project:${projectId}:data`);

    return result;
  }
}
```

### 2.2.7. DeleteTaskOperation
- [ ] DELETE /project/{projectId}/task/{taskId}

```typescript
// src/ticktick_api/api_operations/tasks/delete-task.operation.ts
export class DeleteTaskOperation extends BaseOperation {
  async execute(projectId: string, taskId: string): Promise<void> {
    await this.httpClient.delete(`/project/${projectId}/task/${taskId}`);

    // Инвалидация кеша
    this.cacheManager.delete(`task:${projectId}:${taskId}`);
    this.cacheManager.delete(`project:${projectId}:data`);
  }
}
```

### 2.2.8. CompleteTaskOperation
- [ ] POST /task/{taskId}/complete

```typescript
// src/ticktick_api/api_operations/tasks/complete-task.operation.ts
export class CompleteTaskOperation extends BaseOperation {
  async execute(projectId: string, taskId: string): Promise<void> {
    await this.httpClient.post(`/task/${taskId}/complete`);

    // Инвалидация кеша
    this.cacheManager.delete(`task:${projectId}:${taskId}`);
    this.cacheManager.delete(`project:${projectId}:data`);
  }
}
```

### 2.2.9. Создать index.ts
- [ ] Экспорт всех operations

```typescript
// src/ticktick_api/api_operations/tasks/index.ts
export * from './get-task.operation.js';
export * from './get-tasks.operation.js';
export * from './create-task.operation.js';
export * from './update-task.operation.js';
export * from './delete-task.operation.js';
export * from './complete-task.operation.js';
```

---

## Валидация

```bash
npm run typecheck
npm run lint
```

---

## Чек-лист завершения

- [ ] Task entity создан с unknown fields и checklist items
- [ ] DTOs созданы (Create, Update с checklist support)
- [ ] 6 operations созданы
- [ ] GetTasksOperation использует ParallelExecutor
- [ ] Кеш инвалидируется при мутациях
- [ ] Index.ts экспортирует все operations
- [ ] `npm run typecheck` проходит
