# 2.4 Рефакторинг фасадов с избытком параметров

**Тип:** Parallel (можно выполнять параллельно с 2.1, 2.2, 2.3)
**Пакеты:** `yandex-tracker`, `ticktick`, `yandex-wiki`
**Оценка:** 1-1.5 часа
**Статус:** [ ] Не начато

## Проблема

| Класс | Параметров | Лимит |
|-------|------------|-------|
| YandexTrackerFacade | 14 | 5 |
| TickTickFacade | 12 | 5 |
| YandexWikiFacade | 12 | 5 |

Это симптом God Object — фасад знает слишком много о деталях реализации.

## Анализ зависимостей

Типичная структура фасада:
```typescript
constructor(
  // HTTP layer
  private httpClient: HttpClient,
  private authProvider: AuthProvider,

  // Operations (много!)
  private issueOps: IssueOperations,
  private queueOps: QueueOperations,
  private commentOps: CommentOperations,
  private attachmentOps: AttachmentOperations,
  // ... ещё 8-10 операций
)
```

## Стратегии решения

### Вариант A: Группировка в Sub-Facades
```typescript
constructor(
  private issuesFacade: IssuesFacade,      // issues, comments, attachments
  private queuesFacade: QueuesFacade,      // queues, components
  private projectsFacade: ProjectsFacade,  // projects, boards, sprints
)
```

**Плюсы:** Чистая иерархия, SRP
**Минусы:** Дополнительный уровень абстракции

### Вариант B: Dependency Container Object
```typescript
interface FacadeDependencies {
  http: HttpClient;
  auth: AuthProvider;
  operations: OperationsRegistry;
}

constructor(private deps: FacadeDependencies)
```

**Плюсы:** Простая реализация, один параметр
**Минусы:** Скрывает зависимости

### Вариант C: Lazy Loading через DI
```typescript
constructor(private container: Container) {
  // Operations получаются лениво при первом использовании
}

get issueOps() {
  return this.container.get<IssueOperations>(TYPES.IssueOperations);
}
```

**Плюсы:** Использует существующий DI
**Минусы:** Менее явные зависимости

## Рекомендация

**Вариант A (Sub-Facades)** — наиболее чистый с точки зрения архитектуры.

## Шаги реализации (на примере YandexTrackerFacade)

### Шаг 1: Анализ
- [ ] Сгруппировать 14 операций по доменам
- [ ] Определить 3-4 логические группы

### Шаг 2: Создание Sub-Facades
- [ ] Создать `IssuesFacade` (issues, comments, attachments, checklist)
- [ ] Создать `QueuesFacade` (queues, components, fields)
- [ ] Создать `ProjectsFacade` (projects, boards, sprints)
- [ ] Создать `WorkflowFacade` (transitions, changelog, bulk ops)

### Шаг 3: Обновление DI Container
- [ ] Зарегистрировать новые sub-facades
- [ ] Обновить привязки в composition-root

### Шаг 4: Обновление главного Facade
- [ ] Заменить 14 параметров на 4 sub-facades
- [ ] Делегировать вызовы соответствующим sub-facades
- [ ] Сохранить публичный API (методы)

### Шаг 5: Обновление Tools
- [ ] Проверить что tools используют facade корректно
- [ ] При необходимости обновить инъекции

## Пример структуры

```
tracker_api/facade/
├── yandex-tracker.facade.ts     # Главный фасад (4-5 deps)
├── sub-facades/
│   ├── issues.facade.ts         # Issue operations
│   ├── queues.facade.ts         # Queue operations
│   ├── projects.facade.ts       # Project operations
│   └── workflow.facade.ts       # Workflow operations
└── index.ts
```

## Валидация

```bash
npm run lint   # Проверить max-params
npm run typecheck
npm run test
npm run test:smoke
```

- [ ] Все facades имеют ≤ 5 параметров
- [ ] Публичный API сохранён
- [ ] Все тесты проходят

## Коммиты

```
refactor(yandex-tracker): introduce sub-facades to reduce constructor params

refactor(ticktick): introduce sub-facades to reduce constructor params

refactor(yandex-wiki): introduce sub-facades to reduce constructor params
```

## Риски

- **Высокий:** Много мест использования фасада — нужно проверить все tools
- **Средний:** DI контейнер нужно обновить для новых классов

## Чек-лист завершения

- [ ] YandexTrackerFacade ≤ 5 params
- [ ] TickTickFacade ≤ 5 params
- [ ] YandexWikiFacade ≤ 5 params
- [ ] Все smoke tests проходят
- [ ] DI container обновлён
