# 2.3 Рефакторинг функций setupServer и loadConfig

**Тип:** Parallel (можно выполнять параллельно с 2.1, 2.2, 2.4)
**Пакеты:** `yandex-tracker`, `ticktick`, `yandex-wiki`
**Оценка:** 45-60 минут
**Статус:** [ ] Не начато

## Проблема

| Файл | Функция | Строк | Лимит |
|------|---------|-------|-------|
| yandex-tracker/src/index.ts | setupServer | 214 | 100 |
| yandex-wiki/src/index.ts | setupServer | 214 | 100 |
| ticktick/src/index.ts | setupServer | 163 | 100 |
| yandex-tracker/src/config/config-loader.ts | loadConfig | 112 | 100 |
| ticktick/src/config/config-loader.ts | loadConfig | 139 | 100 |

## Стратегия рефакторинга setupServer

### Текущая структура (типичная)
```typescript
async function setupServer() {
  // 1. Загрузка конфигурации
  // 2. Создание DI контейнера
  // 3. Регистрация tools
  // 4. Настройка MCP server
  // 5. Настройка transport
  // 6. Обработка ошибок
  // 7. Graceful shutdown
}
```

### Целевая структура
```typescript
async function setupServer() {
  const config = await loadAndValidateConfig();
  const container = createContainer(config);
  const server = createMcpServer(container);
  const transport = createTransport(config);

  setupErrorHandling(server);
  setupGracefulShutdown(server, transport);

  await server.connect(transport);
}

// Вспомогательные функции в отдельных файлах или в том же файле
function createMcpServer(container: Container): Server { ... }
function createTransport(config: Config): Transport { ... }
function setupErrorHandling(server: Server): void { ... }
function setupGracefulShutdown(...): void { ... }
```

## Шаги реализации

### Для каждого сервера (yandex-tracker, ticktick, yandex-wiki):

#### Шаг 1: Анализ setupServer
- [ ] Выделить логические блоки в функции
- [ ] Определить какие блоки можно вынести

#### Шаг 2: Извлечение функций
- [ ] Создать `src/server/` директорию (если нет)
- [ ] Вынести: `createMcpServer()`, `createTransport()`
- [ ] Вынести: `setupErrorHandling()`, `setupGracefulShutdown()`
- [ ] Оставить в setupServer только оркестрацию

#### Шаг 3: Рефакторинг loadConfig (yandex-tracker, ticktick)
- [ ] Выделить валидацию в отдельную функцию
- [ ] Выделить загрузку env vars в отдельную функцию
- [ ] Выделить merge с defaults в отдельную функцию

## Пример извлечения (псевдокод)

**До:**
```typescript
function loadConfig() {
  // 50 строк: чтение env
  // 30 строк: валидация
  // 30 строк: merge с defaults
  // 20 строк: обработка ошибок
}
```

**После:**
```typescript
function loadConfig() {
  const envConfig = loadEnvConfig();
  const validated = validateConfig(envConfig);
  return mergeWithDefaults(validated);
}

function loadEnvConfig(): RawConfig { ... }
function validateConfig(raw: RawConfig): Config { ... }
function mergeWithDefaults(config: Config): Config { ... }
```

## Валидация

```bash
# Для каждого сервера
npm run lint
npm run typecheck
npm run test
npm run test:smoke
```

- [ ] setupServer ≤ 100 строк в каждом сервере
- [ ] loadConfig ≤ 100 строк
- [ ] Все тесты проходят

## Коммиты (по одному на сервер)

```
refactor(yandex-tracker): extract setupServer helper functions

refactor(ticktick): extract setupServer helper functions

refactor(yandex-wiki): extract setupServer helper functions
```

## Чек-лист завершения

- [ ] yandex-tracker: setupServer ≤ 100, loadConfig ≤ 100
- [ ] ticktick: setupServer ≤ 100, loadConfig ≤ 100
- [ ] yandex-wiki: setupServer ≤ 100
- [ ] Все smoke tests проходят
