# –≠—Ç–∞–ø 1.2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ToolRegistry - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† HIGH
**–¢–∏–ø –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** SEQUENTIAL (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–æ—Å–ª–µ 1.1)
**–û—Ü–µ–Ω–∫–∞:** 5-6 —á–∞—Å–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ —Ä–µ–≤—å—é, –¥–æ–±–∞–≤–ª–µ–Ω ToolErrorHandler)

---

## üéØ –¶–µ–ª—å

–†–∞–∑–¥–µ–ª–∏—Ç—å `ToolRegistry` (314 —Å—Ç—Ä–æ–∫) –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ —Å —á–µ—Ç–∫–∏–º–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—è–º–∏, –≤–∫–ª—é—á–∞—è –æ—Ç–¥–µ–ª—å–Ω—ã–π ToolErrorHandler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–§–∞–π–ª:** `packages/framework/core/src/tool-registry.ts`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- 315 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π (6+):
  1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è tools –∏–∑ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  2. –ü–æ–ª—É—á–µ–Ω–∏–µ tools –ø–æ –∏–º–µ–Ω–∏
  3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tools (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
  4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
  5. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–∂–∏–º—É discovery (lazy/eager)
  6. Fuzzy –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
  7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
- –ù–∞—Ä—É—à–∞–µ—Ç SRP

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
class ToolRegistry {
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  private ensureInitialized(): void
  private registerTool(tool: BaseTool): void
  public registerToolFromContainer(symbolKey: string | symbol): void

  // –ü–æ–ª—É—á–µ–Ω–∏–µ
  getTool(name: string): BaseTool | undefined
  getAllTools(): BaseTool[]
  getDefinitions(): ToolDefinition[]
  getEssentialDefinitions(names: readonly string[]): ToolDefinition[]
  getDefinitionsByMode(mode, names?): ToolDefinition[]

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  private sortByPriority(tools: BaseTool[]): BaseTool[]

  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ + fuzzy –ø–æ–∏—Å–∫
  async execute(name: string, params: ToolCallParams): Promise<ToolResult>
}
```

---

## üèóÔ∏è –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤

```
core/
‚îú‚îÄ‚îÄ tool-registry/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                      # Barrel exports
‚îÇ   ‚îú‚îÄ‚îÄ tool-registry.ts              # –¢–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ (~150 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ tool-invoker.ts               # –í—ã–∑–æ–≤ tools (–±—ã–ª–æ ToolExecutor, ~80 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ tool-error-handler.ts         # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –î–û–ë–ê–í–õ–ï–ù–û (~120 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ tool-priority-sorter.ts       # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (~80 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ tool-discovery-filter.ts      # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è lazy/eager (~60 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ tool-name-matcher.ts          # Fuzzy –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–º–µ–Ω (~40 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ tool-registry.ts (deprecated)     # Re-export –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `ToolExecutor` –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `ToolInvoker` –¥–ª—è –ª—É—á—à–µ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏ (execute —É–∂–µ –µ—Å—Ç—å —É tools).

### –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã

#### 1. ToolRegistry (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)

```typescript
/**
 * –†–µ–µ—Å—Ç—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è tools –∏–∑ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
 * - –¢–û–õ–¨–ö–û –ø–æ–ª—É—á–µ–Ω–∏–µ tools –ø–æ –∏–º–µ–Ω–∏
 * - –¢–û–õ–¨–ö–û —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ tools
 *
 * –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
 * - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tools (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è ToolExecutor)
 * - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫—É (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è ToolPrioritySorter)
 * - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—é (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è ToolDiscoveryFilter)
 */
export class ToolRegistry {
  private tools: Map<string, BaseTool> | null = null;
  private readonly container: Container;
  private readonly logger: Logger;
  private readonly toolClasses: readonly ToolConstructor[];

  constructor(
    container: Container,
    logger: Logger,
    toolClasses: readonly ToolConstructor[]
  ) {
    this.container = container;
    this.logger = logger;
    this.toolClasses = toolClasses;
  }

  // Lazy initialization
  private ensureInitialized(): void { /* ... */ }
  private registerTool(tool: BaseTool): void { /* ... */ }

  // Public API
  registerToolFromContainer(symbolKey: string | symbol): void { /* ... */ }
  getTool(name: string): BaseTool | undefined { /* ... */ }
  getAllTools(): BaseTool[] { /* ... */ }
}
```

#### 2. ToolExecutor (–Ω–æ–≤—ã–π)

```typescript
/**
 * –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tools —á–µ—Ä–µ–∑ ToolRegistry
 * - –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 * - –¢–û–õ–¨–ö–û –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 *
 * –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
 * - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é tools (–¥–µ–ª–∞–µ—Ç—Å—è –≤ ToolRegistry)
 * - Fuzzy –ø–æ–∏—Å–∫ (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è ToolNameMatcher)
 */
export class ToolExecutor {
  constructor(
    private readonly registry: ToolRegistry,
    private readonly nameMatcher: ToolNameMatcher,
    private readonly logger: Logger
  ) {}

  async execute(name: string, params: ToolCallParams): Promise<ToolResult> {
    this.logger.info(`üîç –ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: ${name}`);
    this.logger.debug('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑–æ–≤–∞:', params);

    const tool = this.registry.getTool(name);

    if (!tool) {
      return this.handleToolNotFound(name);
    }

    this.logger.debug(`‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ–º...`, { toolName: name });

    try {
      const result = await tool.execute(params);
      this.logger.info(`‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ${name} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
      return result;
    } catch (error) {
      return this.handleExecutionError(name, error);
    }
  }

  private handleToolNotFound(name: string): ToolResult {
    const allTools = this.registry.getAllTools().map(t => t.getDefinition().name);
    const similarTools = this.nameMatcher.findSimilar(name, allTools);

    this.logger.error(`‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`, {
      requestedTool: name,
      availableTools: allTools,
      totalAvailable: allTools.length,
      similarTools,
    });

    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: false,
          message: `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`,
          availableTools: allTools,
          hint: similarTools.length > 0
            ? `–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: ${similarTools.join(', ')}`
            : '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ search_tools –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',
        }, null, 2),
      }],
      isError: true,
    };
  }

  private handleExecutionError(name: string, error: unknown): ToolResult {
    this.logger.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ${name}:`, error);

    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: false,
          message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
          tool: name,
        }, null, 2),
      }],
      isError: true,
    };
  }
}
```

#### 3. ToolPrioritySorter (–Ω–æ–≤—ã–π)

```typescript
/**
 * –°–æ—Ä—Ç–∏—Ä–æ–≤—â–∏–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ tools –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É + –∞–ª—Ñ–∞–≤–∏—Ç—É
 * - –¢–û–õ–¨–ö–û –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
 */
export class ToolPrioritySorter {
  private readonly priorityOrder: Record<string, number> = {
    critical: 0,
    high: 1,
    normal: 2,
    low: 3,
  };

  constructor(private readonly logger: Logger) {}

  sort(tools: BaseTool[]): BaseTool[] {
    const sorted = tools.sort((a, b) => {
      const aClass = a.constructor as typeof BaseTool;
      const bClass = b.constructor as typeof BaseTool;
      const aPriority = aClass.METADATA?.priority || 'normal';
      const bPriority = bClass.METADATA?.priority || 'normal';

      const aPrio = this.priorityOrder[aPriority] ?? 2;
      const bPrio = this.priorityOrder[bPriority] ?? 2;

      if (aPrio !== bPrio) {
        return aPrio - bPrio;
      }

      return a.getDefinition().name.localeCompare(b.getDefinition().name);
    });

    this.logDistribution(sorted);
    return sorted;
  }

  private logDistribution(tools: BaseTool[]): void {
    this.logger.debug('Tools sorted by priority', {
      critical: this.countByPriority(tools, 'critical'),
      high: this.countByPriority(tools, 'high'),
      normal: this.countByPriority(tools, 'normal'),
      low: this.countByPriority(tools, 'low'),
    });
  }

  private countByPriority(tools: BaseTool[], priority: string): number {
    return tools.filter(t => {
      const tClass = t.constructor as typeof BaseTool;
      const p = tClass.METADATA?.priority || 'normal';
      return p === priority;
    }).length;
  }
}
```

#### 4. ToolDiscoveryFilter (–Ω–æ–≤—ã–π)

```typescript
/**
 * –§–∏–ª—å—Ç—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è lazy/eager discovery
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è tools –ø–æ —Ä–µ–∂–∏–º—É discovery
 * - –¢–û–õ–¨–ö–û –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ ToolDefinition[]
 */
export class ToolDiscoveryFilter {
  constructor(
    private readonly registry: ToolRegistry,
    private readonly sorter: ToolPrioritySorter
  ) {}

  getDefinitionsByMode(
    mode: 'lazy' | 'eager',
    essentialNames?: readonly string[]
  ): ToolDefinition[] {
    if (mode === 'eager') {
      return this.getAllDefinitions();
    }

    const names = essentialNames || ['ping', 'search_tools'];
    return this.getEssentialDefinitions(names);
  }

  getAllDefinitions(): ToolDefinition[] {
    const tools = this.registry.getAllTools();
    const sorted = this.sorter.sort(tools);
    return sorted.map(tool => tool.getDefinition());
  }

  getEssentialDefinitions(names: readonly string[]): ToolDefinition[] {
    const essentialSet = new Set(names);
    const tools = this.registry.getAllTools().filter(tool =>
      essentialSet.has(tool.getDefinition().name)
    );

    const sorted = this.sorter.sort(tools);
    return sorted.map(tool => tool.getDefinition());
  }
}
```

#### 5. ToolErrorHandler (–Ω–æ–≤—ã–π) - –î–û–ë–ê–í–õ–ï–ù–û –≤ —Ä–µ–≤—å—é

```typescript
/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ ToolResult
 * - –¢–û–õ–¨–ö–û —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–Ω—è—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
 * - –¢–û–õ–¨–ö–û —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
 *
 * –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
 * - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tools (–¥–µ–ª–∞–µ—Ç—Å—è –≤ ToolInvoker)
 * - –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö tools (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è ToolNameMatcher)
 */
export class ToolErrorHandler {
  constructor(private readonly logger: Logger) {}

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É "tool –Ω–µ –Ω–∞–π–¥–µ–Ω"
   */
  formatToolNotFound(
    name: string,
    availableTools: string[],
    similarTools: string[]
  ): ToolResult {
    this.logger.error(`‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`, {
      requestedTool: name,
      availableTools,
      totalAvailable: availableTools.length,
      similarTools,
    });

    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: false,
          message: `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`,
          availableTools,
          hint: similarTools.length > 0
            ? `–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: ${similarTools.join(', ')}`
            : '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ search_tools –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',
        }, null, 2),
      }],
      isError: true,
    };
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è tool
   */
  formatExecutionError(name: string, error: unknown): ToolResult {
    this.logger.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ${name}:`, error);

    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: false,
          message: error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
          tool: name,
          errorType: error instanceof Error ? error.constructor.name : typeof error,
        }, null, 2),
      }],
      isError: true,
    };
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (Zod)
   */
  formatValidationError(name: string, validation: ZodError): ToolResult {
    this.logger.error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è ${name}:`, validation.errors);

    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: false,
          message: `–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ "${name}"`,
          tool: name,
          validationErrors: validation.errors.map(err => ({
            path: err.path.join('.'),
            message: err.message,
          })),
        }, null, 2),
      }],
      isError: true,
    };
  }
}
```

#### 6. ToolNameMatcher (–Ω–æ–≤—ã–π)

```typescript
/**
 * Fuzzy –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–º–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
 *
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (SRP):
 * - –¢–û–õ–¨–ö–û –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∏–º–µ–Ω (substring matching)
 * - –¢–û–õ–¨–ö–û –≤–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
 */
export class ToolNameMatcher {
  /**
   * –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –∏–º–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
   *
   * @param searchName - –∏—Å–∫–æ–º–æ–µ –∏–º—è
   * @param availableNames - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–º–µ–Ω–∞
   * @returns –º–∞—Å—Å–∏–≤ –ø–æ—Ö–æ–∂–∏—Ö –∏–º–µ–Ω
   */
  findSimilar(searchName: string, availableNames: string[]): string[] {
    return availableNames.filter(name =>
      name.includes(searchName) || searchName.includes(name)
    );
  }
}
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (30 –º–∏–Ω—É—Ç)

- [ ] –°–æ–∑–¥–∞—Ç—å snapshot tests —Ç–µ–∫—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ ToolRegistry
- [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π `core/tool-registry/`
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤ (2 —á–∞—Å–∞)

- [ ] **ToolNameMatcher** - fuzzy –ø–æ–∏—Å–∫
  - [ ] –°–æ–∑–¥–∞—Ç—å `tool-name-matcher.ts`
  - [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥ `findSimilar()`
  - [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã
  - [ ] –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~30 —Å—Ç—Ä–æ–∫

- [ ] **ToolPrioritySorter** - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
  - [ ] –°–æ–∑–¥–∞—Ç—å `tool-priority-sorter.ts`
  - [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥ `sortByPriority()` –∏ `logDistribution()`
  - [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã
  - [ ] –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~80 —Å—Ç—Ä–æ–∫

- [ ] **ToolDiscoveryFilter** - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è lazy/eager
  - [ ] –°–æ–∑–¥–∞—Ç—å `tool-discovery-filter.ts`
  - [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥—ã `getDefinitionsByMode()`, `getAllDefinitions()`, `getEssentialDefinitions()`
  - [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã
  - [ ] –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~60 —Å—Ç—Ä–æ–∫

- [ ] **ToolExecutor** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tools
  - [ ] –°–æ–∑–¥–∞—Ç—å `tool-executor.ts`
  - [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥ `execute()` –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
  - [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã
  - [ ] –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~120 —Å—Ç—Ä–æ–∫

### –£–ø—Ä–æ—â–µ–Ω–∏–µ ToolRegistry (1 —á–∞—Å)

- [ ] –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏–∑ `ToolRegistry`
- [ ] –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ tools
- [ ] –û–±–Ω–æ–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã
- [ ] –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~150 —Å—Ç—Ä–æ–∫ (–≤–º–µ—Å—Ç–æ 315)

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (30 –º–∏–Ω—É—Ç)

- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –≤ `container.ts`:
  - `ToolNameMatcher`
  - `ToolPrioritySorter`
  - `ToolDiscoveryFilter`
  - `ToolExecutor`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `TYPES` —Å–∏–º–≤–æ–ª—ã
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (1 —á–∞—Å)

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `index.ts` –≤ yandex-tracker (MCP server entry point)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å:
  - `toolRegistry.execute()` ‚Üí `toolExecutor.execute()`
  - `toolRegistry.getDefinitions()` ‚Üí `discoveryFilter.getAllDefinitions()`
  - `toolRegistry.getDefinitionsByMode()` ‚Üí `discoveryFilter.getDefinitionsByMode()`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

### –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è (30 –º–∏–Ω—É—Ç)

- [ ] –°–æ–∑–¥–∞—Ç—å barrel exports `core/tool-registry/index.ts`
- [ ] –°–æ–∑–¥–∞—Ç—å deprecated re-export –≤ `core/tool-registry.ts` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤: `npm run validate`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md

---

## üîß –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

```typescript
// index.ts (MCP server)
const toolRegistry = container.get<ToolRegistry>(TYPES.ToolRegistry);

server.setRequestHandler(ListToolsRequestSchema, async () => ({
  tools: toolRegistry.getDefinitions(),
}));

server.setRequestHandler(CallToolRequestSchema, async (request) =>
  toolRegistry.execute(request.params.name, request.params.arguments ?? {})
);
```

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

```typescript
// index.ts (MCP server)
const discoveryFilter = container.get<ToolDiscoveryFilter>(TYPES.ToolDiscoveryFilter);
const toolExecutor = container.get<ToolExecutor>(TYPES.ToolExecutor);

server.setRequestHandler(ListToolsRequestSchema, async () => ({
  tools: discoveryFilter.getAllDefinitions(),
}));

server.setRequestHandler(CallToolRequestSchema, async (request) =>
  toolExecutor.execute(request.params.name, request.params.arguments ?? {})
);
```

---

## üìê –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –î–æ
- ToolRegistry: 315 —Å—Ç—Ä–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π: 6+
- SRP –Ω–∞—Ä—É—à–µ–Ω–∏—è: 1

### –ü–æ—Å–ª–µ
- ToolRegistry: ~150 —Å—Ç—Ä–æ–∫ (—Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
- ToolExecutor: ~120 —Å—Ç—Ä–æ–∫
- ToolPrioritySorter: ~80 —Å—Ç—Ä–æ–∫
- ToolDiscoveryFilter: ~60 —Å—Ç—Ä–æ–∫
- ToolNameMatcher: ~30 —Å—Ç—Ä–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π –Ω–∞ –∫–ª–∞—Å—Å: 1-2
- SRP –Ω–∞—Ä—É—à–µ–Ω–∏—è: 0

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã —á–µ—Ä–µ–∑ barrel exports
   - –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å adapter –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ API –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

2. **DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**
   - –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —è–≤–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω—ã –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞—Ö

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - Snapshot tests —Ç–µ–∫—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
   - Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞
   - Integration tests MCP server

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ (JSDoc)
   - –û–±–Ω–æ–≤–∏—Ç—å README.md —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å **1.3** –∏ **1.4** –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–≤ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö).
