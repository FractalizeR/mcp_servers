name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  id-token: write

jobs:
  # Job 1: Run semantic-release to determine version and create release
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run full validation
        run: npm run validate
        env:
          CI: true

      - name: Run smoke tests
        run: npm run test:smoke

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Publish to NPM using OIDC Trusted Publishing (no NPM_TOKEN needed!)
  publish-npm:
    name: Publish to NPM Registry (Trusted Publishing)
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'
    # Environment must be configured in GitHub repo settings
    # and match the trusted publisher config on npmjs.com
    environment: npm-publish

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node.js with NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      # OIDC Trusted Publishing: npm CLI automatically uses id-token for auth
      # No NPM_TOKEN needed! Provenance is published automatically.
      # Packages are published in dependency order to avoid resolution issues
      - name: Publish packages to NPM (OIDC Trusted Publishing)
        run: |
          echo "üì¶ Publishing packages with OIDC Trusted Publishing..."
          echo "üîê Using GitHub OIDC for authentication (no NPM_TOKEN required)"

          # Framework packages (in dependency order)
          echo ""
          echo "1/7 Publishing @fractalizer/mcp-infrastructure..."
          npm publish --workspace=@fractalizer/mcp-infrastructure --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "2/7 Publishing @fractalizer/mcp-cli..."
          npm publish --workspace=@fractalizer/mcp-cli --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "3/7 Publishing @fractalizer/mcp-core..."
          npm publish --workspace=@fractalizer/mcp-core --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "4/7 Publishing @fractalizer/mcp-search..."
          npm publish --workspace=@fractalizer/mcp-search --access public || echo "‚ö†Ô∏è May already be published"

          # Server packages
          echo ""
          echo "5/7 Publishing @fractalizer/mcp-server-yandex-tracker..."
          npm publish --workspace=@fractalizer/mcp-server-yandex-tracker --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "6/7 Publishing @fractalizer/mcp-server-yandex-wiki..."
          npm publish --workspace=@fractalizer/mcp-server-yandex-wiki --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "7/7 Publishing @fractalizer/mcp-server-ticktick..."
          npm publish --workspace=@fractalizer/mcp-server-ticktick --access public || echo "‚ö†Ô∏è May already be published"

          echo ""
          echo "‚úÖ All packages processed!"

  # Job 3: Build MCPB bundles for all servers and attach to GitHub release
  build-mcpb:
    name: Build MCPB Bundles
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all MCPB bundles
        run: |
          echo "üì¶ Building MCPB bundles for all servers..."

          # Build each server's MCPB
          npm run build:mcpb --workspace=@fractalizer/mcp-server-yandex-tracker || echo "‚ö†Ô∏è yandex-tracker MCPB failed"
          npm run build:mcpb --workspace=@fractalizer/mcp-server-yandex-wiki || echo "‚ö†Ô∏è yandex-wiki MCPB failed"
          npm run build:mcpb --workspace=@fractalizer/mcp-server-ticktick || echo "‚ö†Ô∏è ticktick MCPB failed"

      - name: Rename and upload MCPB files
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          UPLOAD_FILES=""

          # Yandex Tracker
          YT_FILE=$(ls fractalizer_mcp_yandex_tracker-*.mcpb 2>/dev/null | head -n 1)
          if [ -n "$YT_FILE" ]; then
            mv "$YT_FILE" "mcp-server-yandex-tracker.mcpb"
            UPLOAD_FILES="$UPLOAD_FILES mcp-server-yandex-tracker.mcpb"
            echo "‚úÖ yandex-tracker MCPB ready"
          fi

          # Yandex Wiki
          YW_FILE=$(ls fractalizer_mcp_yandex_wiki-*.mcpb 2>/dev/null | head -n 1)
          if [ -n "$YW_FILE" ]; then
            mv "$YW_FILE" "mcp-server-yandex-wiki.mcpb"
            UPLOAD_FILES="$UPLOAD_FILES mcp-server-yandex-wiki.mcpb"
            echo "‚úÖ yandex-wiki MCPB ready"
          fi

          # TickTick
          TT_FILE=$(ls fractalizer_mcp_ticktick-*.mcpb 2>/dev/null | head -n 1)
          if [ -n "$TT_FILE" ]; then
            mv "$TT_FILE" "mcp-server-ticktick.mcpb"
            UPLOAD_FILES="$UPLOAD_FILES mcp-server-ticktick.mcpb"
            echo "‚úÖ ticktick MCPB ready"
          fi

          if [ -z "$UPLOAD_FILES" ]; then
            echo "‚ö†Ô∏è No MCPB files found, skipping upload"
            exit 0
          fi

          echo ""
          echo "üì§ Uploading to release v${VERSION}..."

          # Upload all MCPB files to GitHub release
          gh release upload "v${VERSION}" $UPLOAD_FILES --clobber

          echo "‚úÖ All MCPB bundles uploaded!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Notify success
  notify-success:
    name: Notify Release Success
    needs: [release, publish-npm, build-mcpb]
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'

    steps:
      - name: Success message
        run: |
          echo "üéâ Release ${{ needs.release.outputs.new_release_version }} completed successfully!"
          echo "‚úÖ Semantic Release: version determined and tagged"
          echo "‚úÖ NPM packages published with OIDC Trusted Publishing"
          echo "‚úÖ Provenance attestations generated automatically"
          echo "‚úÖ MCPB bundle attached to release"
