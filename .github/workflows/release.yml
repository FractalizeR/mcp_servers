name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  id-token: write

jobs:
  # Job 1: Run semantic-release to determine version and create release
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run full validation
        run: npm run validate
        env:
          CI: true

      - name: Run smoke tests
        run: npm run test:smoke

      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release

  # Job 2: Publish to NPM (runs after semantic-release creates a new version)
  publish-npm:
    name: Publish to NPM Registry
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Publish all packages to NPM
        run: npm publish --workspaces --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Job 3: Build MCPB bundle and attach to GitHub release
  build-mcpb:
    name: Build MCPB Bundle
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build MCPB bundle
        run: npm run build:mcpb

      - name: Find and upload MCPB file
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          MCPB_FILE=$(ls fractalizer_mcp_yandex_tracker-*.mcpb 2>/dev/null | head -n 1)

          if [ -z "$MCPB_FILE" ]; then
            echo "‚ö†Ô∏è MCPB file not found, skipping upload"
            exit 0
          fi

          echo "Found MCPB file: $MCPB_FILE"

          # Upload to existing GitHub release
          gh release upload "v${VERSION}" "$MCPB_FILE" \
            packages/servers/yandex-tracker/dist/yandex-tracker.bundle.cjs \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Notify success
  notify-success:
    name: Notify Release Success
    needs: [release, publish-npm, build-mcpb]
    runs-on: ubuntu-latest
    if: needs.release.outputs.new_release_published == 'true'

    steps:
      - name: Success message
        run: |
          echo "üéâ Release ${{ needs.release.outputs.new_release_version }} completed successfully!"
          echo "‚úÖ Semantic Release: version determined and tagged"
          echo "‚úÖ NPM packages published"
          echo "‚úÖ MCPB bundle attached to release"
