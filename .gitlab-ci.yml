# GitLab CI/CD –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ NPM –ø–∞–∫–µ—Ç–æ–≤
# –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞ v* –∏ –µ—Å–ª–∏ NPM_TOKEN –Ω–∞—Å—Ç—Ä–æ–µ–Ω

stages:
  - validate
  - publish

variables:
  NODE_VERSION: "22"

# –û–±—â–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è Node.js jobs
.node_template: &node_template
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .turbo/

# =============================================================================
# –í–ê–õ–ò–î–ê–¶–ò–Ø (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –≤–µ—Ç–∫–∞—Ö –∏ —Ç–µ–≥–∞—Ö)
# =============================================================================

validate:
  <<: *node_template
  stage: validate
  script:
    - npm ci
    - npm run build
    - npm run lint:quiet
    - npm run typecheck
    - npm run test:quiet
    - npm run test:smoke
  rules:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Ç–µ–≥–∞—Ö
    - if: $CI_COMMIT_TAG =~ /^v.*/
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –í NPM (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞ v*)
# =============================================================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
verify-version:
  <<: *node_template
  stage: publish
  script:
    - |
      # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ç–µ–≥–∞ (—É–±–∏—Ä–∞–µ–º 'v' –≤ –Ω–∞—á–∞–ª–µ)
      TAG_VERSION="${CI_COMMIT_TAG#v}"
      echo "üìã Tag version: $TAG_VERSION"

      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –≤ yandex-tracker
      PKG_VERSION=$(node -p "require('./packages/servers/yandex-tracker/package.json').version")
      echo "üì¶ Package version: $PKG_VERSION"

      if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
        echo "‚ùå Error: Tag version ($TAG_VERSION) doesn't match package.json version ($PKG_VERSION)"
        exit 1
      fi
      echo "‚úÖ Version verified: $PKG_VERSION"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/

# –ü—É–±–ª–∏–∫–∞—Ü–∏—è yandex-tracker –≤ NPM
publish-yandex-tracker:
  <<: *node_template
  stage: publish
  needs:
    - validate
    - verify-version
  script:
    - npm ci
    - npm run build

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .npmrc –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    - |
      if [ -z "$NPM_TOKEN" ]; then
        echo "‚ö†Ô∏è  NPM_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é"
        echo "–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: Settings ‚Üí CI/CD ‚Üí Variables ‚Üí Add NPM_TOKEN"
        exit 0
      fi

    - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > ~/.npmrc

    # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞
    - cd packages/servers/yandex-tracker
    - npm publish --access public
    - echo "‚úÖ @mcp-server/yandex-tracker –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
  environment:
    name: npm-registry
    url: https://www.npmjs.com/package/@mcp-server/yandex-tracker

# –ü—É–±–ª–∏–∫–∞—Ü–∏—è framework –ø–∞–∫–µ—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
# publish-framework:
#   <<: *node_template
#   stage: publish
#   needs:
#     - validate
#     - verify-version
#   script:
#     - npm ci
#     - npm run build
#
#     - |
#       if [ -z "$NPM_TOKEN" ]; then
#         echo "‚ö†Ô∏è  NPM_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é"
#         exit 0
#       fi
#
#     - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > ~/.npmrc
#
#     # –ü—É–±–ª–∏–∫–∞—Ü–∏—è framework –ø–∞–∫–µ—Ç–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
#     - cd packages/framework/infrastructure && npm publish --access public
#     - cd ../cli && npm publish --access public
#     - cd ../core && npm publish --access public
#     - cd ../search && npm publish --access public
#     - echo "‚úÖ Framework –ø–∞–∫–µ—Ç—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã!"
#   rules:
#     - if: $CI_COMMIT_TAG =~ /^v.*/

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –†–ï–õ–ò–ó–ê (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# =============================================================================

# –°–±–æ—Ä–∫–∞ MCPB –±–∞–Ω–¥–ª–∞ –¥–ª—è —Ä–µ–ª–∏–∑–∞
build-mcpb:
  <<: *node_template
  stage: publish
  needs:
    - validate
    - verify-version
  script:
    - npm ci
    - npm run build:mcpb
  artifacts:
    paths:
      - "*.mcpb"
      - packages/servers/yandex-tracker/dist/yandex-tracker.bundle.cjs
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
