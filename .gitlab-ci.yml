# GitLab CI/CD –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ NPM –ø–∞–∫–µ—Ç–æ–≤
# –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞ v* –∏ –µ—Å–ª–∏ NPM_TOKEN –Ω–∞—Å—Ç—Ä–æ–µ–Ω
#
# –°–µ–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è:
# - –ö–∞–∂–¥—ã–π –ø–∞–∫–µ—Ç –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –≤–µ—Ä—Å–∏—è –µ—â—ë –Ω–µ –≤ registry
# - –ò—Å–ø–æ–ª—å–∑—É–π Changesets –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏: npx changeset
#
# –ü–æ—Ä—è–¥–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–ø–æ –≥—Ä–∞—Ñ—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π):
# infrastructure ‚Üí cli ‚Üí core ‚Üí search ‚Üí yandex-tracker, yandex-wiki

stages:
  - validate
  - publish

variables:
  NODE_VERSION: "22"

# –û–±—â–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è Node.js jobs
.node_template: &node_template
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .turbo/

# =============================================================================
# –í–ê–õ–ò–î–ê–¶–ò–Ø (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –≤–µ—Ç–∫–∞—Ö –∏ —Ç–µ–≥–∞—Ö)
# =============================================================================

validate:
  <<: *node_template
  stage: validate
  script:
    - npm ci

    # –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Turborepo (build ‚Üí lint ‚Üí typecheck ‚Üí test)
    - npm run build
    - npm run lint:quiet
    - npm run typecheck
    - npm run test:quiet

    # Smoke tests –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤
    - npm run test:smoke

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
    - npm run cpd:quiet
  rules:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Ç–µ–≥–∞—Ö
    - if: $CI_COMMIT_TAG =~ /^v.*/
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –í NPM (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞ v*)
# =============================================================================

publish-packages:
  <<: *node_template
  stage: publish
  needs:
    - validate
  script:
    - npm ci
    - npm run build

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ NPM_TOKEN
    - |
      if [ -z "$NPM_TOKEN" ]; then
        echo "‚ö†Ô∏è  NPM_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é"
        echo ""
        echo "–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
        echo "  1. –°–æ–∑–¥–∞–π —Ç–æ–∫–µ–Ω –Ω–∞ https://www.npmjs.com/settings/tokens"
        echo "  2. GitLab: Settings ‚Üí CI/CD ‚Üí Variables ‚Üí Add NPM_TOKEN"
        exit 0
      fi

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .npmrc –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > ~/.npmrc

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞)
    - |
      publish_if_needed() {
        local pkg_path="$1"
        local pkg_name=$(node -p "require('./${pkg_path}/package.json').name")
        local pkg_version=$(node -p "require('./${pkg_path}/package.json').version")

        echo ""
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è—é ${pkg_name}@${pkg_version}..."

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –≤–µ—Ä—Å–∏—è
        if npm view "${pkg_name}@${pkg_version}" version 2>/dev/null; then
          echo "  ‚è≠Ô∏è  –í–µ—Ä—Å–∏—è ${pkg_version} —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é"
          return 0
        fi

        echo "  üì§ –ü—É–±–ª–∏–∫—É—é ${pkg_name}@${pkg_version}..."
        cd "${pkg_path}"
        if npm publish --access public; then
          echo "  ‚úÖ ${pkg_name}@${pkg_version} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
        else
          echo "  ‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ ${pkg_name}"
          return 1
        fi
        cd - > /dev/null
      }

    # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é –ø–∞–∫–µ—Ç–æ–≤..."
    - echo ""

    # 1. Infrastructure (–±–∞–∑–∞, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
    - publish_if_needed "packages/framework/infrastructure"

    # 2. CLI (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç infrastructure)
    - publish_if_needed "packages/framework/cli"

    # 3. Core (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç infrastructure)
    - publish_if_needed "packages/framework/core"

    # 4. Search (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç core)
    - publish_if_needed "packages/framework/search"

    # 5. –°–µ—Ä–≤–µ—Ä—ã (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—Å–µ—Ö framework –ø–∞–∫–µ—Ç–æ–≤)
    - publish_if_needed "packages/servers/yandex-tracker"
    - publish_if_needed "packages/servers/yandex-wiki"

    - echo ""
    - echo "üéâ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
  environment:
    name: npm-registry
    url: https://www.npmjs.com/org/mcp-framework

# =============================================================================
# –°–ë–û–†–ö–ê –ê–†–¢–ï–§–ê–ö–¢–û–í (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞ v*)
# =============================================================================

build-mcpb:
  <<: *node_template
  stage: publish
  needs:
    - validate
  script:
    - npm ci
    - npm run build:mcpb
  artifacts:
    paths:
      - "*.mcpb"
      - packages/servers/yandex-tracker/dist/yandex-tracker.bundle.cjs
      - packages/servers/yandex-wiki/dist/yandex-wiki.bundle.cjs
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
